import{aG as F,b as w,b1 as oe,aL as H,b7 as ie,b8 as be,j as n,az as X,b9 as ye,r as c,aW as xe,aX as P,ag as U,ba as ve,a3 as Q,aS as Ce,W as le,P as re,u as N,bb as Ie,bc as Se,bd as we,be as ce,bf as je,B as ue,at as J,ay as De,bg as Ee,bh as Ve,aE as fe,ah as Me,av as z,au as Oe,bi as G,t as Z,bj as Ae,bk as de,bl as ke,bm as Te,f as he,a_ as A,aB as Pe,s as pe,bn as Re,aD as Be,bo as Le,bp as He,bq as q,aF as $e,aJ as ze,br as Fe,bs as Ne,bt as Ge,bu as Ue,bv as We,bw as _e,aN as Ke,aO as Ye,bx as Je,by as qe,a$ as ee,aA as Xe,S as Qe,bz as Ze}from"./mergeIfcEntities-d775b9f7.js";const et={test:"https://test.bsdd.buildingsmart.org",production:"https://test.bsdd.buildingsmart.org"},tt="production";function nt({callback:t,ifcEntity:e}){const{t:a}=F();w(oe);const o=H(ie),i=H(be);function l(m){const u=m?{...JSON.parse(JSON.stringify(m))}:{hasAssociations:[],isDefinedBy:[]};return u.isDefinedBy=o?.filter(d=>d.name!=="Attributes"),u.hasAssociations=[],i?.forEach(d=>{if(d.type==="IfcClassificationReference"&&d?.referencedSource?.location?.includes("https://identifier.buildingsmart.org/uri/buildingsmart/ifc/")){const{type:v,predefinedType:y}=ye(d.identification);v&&(u.type=v),y&&(u.predefinedType=y),u.predefinedType||(u.predefinedType="NOTDEFINED")}else u.hasAssociations?.push(d)}),u}const s=()=>{const m=l(e);console.log(m),t(m)};return n.jsx(X,{color:"gray",fullWidth:!0,onClick:s,variant:"filled",children:a("apply")})}const te=25,st=25;function ne({height:t,options:e,label:a,value:o,setValue:i,placeholder:l="Search values",disabled:s}){const[m,u]=c.useState(""),[d,v]=c.useState(e.slice(0,te)),y=c.useRef(null),r=xe({onDropdownClose:()=>{r.resetSelectedOption(),r.focusTarget&&r.focusTarget()},onDropdownOpen:()=>{r.focusSearchInput&&r.focusSearchInput()}});c.useEffect(()=>{u(o?.label||"")},[o]),c.useEffect(()=>{const h=o===null?e.filter(p=>p?.label.toLowerCase().includes(m.toLowerCase().trim())||p?.value.toString().toLowerCase().includes(m.toLowerCase().trim())):e;v(h.slice(0,te))},[e,m,o]);const x=h=>{const{scrollTop:p,scrollHeight:I,clientHeight:C}=h.currentTarget,S=5;I-p<=C+S&&v(O=>{const M=O.length,b=e.filter(g=>g?.label.toLowerCase().includes(m.toLowerCase().trim())).slice(M,M+st);return[...O,...b]})},f=d.map(h=>n.jsx(P.Option,{value:h.value,active:o?.value===h.value,children:n.jsxs(U,{gap:"sm",children:[o?.value===h.value?n.jsx(ve,{size:12}):null,n.jsx(Q,{fz:"sm",opacity:s?.6:1,children:h.label}),n.jsxs(Q,{fz:"xs",opacity:.6,children:["(",h.value,")"]})]})},h.value));return n.jsx("div",{style:{display:"flex",flexDirection:"column",height:"100%"},children:n.jsxs(P,{store:r,onOptionSubmit:h=>{if(!s){const p=e.find(C=>C.value===h),I=p&&o?.value!==p.value?p:null;i(I),r.closeDropdown()}},disabled:s,children:[n.jsx(P.Target,{children:n.jsx(Ce,{rightSection:!s&&n.jsx(le,{size:"sm",onMouseDown:h=>{h.preventDefault()},onClick:()=>{u(""),i(null)},"aria-label":"Clear value"}),label:a,value:o?`${o.label} (${o.value})`:m,onChange:h=>{s||(i(null),r.updateSelectedOptionIndex(),u(h.currentTarget.value))},onClick:()=>{s||r.openDropdown()},onBlur:()=>r.closeDropdown(),placeholder:s?"":l,disabled:s})}),t<80?n.jsx(P.Dropdown,{style:{maxHeight:"20em",overflowY:"auto"},ref:y,onScroll:x,children:n.jsx(P.Options,{children:f.length>0?f:n.jsx(P.Empty,{children:"Nothing found..."})})}):n.jsx(re,{withBorder:!0,my:"0.2em",style:{flexGrow:1,overflow:"auto",backgroundColor:s?"var(--mantine-color-gray-0)":"transparent",color:s?"var(--mantine-color-gray-6)":"inherit",pointerEvents:s?"none":"auto"},ref:y,onScroll:x,children:n.jsx(P.Options,{children:f.length>0?f:n.jsx(P.Empty,{children:"Nothing found..."})})})]})})}function at({height:t,handleMouseDown:e}){const a=N(),{t:o}=F(),[i,l]=c.useState(new Map),[s,m]=c.useState(new Map),u=w(Ie),d=w(Se),v=H(oe),y=H(we),r=H(ce),x=H(je);return c.useEffect(()=>{(async()=>{const p=Array.from(u.entries()).map(async([V,O])=>{if(r&&V===x){const{code:D,name:T,uri:B}=r;return[V,[{value:D,label:T,uri:B}]]}let M=[];const b=y[V],g=r?.classRelations?.map(D=>D.relatedClassUri),j=b?.filter(D=>g?.includes(D.uri));if(j&&j.length>0)M=j.map(D=>({value:D.code,label:D.name,uri:D.uri}));else try{M=(await a(Ee(V)).unwrap())?.map(T=>({value:T.code,label:T.name||"",uri:T.uri}))??[]}catch(D){console.error("Failed to fetch dictionary classes for",V,D),M=[]}return[V,M]}),I=await Promise.all(p),C=new Map(I);l(C);const S=new Map;C.forEach((V,O)=>{if(V.length===1)S.set(O,V[0]);else if(O in d){const M=d[O];if(M.length===1){const b=M[0];if(V.some(j=>j.value===b.identification)){const j={label:b.name||"",value:b.identification||"",uri:b.location||""};S.set(O,j)}}}}),m(S)})()},[u,y,a,d,r,x]),c.useEffect(()=>{(()=>{const h=Array.from(s.entries()).map(([p,I])=>{if(!I||!I.value)return null;const C=v[p];return{type:"IfcClassificationReference",name:I.label,location:I.uri,identification:I.value,referencedSource:{type:"IfcClassification",name:C.name,location:C.uri,edition:C.version,editionDate:C.releaseDate}}}).filter(p=>p!==null);h.length>0&&a(Ve(h))})()},[v,a,s]),n.jsxs(re,{style:{height:`${t}px`,position:"relative"},children:[Array.from(u.entries()).map(([f,h])=>{const p=f===x,I=f===r?.dictionaryUri;return p?n.jsx(ne,{height:t,label:h.name,options:i.get(f)||[],value:s.get(f)||null,setValue:C=>{const S=new Map(s);S.set(f,C),m(S)},placeholder:o("classifications.searchClassesPlaceholder"),disabled:i.get(f)?.length===1},f):I?null:n.jsx(ne,{height:t,label:h.name,options:i.get(f)||[],value:s.get(f)||null,setValue:C=>{const S=new Map(s);S.set(f,C),m(S)},placeholder:o("classifications.searchClassesPlaceholder"),disabled:i.get(f)?.length===1},f)}),n.jsx(ue,{onMouseDown:e,style:{marginTop:"4px"},children:n.jsx(J,{label:o("classifications.dragResize"),withArrow:!0,children:n.jsx(X,{fullWidth:!0,variant:"subtle",size:"sm",color:"gray","aria-label":o("classifications.dragResize"),children:n.jsx(De,{})})})})]})}function _(t,e){return t==null||e==null?null:t.toLowerCase()!==e.toLowerCase()?`(${e})`:null}function ot({label:t,description:e,value:a,setValue:o,disabled:i,inputContainer:l}){const{t:s}=F(),[m,u]=c.useState(!1),[d,v]=c.useState(!0),y=()=>s(d?"checkbox.indeterminate":m?"checkbox.true":"checkbox.false"),r=f=>{f.target.indeterminate=!1,o(f.target.checked)};c.useEffect(()=>{a===!0?(u(!0),v(!1)):a===!1?(u(!1),v(!1)):a===void 0&&(u(!1),v(!0))},[a]);const x=n.jsx(fe,{description:y(),checked:m,indeterminate:d,type:"checkbox",onChange:f=>r(f),disabled:i});return n.jsx(Me.Wrapper,{label:t,description:e,children:l?l(x):x})}const K=(t,e,a,o)=>t.map(i=>{if(i.name===e){const l=i.hasProperties.map(s=>s.name===a?{...s,...o}:s);return{...i,hasProperties:l}}return i}),it=(t,e,a)=>{const o=`${e}/${a}`;return t.hasOwnProperty(o)?t[o]:t[a]||!1};function lt({propertySet:t,property:e,propertyNaturalLanguageName:a}){const o=N(),i=w(ie),l=w(f=>f.ifcData.propertyIsInstanceMap),s=w(f=>f.ifcData.savedPropertyIsInstanceMap),[m,u]=c.useState(),d=t.name!=="Attributes",v=`${t.name}/${e.name}`,y=s.hasOwnProperty(v)||s.hasOwnProperty(e.name),r=it(l,t.name||"",e.name),x=f=>d&&r?n.jsx(J,{label:Z("bsddSearch.property.tooltipEditInstance"),withArrow:!0,children:f}):f;return c.useEffect(()=>{switch(e.type){case"IfcPropertySingleValue":{e.nominalValue.type==="IfcBoolean"?u(n.jsx(ot,{label:a,description:_(a,e.name),disabled:r,inputContainer:x,value:e.nominalValue.value,setValue:f=>{if(i&&t.name){const h={nominalValue:{...e.nominalValue,value:f}},p=K(i,t.name,e.name,h);o(G(Object.values(p)))}}})):u(n.jsx(z,{label:a,description:_(a,e.name),placeholder:e.nominalValue.value,value:e.nominalValue.value||"",disabled:r,inputContainer:x,onChange:f=>{if(i&&t.name){const h={nominalValue:{...e.nominalValue,value:f.target.value}},p=K(i,t.name,e.name,h);o(G(Object.values(p)))}}}));break}case"IfcPropertyEnumeratedValue":{const f=e.enumerationValues?.[0]?.value,h=e.enumerationReference?.enumerationValues||[];u(n.jsx(Oe,{label:a,description:_(a,e.name),value:f,inputContainer:x,disabled:r||e.enumerationReference?.enumerationValues?.length===1,onChange:p=>{if(i&&t.name){const I=h.find(V=>V.value===p),C={enumerationValues:I?[I]:[]},S=K(i,t.name,e.name,C);o(G(Object.values(S)))}},data:h.map(p=>({value:p.value,label:p.value}))}));break}default:{u(n.jsx(z,{placeholder:e.name,value:"{ifcProperty.nominalValue}",disabled:r,inputContainer:x}));break}}},[e,t,u,a,o,i,r]),n.jsxs(U,{children:[n.jsx("div",{style:{flex:1},children:m}),d&&n.jsx(J,{label:Z("bsddSearch.property.setAsInstanceCheckboxTooltip"),withArrow:!0,children:n.jsx(fe,{style:{marginTop:"2rem"},disabled:y,checked:r,onChange:f=>{y||o(Ae({propertyName:v,value:f.currentTarget.checked}))}})})]})}const rt={Boolean:"IfcBoolean",Character:"IfcText",Integer:"IfcInteger",Real:"IfcReal",String:"IfcText",Time:"IfcDateTime"};function W(t,e){const a=t&&rt[t]||"default";let o;return t==="Boolean"&&typeof e=="string"?e.toUpperCase()==="TRUE"?o=!0:e.toUpperCase()==="FALSE"?o=!1:o=void 0:o=e,{type:a,value:o}}function me(t,e,a){let o;if(t&&t.isDefinedBy){let i=t.isDefinedBy.find(l=>l.name===e);if(i&&(o=i.hasProperties.find(l=>l.name===a)),o)return o;if(i=t.isDefinedBy.find(l=>l.name===""),i)return i.hasProperties.find(l=>l.name===a)}return o}function ct(t,e,a,o){const l=me(e,a,o)?.nominalValue?.value??null;return W(t,l)}function ut(t,e,a,o,i){const l=me(e,a,o);if(l){if(l.type==="IfcPropertyEnumeratedValue")return i.filter(s=>l.enumerationValues?l.enumerationValues.some(m=>m.value===s.value):!1);if("nominalValue"in l&&l.nominalValue){const s=i.find(m=>m.value===l.nominalValue.value);return s?[s]:[]}}return[]}function ft(t,e,a,o){const i=t.allowedValues?.map(m=>W(t.dataType,m.value))||[],l={type:"IfcPropertyEnumeratedValue",name:e,enumerationReference:{type:"IfcPropertyEnumeration",name:e,enumerationValues:i},enumerationValues:i};t.propertyUri&&(l.specification=t.propertyUri);const s=t.predefinedValue?[W(t.dataType,t.predefinedValue)]:ut(t.dataType,o,a,e,i);return s.length>0&&(l.enumerationValues=s),l}function dt(t,e,a,o){const i={type:"IfcPropertySingleValue",name:e,specification:t.propertyUri||""},l=t.predefinedValue?W(t.dataType,t.predefinedValue):ct(t.dataType,o,a,e);return l!==null&&(i.nominalValue=l),i}function ht(t,e,a){const{propertyCode:o}=t,i=o||"unknown",l=t.allowedValues?ft(t,i,e,a):dt(t,i,e,a);return l.specification=t.propertyUri||"",l}function pt({mainDictionaryClassification:t,recursiveMode:e}){const a=N(),o=w(de),i=w(ke),l=w(Te),s=w(he),[m,u]=c.useState({});return console.log("PropertySets.tsx:",i),c.useEffect(()=>{if(!t)return;const d={};[t].forEach(y=>{y.classProperties?.forEach(r=>{if(!r||!r.propertySet)return;const x=r.propertySet||y.name;d[x]||(d[x]={type:"IfcPropertySet",name:x,hasProperties:[]}),d[x].hasProperties.push(ht(r,x,o))})}),a(G(Object.values(d)))},[a,o,t]),c.useEffect(()=>{if(!t)return;const d={};[t].forEach(y=>{y.classProperties?.forEach(r=>{r&&r.propertyUri&&(s&&l&&l[s]&&l[s][r.propertyUri]?d[r.propertyUri]=l[s][r.propertyUri]||"":d[r.propertyUri]=r.name)})}),u(d)},[t,e,o,l,s]),n.jsx("div",{children:c.Children.toArray(i?.map((d,v)=>n.jsx(A,{variant:"contained",radius:"xs",children:n.jsxs(A.Item,{value:d.name||"Unknown",style:v!==0?{borderTopWidth:0}:{},children:[n.jsx(A.Control,{children:d.name}),n.jsx(A.Panel,{children:n.jsx(Pe,{children:c.Children.toArray(d.hasProperties.map(y=>{const r=y.specification?m[y.specification]:"";return n.jsx(lt,{propertySet:d,property:y,propertyNaturalLanguageName:r})}))})})]},d.name||"Unknown")})))})}function mt({api:t,defaultSelection:e}){const a=N(),{t:o}=F(),i=w(pe),l=w(Re),[s,m]=c.useState([]),u=c.useRef(null),[d,v]=c.useState(void 0),[y,r]=c.useState(""),[x]=Be(y,300),[f,h]=c.useState(!1),[p,I]=c.useState(-1);c.useEffect(()=>{e&&!f&&s.length>0&&(s.find(g=>g.value===e.value)?(v(e),r(e.label),u.current&&u.current.blur()):(r(e.label),u.current&&(u.current.focus(),u.current.setSelectionRange(0,u.current.value.length))),h(!0))},[e,f,s]);const C=c.useCallback(b=>{r(b),I(-1);const g=s.filter(j=>j.label.toLowerCase().includes(b.toLowerCase().trim())||j.synonyms?.some(D=>D.toLowerCase().includes(b.toLowerCase().trim())));m(g)},[s]),S=c.useCallback(b=>{const g=s.find(j=>j.value===b);g&&(v(g),u.current&&u.current.blur())},[s]),V=c.useCallback(b=>{if(b.key==="Enter"){if(p>=0&&p<s.length){const g=s[p];r(g.label),S(g.value)}else if(p===-1&&s.length>0){const g=s[0];r(g.label),S(g.value)}u.current&&u.current.blur()}else b.key==="ArrowDown"?I(g=>Math.min(g+1,s.length-1)):b.key==="ArrowUp"&&I(g=>Math.max(g-1,-1))},[p,s,S]);c.useEffect(()=>{if(i){const b={SearchText:x,DictionaryUri:i.ifcClassification.location};a(Le(b))}else a(He([]))},[a,x,i]),c.useEffect(()=>{u.current&&u.current.focus()},[]),c.useEffect(()=>{if(l){if(l.count){const b=l.dictionary?.classes;b&&m(b.filter(g=>g.uri&&g.name).map(g=>({value:g.uri,label:g.name,synonyms:g.synonyms||[]})))}}else m([])},[l]),c.useEffect(()=>{a(d?q(d.value):q(null))},[a,d]);const O=c.useCallback(()=>{C(""),u.current&&u.current.focus(),v(void 0)},[C]),M=({options:b,search:g})=>{const j=g.toLowerCase().trim().split(" ");return b.filter(D=>{const T=D.label.toLowerCase().trim().split(" "),B=D.synonyms?.map(R=>R.toLowerCase().trim().split(" ")).flat()||[];return j.every(R=>T.some($=>$.includes(R))||B.some($=>$.includes(R)))})};return n.jsx($e,{label:`${o("searchMainDictionaryLabel")} ${i?i.ifcClassification.name:""}`,data:s,placeholder:"bSDD search...",value:y,onChange:C,onOptionSubmit:S,filter:M,onKeyDown:V,ref:u,style:{width:"100%"},rightSection:n.jsx(le,{size:"sm",onMouseDown:b=>{b.preventDefault()},onClick:O,"aria-label":"Clear value"})})}const Y=60.7969;let se=0,ae=0;function bt({selectedIfcEntities:t}){const{t:e}=F(),a=N(),{bsddSearchSave:o,bsddSearchCancel:i}=ze(),[l,s]=c.useState(),[m,u]=c.useState(!1),[d,v]=c.useState(new Fe(et[tt])),y=w(pe),r=w(he),x=w(Ne),f=w(Ge),h=w(de),p=w(Ue),I=w(We),C=w(_e),[S,V]=c.useState(Y),[O,M]=c.useState("auto"),[b,g]=c.useState(!1),j=w(ce);c.useEffect(()=>{if(t&&t.length>0){const E=Ke(t);E&&(console.log("Setting mergedIfcEntity",E),a(Ye(E)))}},[a,t]);function D(E,k){return t?{ifcData:Ze(E,t),settings:I,propertyIsInstanceMap:k}:{ifcData:[],settings:I,propertyIsInstanceMap:k}}const T=c.useCallback(E=>{console.log("Sending bsddSearchSave data back to host",E),o(D(E,C)).then(k=>{console.log("Sent iFC data back to host",k)})},[o,C]);c.useEffect(()=>{if(!j||!b)return;const E=j.classProperties||[];a(Je({classProperties:E,languageCode:r}))},[j,b,r,a]),c.useEffect(()=>{if(!h||!y)return;const E=y.ifcClassification.location;h.hasAssociations?.forEach(k=>{if(k.type==="IfcClassificationReference"){const L=k;L.referencedSource?.location&&L.referencedSource.location===E&&(L.location&&a(q(L.location)),s({label:L.name,value:L.location}))}})},[y,h,a]),c.useEffect(()=>{p&&a(qe(p))},[p,a]),c.useEffect(()=>{M(`${S*x.length+48}px`)},[x.length,S]);const B=E=>{const k=ae+(E.clientY-se)/x.length;V(k>Y?k:Y)},R=()=>{document.removeEventListener("mousemove",B),document.removeEventListener("mouseup",R)},$=E=>{se=E.clientY,ae=S,document.addEventListener("mousemove",B),document.addEventListener("mouseup",R)},ge=E=>{g(E.includes("Propertysets"))};return n.jsxs(ue,{children:[n.jsx(z,{type:"hidden",name:"ifcType",id:"ifcType",value:""}),n.jsx(z,{type:"hidden",name:"name",id:"name",value:""}),n.jsx(z,{type:"hidden",name:"material",id:"material",value:""}),n.jsx(U,{mx:"md",mt:"lg",mb:"sm",children:n.jsx(mt,{api:d,defaultSelection:l})}),p?n.jsxs(n.Fragment,{children:[n.jsxs(A,{defaultValue:["Classifications"],multiple:!0,onChange:ge,children:[n.jsxs(A.Item,{value:"Classifications",children:[n.jsx(A.Control,{children:n.jsx(ee,{order:5,children:e("classificationsLabel")})}),n.jsx(A.Panel,{style:{height:O},children:n.jsx(at,{height:S,handleMouseDown:$})})]},"Classifications"),n.jsxs(A.Item,{value:"Propertysets",children:[n.jsx(A.Control,{children:n.jsx(ee,{order:5,children:e("propertysetsLabel")})}),n.jsx(A.Panel,{children:n.jsx(pt,{mainDictionaryClassification:j,recursiveMode:m})})]},"Propertysets")]}),n.jsxs(U,{my:"sm",justify:"center",children:[n.jsx(nt,{callback:T,ifcEntity:f}),n.jsx(X,{fullWidth:!0,variant:"light",color:"gray",onClick:i,children:e("cancel")})]})]}):n.jsxs(Xe,{mx:"md",title:e("noClassificationSelected"),mt:"xl",children:[e("classSearchInstruction"),n.jsx(Qe,{h:"md"}),e("needHelp")," ",n.jsx("a",{href:"https://github.com/buildingsmart-community/bSDD-Revit-plugin/wiki",target:"_blank",rel:"noreferrer",children:e("checkDocumentation")})]})]})}export{bt as B};
