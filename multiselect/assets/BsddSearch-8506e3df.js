import{aG as F,b as I,b1 as ie,aL as H,b7 as ce,b8 as xe,j as s,az as X,b9 as ve,r,aW as Ce,aX as P,ag as U,ba as Ie,a3 as Z,aS as Se,W as le,P as re,u as N,bb as we,bc as je,bd as De,be as ue,bf as Ee,B as fe,at as J,ay as Ve,bg as Me,bh as Oe,aE as de,ah as Ae,av as z,au as ke,bi as G,t as ee,bj as Te,bk as he,bl as Pe,bm as Re,f as pe,a_ as k,aB as Le,s as me,bn as Be,aD as He,bo as $e,bp as ze,bq as q,aF as Fe,aJ as Ne,br as Ge,bs as Ue,bt as We,bu as _e,bv as Ke,bw as Ye,bx as Je,aN as qe,aO as Xe,by as Qe,bz as Ze,a$ as te,aA as et,S as tt,bA as nt}from"./mergeIfcEntities-38aba008.js";const st={test:"https://test.bsdd.buildingsmart.org",production:"https://test.bsdd.buildingsmart.org"},at="production";function ot({callback:t,ifcEntity:e}){const{t:a}=F();I(ie);const n=H(ce),i=H(xe);function c(h){const u=h?{...JSON.parse(JSON.stringify(h))}:{hasAssociations:[],isDefinedBy:[]};return u.isDefinedBy=n?.filter(d=>d.name!=="Attributes"),u.hasAssociations=[],i?.forEach(d=>{if(d.type==="IfcClassificationReference"&&d?.referencedSource?.location?.includes("https://identifier.buildingsmart.org/uri/buildingsmart/ifc/")){const{type:v,predefinedType:y}=ve(d.identification);v&&(u.type=v),y&&(u.predefinedType=y),u.predefinedType||(u.predefinedType="NOTDEFINED")}else u.hasAssociations?.push(d)}),u}const o=()=>{const h=c(e);console.log(h),console.log("callback:",h),t(h)};return s.jsx(X,{color:"gray",fullWidth:!0,onClick:o,variant:"filled",children:a("apply")})}const ne=25,it=25;function se({height:t,options:e,label:a,value:n,setValue:i,placeholder:c="Search values",disabled:o}){const[h,u]=r.useState(""),[d,v]=r.useState(e.slice(0,ne)),y=r.useRef(null),l=Ce({onDropdownClose:()=>{l.resetSelectedOption(),l.focusTarget&&l.focusTarget()},onDropdownOpen:()=>{l.focusSearchInput&&l.focusSearchInput()}});r.useEffect(()=>{u(n?.label||"")},[n]),r.useEffect(()=>{const p=n===null?e.filter(g=>g?.label.toLowerCase().includes(h.toLowerCase().trim())||g?.value.toString().toLowerCase().includes(h.toLowerCase().trim())):e;v(p.slice(0,ne))},[e,h,n]);const x=p=>{const{scrollTop:g,scrollHeight:E,clientHeight:j}=p.currentTarget,S=5;E-g<=j+S&&v(A=>{const O=A.length,b=e.filter(m=>m?.label.toLowerCase().includes(h.toLowerCase().trim())).slice(O,O+it);return[...A,...b]})},f=d.map(p=>s.jsx(P.Option,{value:p.value,active:n?.value===p.value,children:s.jsxs(U,{gap:"sm",children:[n?.value===p.value?s.jsx(Ie,{size:12}):null,s.jsx(Z,{fz:"sm",opacity:o?.6:1,children:p.label}),s.jsxs(Z,{fz:"xs",opacity:.6,children:["(",p.value,")"]})]})},p.value));return s.jsx("div",{style:{display:"flex",flexDirection:"column",height:"100%"},children:s.jsxs(P,{store:l,onOptionSubmit:p=>{if(!o){const g=e.find(j=>j.value===p),E=g&&n?.value!==g.value?g:null;i(E),l.closeDropdown()}},disabled:o,children:[s.jsx(P.Target,{children:s.jsx(Se,{rightSection:!o&&s.jsx(le,{size:"sm",onMouseDown:p=>{p.preventDefault()},onClick:()=>{u(""),i(null)},"aria-label":"Clear value"}),label:a,value:n?`${n.label} (${n.value})`:h,onChange:p=>{o||(i(null),l.updateSelectedOptionIndex(),u(p.currentTarget.value))},onClick:()=>{o||l.openDropdown()},onBlur:()=>l.closeDropdown(),placeholder:o?"":c,disabled:o})}),t<80?s.jsx(P.Dropdown,{style:{maxHeight:"20em",overflowY:"auto"},ref:y,onScroll:x,children:s.jsx(P.Options,{children:f.length>0?f:s.jsx(P.Empty,{children:"Nothing found..."})})}):s.jsx(re,{withBorder:!0,my:"0.2em",style:{flexGrow:1,overflow:"auto",backgroundColor:o?"var(--mantine-color-gray-0)":"transparent",color:o?"var(--mantine-color-gray-6)":"inherit",pointerEvents:o?"none":"auto"},ref:y,onScroll:x,children:s.jsx(P.Options,{children:f.length>0?f:s.jsx(P.Empty,{children:"Nothing found..."})})})]})})}const ct=(t,e,a)=>{if(!e||!e.value)return null;const n=a[t];return n?{type:"IfcClassificationReference",name:e.label,location:e.uri,identification:e.value,referencedSource:{type:"IfcClassification",name:n.name,location:n.uri,edition:n.version,editionDate:n.releaseDate}}:null},lt=(t,e,a)=>{const n=Array.from(t.entries()).map(([i,c])=>ct(i,c,e)).filter(i=>i!==null);n.length>0&&a(Me(n))};function rt({height:t,handleMouseDown:e}){const a=N(),{t:n}=F(),[i,c]=r.useState(new Map),[o,h]=r.useState(new Map),u=I(we),d=I(je),v=H(ie),y=H(De),l=H(ue),x=H(Ee);return r.useEffect(()=>{(async()=>{const g=Array.from(u.entries()).map(async([w,A])=>{if(l&&w===x){const{code:C,name:M,uri:$}=l;return[w,[{value:C,label:M,uri:$}]]}let O=[];const b=y[w],m=l?.classRelations?.map(C=>C.relatedClassUri),V=b?.filter(C=>m?.includes(C.uri));if(V&&V.length>0)O=V.map(C=>({value:C.code,label:C.name,uri:C.uri}));else try{O=(await a(Oe(w)).unwrap())?.map(M=>({value:M.code,label:M.name||"",uri:M.uri}))??[]}catch(C){console.error("Failed to fetch dictionary classes for",w,C),O=[]}return[w,O]}),E=await Promise.all(g),j=new Map(E);c(j);const S=new Map;j.forEach((w,A)=>{if(w.length===1)S.set(A,w[0]);else if(A in d){const O=d[A];if(O.length===1){const b=O[0];if(w.some(V=>V.value===b.identification)){const V={label:b.name||"",value:b.identification||"",uri:b.location||""};S.set(A,V)}}}}),h(S)})()},[u,y,a,d,l,x]),r.useEffect(()=>{lt(o,v,a)},[v,a,o]),s.jsxs(re,{style:{height:`${t}px`,position:"relative"},children:[Array.from(u.entries()).map(([f,p])=>{const g=f===x,E=f===l?.dictionaryUri;return g?s.jsx(se,{height:t,label:p.name,options:i.get(f)||[],value:o.get(f)||null,setValue:j=>{const S=new Map(o);S.set(f,j),h(S)},placeholder:n("classifications.searchClassesPlaceholder"),disabled:i.get(f)?.length===1},f):E?null:s.jsx(se,{height:t,label:p.name,options:i.get(f)||[],value:o.get(f)||null,setValue:j=>{const S=new Map(o);S.set(f,j),h(S)},placeholder:n("classifications.searchClassesPlaceholder"),disabled:i.get(f)?.length===1},f)}),s.jsx(fe,{onMouseDown:e,style:{marginTop:"4px"},children:s.jsx(J,{label:n("classifications.dragResize"),withArrow:!0,children:s.jsx(X,{fullWidth:!0,variant:"subtle",size:"sm",color:"gray","aria-label":n("classifications.dragResize"),children:s.jsx(Ve,{})})})})]})}function _(t,e){return t==null||e==null?null:t.toLowerCase()!==e.toLowerCase()?`(${e})`:null}function ut({label:t,description:e,value:a,setValue:n,disabled:i,inputContainer:c}){const{t:o}=F(),[h,u]=r.useState(!1),[d,v]=r.useState(!0),y=()=>o(d?"checkbox.indeterminate":h?"checkbox.true":"checkbox.false"),l=f=>{f.target.indeterminate=!1,n(f.target.checked)};r.useEffect(()=>{a===!0?(u(!0),v(!1)):a===!1?(u(!1),v(!1)):a===void 0&&(u(!1),v(!0))},[a]);const x=s.jsx(de,{description:y(),checked:h,indeterminate:d,type:"checkbox",onChange:f=>l(f),disabled:i});return s.jsx(Ae.Wrapper,{label:t,description:e,children:c?c(x):x})}const K=(t,e,a,n)=>t.map(i=>{if(i.name===e){const c=i.hasProperties.map(o=>o.name===a?{...o,...n}:o);return{...i,hasProperties:c}}return i}),ft=(t,e,a)=>{const n=`${e}/${a}`;return t.hasOwnProperty(n)?t[n]:t[a]||!1};function dt({propertySet:t,property:e,propertyNaturalLanguageName:a}){const n=N(),i=I(ce),c=I(f=>f.ifcData.propertyIsInstanceMap),o=I(f=>f.ifcData.savedPropertyIsInstanceMap),[h,u]=r.useState(),d=t.name!=="Attributes",v=`${t.name}/${e.name}`,y=o.hasOwnProperty(v)||o.hasOwnProperty(e.name),l=ft(c,t.name||"",e.name),x=f=>d&&l?s.jsx(J,{label:ee("bsddSearch.property.tooltipEditInstance"),withArrow:!0,children:f}):f;return r.useEffect(()=>{switch(e.type){case"IfcPropertySingleValue":{e.nominalValue.type==="IfcBoolean"?u(s.jsx(ut,{label:a,description:_(a,e.name),disabled:l,inputContainer:x,value:e.nominalValue.value,setValue:f=>{if(i&&t.name){const p={nominalValue:{...e.nominalValue,value:f}},g=K(i,t.name,e.name,p);n(G(Object.values(g)))}}})):u(s.jsx(z,{label:a,description:_(a,e.name),placeholder:e.nominalValue.value,value:e.nominalValue.value||"",disabled:l,inputContainer:x,onChange:f=>{if(i&&t.name){const p={nominalValue:{...e.nominalValue,value:f.target.value}},g=K(i,t.name,e.name,p);n(G(Object.values(g)))}}}));break}case"IfcPropertyEnumeratedValue":{const f=e.enumerationValues?.[0]?.value,p=e.enumerationReference?.enumerationValues||[];u(s.jsx(ke,{label:a,description:_(a,e.name),value:f,inputContainer:x,disabled:l||e.enumerationReference?.enumerationValues?.length===1,onChange:g=>{if(i&&t.name){const E=p.find(w=>w.value===g),j={enumerationValues:E?[E]:[]},S=K(i,t.name,e.name,j);n(G(Object.values(S)))}},data:p.map(g=>({value:g.value,label:g.value}))}));break}default:{u(s.jsx(z,{placeholder:e.name,value:"{ifcProperty.nominalValue}",disabled:l,inputContainer:x}));break}}},[e,t,u,a,n,i,l]),s.jsxs(U,{children:[s.jsx("div",{style:{flex:1},children:h}),d&&s.jsx(J,{label:ee("bsddSearch.property.setAsInstanceCheckboxTooltip"),withArrow:!0,children:s.jsx(de,{style:{marginTop:"2rem"},disabled:y,checked:l,onChange:f=>{y||n(Te({propertyName:v,value:f.currentTarget.checked}))}})})]})}const ht={Boolean:"IfcBoolean",Character:"IfcText",Integer:"IfcInteger",Real:"IfcReal",String:"IfcText",Time:"IfcDateTime"};function W(t,e){const a=t&&ht[t]||"default";let n;return t==="Boolean"&&typeof e=="string"?e.toUpperCase()==="TRUE"?n=!0:e.toUpperCase()==="FALSE"?n=!1:n=void 0:n=e,{type:a,value:n}}function ge(t,e,a){let n;if(t&&t.isDefinedBy){let i=t.isDefinedBy.find(c=>c.name===e);if(i&&(n=i.hasProperties.find(c=>c.name===a)),n)return n;if(i=t.isDefinedBy.find(c=>c.name===""),i)return i.hasProperties.find(c=>c.name===a)}return n}function pt(t,e,a,n){const c=ge(e,a,n)?.nominalValue?.value??null;return W(t,c)}function mt(t,e,a,n,i){const c=ge(e,a,n);if(c){if(c.type==="IfcPropertyEnumeratedValue")return i.filter(o=>c.enumerationValues?c.enumerationValues.some(h=>h.value===o.value):!1);if("nominalValue"in c&&c.nominalValue){const o=i.find(h=>h.value===c.nominalValue.value);return o?[o]:[]}}return[]}function gt(t,e,a,n){const i=t.allowedValues?.map(h=>W(t.dataType,h.value))||[],c={type:"IfcPropertyEnumeratedValue",name:e,enumerationReference:{type:"IfcPropertyEnumeration",name:e,enumerationValues:i},enumerationValues:i};t.propertyUri&&(c.specification=t.propertyUri);const o=t.predefinedValue?[W(t.dataType,t.predefinedValue)]:mt(t.dataType,n,a,e,i);return o.length>0&&(c.enumerationValues=o),c}function bt(t,e,a,n){const i={type:"IfcPropertySingleValue",name:e,specification:t.propertyUri||""},c=t.predefinedValue?W(t.dataType,t.predefinedValue):pt(t.dataType,n,a,e);return c!==null&&(i.nominalValue=c),i}function yt(t,e,a){const{propertyCode:n}=t,i=n||"unknown",c=t.allowedValues?gt(t,i,e,a):bt(t,i,e,a);return c.specification=t.propertyUri||"",c}function xt({mainDictionaryClassification:t,recursiveMode:e}){const a=N(),n=I(he),i=I(Pe),c=I(Re),o=I(pe),[h,u]=r.useState({});return console.log("PropertySets.tsx:",i),r.useEffect(()=>{if(!t)return;const d={};[t].forEach(y=>{y.classProperties?.forEach(l=>{if(!l||!l.propertySet)return;const x=l.propertySet||y.name;d[x]||(d[x]={type:"IfcPropertySet",name:x,hasProperties:[]}),d[x].hasProperties.push(yt(l,x,n))})}),a(G(Object.values(d)))},[a,n,t]),r.useEffect(()=>{if(!t)return;const d={};[t].forEach(y=>{y.classProperties?.forEach(l=>{l&&l.propertyUri&&(o&&c&&c[o]&&c[o][l.propertyUri]?d[l.propertyUri]=c[o][l.propertyUri]||"":d[l.propertyUri]=l.name)})}),u(d)},[t,e,n,c,o]),s.jsx("div",{children:r.Children.toArray(i?.map((d,v)=>s.jsx(k,{variant:"contained",radius:"xs",children:s.jsxs(k.Item,{value:d.name||"Unknown",style:v!==0?{borderTopWidth:0}:{},children:[s.jsx(k.Control,{children:d.name}),s.jsx(k.Panel,{children:s.jsx(Le,{children:r.Children.toArray(d.hasProperties.map(y=>{const l=y.specification?h[y.specification]:"";return s.jsx(dt,{propertySet:d,property:y,propertyNaturalLanguageName:l})}))})})]},d.name||"Unknown")})))})}function vt({api:t,defaultSelection:e}){const a=N(),{t:n}=F(),i=I(me),c=I(Be),[o,h]=r.useState([]),u=r.useRef(null),[d,v]=r.useState(void 0),[y,l]=r.useState(""),[x]=He(y,300),[f,p]=r.useState(!1),[g,E]=r.useState(-1);r.useEffect(()=>{e&&!f&&o.length>0&&(o.find(m=>m.value===e.value)?(v(e),l(e.label),u.current&&u.current.blur()):(l(e.label),u.current&&(u.current.focus(),u.current.setSelectionRange(0,u.current.value.length))),p(!0))},[e,f,o]);const j=r.useCallback(b=>{l(b),E(-1);const m=o.filter(V=>V.label.toLowerCase().includes(b.toLowerCase().trim())||V.synonyms?.some(C=>C.toLowerCase().includes(b.toLowerCase().trim())));h(m)},[o]),S=r.useCallback(b=>{const m=o.find(V=>V.value===b);m&&(v(m),u.current&&u.current.blur())},[o]),w=r.useCallback(b=>{if(b.key==="Enter"){if(g>=0&&g<o.length){const m=o[g];l(m.label),S(m.value)}else if(g===-1&&o.length>0){const m=o[0];l(m.label),S(m.value)}u.current&&u.current.blur()}else b.key==="ArrowDown"?E(m=>Math.min(m+1,o.length-1)):b.key==="ArrowUp"&&E(m=>Math.max(m-1,-1))},[g,o,S]);r.useEffect(()=>{if(i){const b={SearchText:x,DictionaryUri:i.ifcClassification.location};a($e(b))}else a(ze([]))},[a,x,i]),r.useEffect(()=>{u.current&&u.current.focus()},[]),r.useEffect(()=>{if(c){if(c.count){const b=c.dictionary?.classes;b&&h(b.filter(m=>m.uri&&m.name).map(m=>({value:m.uri,label:m.name,synonyms:m.synonyms||[]})))}}else h([])},[c]),r.useEffect(()=>{a(d?q(d.value):q(null))},[a,d]);const A=r.useCallback(()=>{j(""),u.current&&u.current.focus(),v(void 0)},[j]),O=({options:b,search:m})=>{const V=m.toLowerCase().trim().split(" ");return b.filter(C=>{const M=C.label.toLowerCase().trim().split(" "),$=C.synonyms?.map(R=>R.toLowerCase().trim().split(" ")).flat()||[];return V.every(R=>M.some(L=>L.includes(R))||$.some(L=>L.includes(R)))})};return s.jsx(Fe,{label:`${n("searchMainDictionaryLabel")} ${i?i.ifcClassification.name:""}`,data:o,placeholder:"bSDD search...",value:y,onChange:j,onOptionSubmit:S,filter:O,onKeyDown:w,ref:u,style:{width:"100%"},rightSection:s.jsx(le,{size:"sm",onMouseDown:b=>{b.preventDefault()},onClick:A,"aria-label":"Clear value"})})}const Y=60.7969;let ae=0,oe=0;function It({selectedIfcEntities:t}){const{t:e}=F(),a=N(),{bsddSearchSave:n,bsddSearchCancel:i}=Ne(),[c,o]=r.useState(),[h,u]=r.useState(!1),[d,v]=r.useState(new Ge(st[at])),y=I(me),l=I(pe),x=I(Ue),f=I(We),p=I(he),g=I(_e),E=I(Ke),j=I(Ye),S=I(Je),[w,A]=r.useState(Y),[O,b]=r.useState("auto"),[m,V]=r.useState(!1),C=I(ue),M=t??S;r.useEffect(()=>{if(M&&M.length>0){const D=qe(M);D&&(console.log("Setting mergedIfcEntity",D),a(Xe(D)))}},[a,M]);function $(D,T){return console.log("Creating bsddSearchSave data",M),M?{ifcData:nt(D,M),settings:E,propertyIsInstanceMap:T}:{ifcData:[],settings:E,propertyIsInstanceMap:T}}const R=r.useCallback(D=>{console.log("Sending bsddSearchSave data back to host",D),n($(D,j)).then(T=>{console.log("Sent iFC data back to host",T)})},[n,j]);r.useEffect(()=>{if(!C||!m)return;const D=C.classProperties||[];a(Qe({classProperties:D,languageCode:l}))},[C,m,l,a]),r.useEffect(()=>{if(!p||!y)return;const D=y.ifcClassification.location;p.hasAssociations?.forEach(T=>{if(T.type==="IfcClassificationReference"){const B=T;B.referencedSource?.location&&B.referencedSource.location===D&&(B.location&&a(q(B.location)),o({label:B.name,value:B.location}))}})},[y,p,a]),r.useEffect(()=>{g&&a(Ze(g))},[g,a]),r.useEffect(()=>{b(`${w*x.length+48}px`)},[x.length,w]);const L=D=>{const T=oe+(D.clientY-ae)/x.length;A(T>Y?T:Y)},Q=()=>{document.removeEventListener("mousemove",L),document.removeEventListener("mouseup",Q)},be=D=>{ae=D.clientY,oe=w,document.addEventListener("mousemove",L),document.addEventListener("mouseup",Q)},ye=D=>{V(D.includes("Propertysets"))};return s.jsxs(fe,{children:[s.jsx(z,{type:"hidden",name:"ifcType",id:"ifcType",value:""}),s.jsx(z,{type:"hidden",name:"name",id:"name",value:""}),s.jsx(z,{type:"hidden",name:"material",id:"material",value:""}),s.jsx(U,{mx:"md",mt:"lg",mb:"sm",children:s.jsx(vt,{api:d,defaultSelection:c})}),g?s.jsxs(s.Fragment,{children:[s.jsxs(k,{defaultValue:["Classifications"],multiple:!0,onChange:ye,children:[s.jsxs(k.Item,{value:"Classifications",children:[s.jsx(k.Control,{children:s.jsx(te,{order:5,children:e("classificationsLabel")})}),s.jsx(k.Panel,{style:{height:O},children:s.jsx(rt,{height:w,handleMouseDown:be})})]},"Classifications"),s.jsxs(k.Item,{value:"Propertysets",children:[s.jsx(k.Control,{children:s.jsx(te,{order:5,children:e("propertysetsLabel")})}),s.jsx(k.Panel,{children:s.jsx(xt,{mainDictionaryClassification:C,recursiveMode:h})})]},"Propertysets")]}),s.jsxs(U,{my:"sm",justify:"center",children:[s.jsx(ot,{callback:R,ifcEntity:f}),s.jsx(X,{fullWidth:!0,variant:"light",color:"gray",onClick:i,children:e("cancel")})]})]}):s.jsxs(et,{mx:"md",title:e("noClassificationSelected"),mt:"xl",children:[e("classSearchInstruction"),s.jsx(tt,{h:"md"}),e("needHelp")," ",s.jsx("a",{href:"https://github.com/buildingsmart-community/bSDD-Revit-plugin/wiki",target:"_blank",rel:"noreferrer",children:e("checkDocumentation")})]})]})}export{It as B};
