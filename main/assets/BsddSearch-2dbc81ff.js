import{aG as B,aH as I,b3 as X,b9 as ue,ba as fe,bb as de,bc as ee,r as i,j as n,az as W,bd as he,aY as pe,aZ as T,ag as z,be as me,a3 as _,aU as ge,W as te,P as ne,u as k,bf as be,bg as xe,b as N,bh as ye,bi as se,bj as ve,B as ae,at as U,ay as Ce,bk as Ie,bl as Se,aE as oe,ah as je,bm as we,av as L,au as De,bn as le,bo as Ee,bp as Ve,t as Y,bq as Me,br as re,bs as Oe,bt as Ae,aO as ie,b0 as A,aB as Pe,aL as ce,bu as Te,aD as ke,bv as Le,bw as Re,bx as G,aF as Be,aJ as He,by as Ne,bz as ze,bA as $e,bB as Fe,bC as Ue,b1 as K,aA as Ge,S as We}from"./defaultSettings-ebe84946.js";const _e={test:"https://test.bsdd.buildingsmart.org",production:"https://api.bsdd.buildingsmart.org"},Ye="production";function Ke({bsddSearchSave:e}){const{t}=B();I(X);const r=I(ue),s=I(fe),o=I(de),a=I(ee);function l(x,f){return console.log("Creating bsddSearchSave data",a),a?{ifcData:he(x,a),settings:s,propertyIsInstanceMap:f}:{ifcData:[],settings:s,propertyIsInstanceMap:f}}const h=i.useCallback(x=>{console.log("Sending bsddSearchSave data back to host",x),e(l(x,o)).then(f=>{console.log("Sent iFC data back to host",f)})},[e,o]),u=()=>{console.log(r),h(r)};return n.jsx(W,{color:"gray",fullWidth:!0,onClick:u,variant:"filled",children:t("apply")})}const q=25,qe=25;function J({height:e,options:t,label:r,value:s,setValue:o,placeholder:a="Search values",disabled:l}){const[h,u]=i.useState(""),[x,f]=i.useState(t.slice(0,q)),v=i.useRef(null),d=pe({onDropdownClose:()=>{d.resetSelectedOption(),d.focusTarget&&d.focusTarget()},onDropdownOpen:()=>{d.focusSearchInput&&d.focusSearchInput()}});i.useEffect(()=>{u(s?.label||"")},[s]),i.useEffect(()=>{const m=s===null?t.filter(p=>p?.label.toLowerCase().includes(h.toLowerCase().trim())||p?.value.toString().toLowerCase().includes(h.toLowerCase().trim())):t;f(m.slice(0,q))},[t,h,s]);const y=m=>{const{scrollTop:p,scrollHeight:M,clientHeight:j}=m.currentTarget,S=5;M-p<=j+S&&f(E=>{const V=E.length,b=t.filter(g=>g?.label.toLowerCase().includes(h.toLowerCase().trim())).slice(V,V+qe);return[...E,...b]})},c=x.map(m=>n.jsx(T.Option,{value:m.value,active:s?.value===m.value,children:n.jsxs(z,{gap:"sm",children:[s?.value===m.value?n.jsx(me,{size:12}):null,n.jsx(_,{fz:"sm",opacity:l?.6:1,children:m.label}),n.jsxs(_,{fz:"xs",opacity:.6,children:["(",m.value,")"]})]})},m.value));return n.jsx("div",{style:{display:"flex",flexDirection:"column",height:"100%"},children:n.jsxs(T,{store:d,onOptionSubmit:m=>{if(!l){const p=t.find(j=>j.value===m),M=p&&s?.value!==p.value?p:null;o(M),d.closeDropdown()}},disabled:l,children:[n.jsx(T.Target,{children:n.jsx(ge,{rightSection:!l&&n.jsx(te,{size:"sm",onMouseDown:m=>{m.preventDefault()},onClick:()=>{u(""),o(null)},"aria-label":"Clear value"}),label:r,value:s?`${s.label} (${s.value})`:h,onChange:m=>{l||(o(null),d.updateSelectedOptionIndex(),u(m.currentTarget.value))},onClick:()=>{l||d.openDropdown()},onBlur:()=>d.closeDropdown(),placeholder:l?"":a,disabled:l})}),e<80?n.jsx(T.Dropdown,{style:{maxHeight:"20em",overflowY:"auto"},ref:v,onScroll:y,children:n.jsx(T.Options,{children:c.length>0?c:n.jsx(T.Empty,{children:"Nothing found..."})})}):n.jsx(ne,{withBorder:!0,my:"0.2em",style:{flexGrow:1,overflow:"auto",backgroundColor:l?"var(--mantine-color-gray-0)":"transparent",color:l?"var(--mantine-color-gray-6)":"inherit",pointerEvents:l?"none":"auto"},ref:v,onScroll:y,children:n.jsx(T.Options,{children:c.length>0?c:n.jsx(T.Empty,{children:"Nothing found..."})})})]})})}const Je=(e,t,r)=>{if(!t||!t.value)return null;const s=r[e];return s?{type:"IfcClassificationReference",name:t.label,location:t.uri,identification:t.value,referencedSource:{type:"IfcClassification",name:s.name,location:s.uri,edition:s.version,editionDate:s.releaseDate}}:null},Ze=(e,t,r)=>{const s=Array.from(e.entries()).map(([o,a])=>Je(o,a,t)).filter(o=>o!==null);s.length>0&&r(Ie(s))};function Qe({height:e,handleMouseDown:t}){const r=k(),{t:s}=B(),[o,a]=i.useState(new Map),[l,h]=i.useState(new Map),u=I(be),x=I(xe),f=N(X),v=N(ye),d=N(se),y=N(ve);return i.useEffect(()=>{(async()=>{const p=Array.from(u.entries()).map(async([D,E])=>{if(d&&D===y){const{code:C,name:O,uri:P}=d;return[D,[{value:C,label:O,uri:P}]]}let V=[];const b=v[D],g=d?.classRelations?.map(C=>C.relatedClassUri),w=b?.filter(C=>g?.includes(C.uri));if(w&&w.length>0)V=w.map(C=>({value:C.code,label:C.name,uri:C.uri}));else try{V=(await r(Se(D)).unwrap())?.map(O=>({value:O.code,label:O.name||"",uri:O.uri}))??[]}catch(C){console.error("Failed to fetch dictionary classes for",D,C),V=[]}return[D,V]}),M=await Promise.all(p),j=new Map(M);a(j);const S=new Map;j.forEach((D,E)=>{if(D.length===1)S.set(E,D[0]);else if(E in x){const V=x[E];if(V.length===1){const b=V[0];if(D.some(w=>w.value===b.identification)){const w={label:b.name||"",value:b.identification||"",uri:b.location||""};S.set(E,w)}}}}),h(S)})()},[u,v,r,x,d,y]),i.useEffect(()=>{Ze(l,f,r)},[f,r,l]),n.jsxs(ne,{style:{height:`${e}px`,position:"relative"},children:[Array.from(u.entries()).map(([c,m])=>{const p=c===y,M=c===d?.dictionaryUri;return p?n.jsx(J,{height:e,label:m.name,options:o.get(c)||[],value:l.get(c)||null,setValue:j=>{const S=new Map(l);S.set(c,j),h(S)},placeholder:s("classifications.searchClassesPlaceholder"),disabled:o.get(c)?.length===1},c):M?null:n.jsx(J,{height:e,label:m.name,options:o.get(c)||[],value:l.get(c)||null,setValue:j=>{const S=new Map(l);S.set(c,j),h(S)},placeholder:s("classifications.searchClassesPlaceholder"),disabled:o.get(c)?.length===1},c)}),n.jsx(ae,{onMouseDown:t,style:{marginTop:"4px"},children:n.jsx(U,{label:s("classifications.dragResize"),withArrow:!0,children:n.jsx(W,{fullWidth:!0,variant:"subtle",size:"sm",color:"gray","aria-label":s("classifications.dragResize"),children:n.jsx(Ce,{})})})})]})}function Xe(e,t){return e==null||t==null?null:e.toLowerCase()!==t.toLowerCase()?`(${t})`:null}function et({label:e,description:t,value:r,setValue:s,disabled:o,inputContainer:a}){const{t:l}=B(),[h,u]=i.useState(!1),[x,f]=i.useState(!0),v=()=>l(x?"checkbox.indeterminate":h?"checkbox.true":"checkbox.false"),d=c=>{c.target.indeterminate=!1,s(c.target.checked)};i.useEffect(()=>{r===!0?(u(!0),f(!1)):r===!1?(u(!1),f(!1)):r===void 0&&(u(!1),f(!0))},[r]);const y=n.jsx(oe,{description:v(),checked:h,indeterminate:x,type:"checkbox",onChange:c=>d(c),disabled:o});return n.jsx(je.Wrapper,{label:e,description:t,children:a?a(y):y})}const tt=(e,t,r,s)=>{const o=e.map(a=>{if(a.name===t){const l=a.hasProperties.map(h=>h.name===r?{...h,...s}:h);return l.some(h=>h.name===r)||l.push({name:r,...s}),{...a,hasProperties:l}}return a});return o.some(a=>a.name===t)||o.push({type:"IfcPropertySet",name:t,hasProperties:[{name:r,...s}]}),o},nt=e=>e.type==="IfcPropertySingleValue",st=e=>e.type==="IfcPropertyEnumeratedValue",at=e=>e.enumerationValues?.[0]?.value||void 0,ot=e=>e.nominalValue?.value||void 0,lt=e=>nt(e)?ot(e).value:st(e)?at(e).value:void 0,rt=({propertySet:e,property:t,propertyNaturalLanguageName:r,isInstance:s,inputContainer:o})=>{const a=k(),l=I(we),[h,u]=i.useState(),x=r?.trim()?r:t.name,f=Xe(x,t.name);i.useEffect(()=>{t.type==="IfcPropertySingleValue"?u(t.nominalValue?.type==="IfcBoolean"?t.nominalValue?.value??!1:t.nominalValue?.value??""):t.type==="IfcPropertyEnumeratedValue"&&u(t.enumerationValues?.[0]?.value??"")},[t]);const v=c=>{if(u(c),l&&e.name){let m;"nominalValue"in t?m={nominalValue:{...t.nominalValue,value:c}}:"enumerationReference"in t?m={enumerationValues:(t.enumerationReference?.enumerationValues||[]).filter(S=>S.value===c)}:m={value:c};const p=tt(l,e.name,t.name,m);a(le(p)),e.name==="Attributes"&&(t.name==="ObjectType"?a(Ee(c)):t.name==="Description"&&a(Ve(c)))}},d=c=>{v(c)};return(()=>{switch(t.type){case"IfcPropertySingleValue":return t.nominalValue?.type==="IfcBoolean"?n.jsx(et,{label:x,description:f,disabled:s,inputContainer:o,value:h,setValue:p=>d(p)}):n.jsx(L,{label:x,description:f,placeholder:t.nominalValue?.value??"",value:h,disabled:s,inputContainer:o,onChange:p=>d(p.target.value),onBlur:p=>v(p.target.value)});case"IfcPropertyEnumeratedValue":const c=t.enumerationReference?.enumerationValues||[],m=c.length===1;return n.jsx(De,{label:x,description:f,value:h,inputContainer:o,disabled:s||m,clearable:!m,onChange:p=>d(p),data:c.map(p=>({value:p.value,label:p.value}))});default:return n.jsx(L,{placeholder:t.name,defaultValue:lt(t),disabled:s,inputContainer:o,onChange:p=>d(p.target.value),onBlur:p=>v(p.target.value)})}})()},it=["Name","Description","ObjectType"],ct=(e,t,r)=>{if(t==="Attributes"&&!it.includes(r))return!0;const s=`${t}/${r}`;return e[s]||e[r]||!1};function ut({propertySet:e,property:t,propertyNaturalLanguageName:r}){const s=k(),o=I(v=>v.ifcData.propertyIsInstanceMap),a=I(v=>v.ifcData.savedPropertyIsInstanceMap),l=e.name!=="Attributes",h=`${e.name}/${t.name}`,u=a.hasOwnProperty(h)||a.hasOwnProperty(t.name),x=ct(o,e.name||"",t.name),f=v=>l&&x?n.jsx(U,{label:Y("bsddSearch.property.tooltipEditInstance"),withArrow:!0,children:v}):v;return n.jsxs(z,{children:[n.jsx("div",{style:{flex:1},children:n.jsx(rt,{propertySet:e,property:t,propertyNaturalLanguageName:r,isInstance:x,inputContainer:f})}),l&&n.jsx(U,{label:Y("bsddSearch.property.setAsInstanceCheckboxTooltip"),withArrow:!0,children:n.jsx(oe,{style:{marginTop:"2rem"},disabled:u,checked:x,onChange:v=>{u||s(Me({propertyName:h,value:v.currentTarget.checked}))}})})]})}const ft={Boolean:"IfcBoolean",Character:"IfcText",Integer:"IfcInteger",Real:"IfcReal",String:"IfcText",Time:"IfcDateTime"};function R(e,t){const r=e&&ft[e]||"default";let s;return e==="Boolean"&&typeof t=="string"?t.toUpperCase()==="TRUE"?s=!0:t.toUpperCase()==="FALSE"?s=!1:s=void 0:s=t,{type:r,value:s}}function dt(e,t,r){let s;if(e&&e.isDefinedBy){let o=e.isDefinedBy.find(a=>a.name===t);if(o&&(s=o.hasProperties.find(a=>a.name===r)),s)return s;if(o=e.isDefinedBy.find(a=>a.name===""),o)return o.hasProperties.find(a=>a.name===r)}return s}function ht(e,t,r,s){const a=dt(t,r,s)?.nominalValue?.value??null;return R(e,a)}function pt(e,t,r,s){const o=e.allowedValues?.map(l=>R(e.dataType,l.value))||[],a={type:"IfcPropertyEnumeratedValue",name:t,enumerationReference:{type:"IfcPropertyEnumeration",name:t,enumerationValues:o}};return e.propertyUri&&(a.specification=e.propertyUri),e.allowedValues&&e.allowedValues.length===1?a.enumerationValues=[R(e.dataType,e.allowedValues[0].value)]:a.enumerationValues=e.predefinedValue?[R(e.dataType,e.predefinedValue)]:null,a}function mt(e,t,r,s){const o={type:"IfcPropertySingleValue",name:t,specification:e.propertyUri||""};let a=null;return e.predefinedValue?a=R(e.dataType,e.predefinedValue):s&&(a=ht(e.dataType,s,r,t)),a!==null&&(o.nominalValue=a),o}function gt(e,t,r){const{propertyCode:s}=e,o=s||"unknown",a=e.allowedValues?pt(e,o):mt(e,o,t,r);return a.specification=e.propertyUri||"",a}function bt({mainDictionaryClassification:e,recursiveMode:t}){const r=k(),s=I(re);I(Oe);const o=I(Ae),a=I(ie),[l,h]=i.useState({}),[u,x]=i.useState(null);return i.useEffect(()=>{if(!e)return;const f={};[e].forEach(d=>{d.classProperties?.forEach(y=>{if(!y||!y.propertySet)return;const c=y.propertySet||d.name;f[c]||(f[c]={type:"IfcPropertySet",name:c,hasProperties:[]}),f[c].hasProperties.push(gt(y,c,s))})}),r(le(Object.values(f))),x(Object.values(f))},[r,s,e]),i.useEffect(()=>{if(!e)return;const f={};[e].forEach(d=>{d.classProperties?.forEach(y=>{y&&y.propertyUri&&(a&&o&&o[a]&&o[a][y.propertyUri]?f[y.propertyUri]=o[a][y.propertyUri]||"":f[y.propertyUri]=y.name)})}),h(f)},[e,t,s,o,a]),n.jsx("div",{children:i.Children.toArray(u?.map((f,v)=>n.jsx(A,{variant:"contained",radius:"xs",children:n.jsxs(A.Item,{value:f.name||"Unknown",style:v!==0?{borderTopWidth:0}:{},children:[n.jsx(A.Control,{children:f.name}),n.jsx(A.Panel,{children:n.jsx(Pe,{children:i.Children.toArray(f.hasProperties.map(d=>{const y=d.specification?l[d.specification]:"";return n.jsx(ut,{propertySet:f,property:d,propertyNaturalLanguageName:y})}))})})]},f.name||"Unknown")})))})}function xt({api:e,defaultSelection:t}){const r=k(),{t:s}=B(),o=I(ce),a=I(Te),[l,h]=i.useState([]),u=i.useRef(null),[x,f]=i.useState(void 0),[v,d]=i.useState(""),[y]=ke(v,300),[c,m]=i.useState(!1),[p,M]=i.useState(-1);i.useEffect(()=>{t&&!c&&l.length>0&&(l.find(g=>g.value===t.value)?(f(t),d(t.label),u.current&&u.current.blur()):(d(t.label),u.current&&(u.current.focus(),u.current.setSelectionRange(0,u.current.value.length))),m(!0))},[t,c,l]);const j=i.useCallback(b=>{d(b),M(-1);const g=l.filter(w=>w.label.toLowerCase().includes(b.toLowerCase().trim())||w.synonyms?.some(C=>C.toLowerCase().includes(b.toLowerCase().trim())));h(g)},[l]),S=i.useCallback(b=>{const g=l.find(w=>w.value===b);g&&(f(g),u.current&&u.current.blur())},[l]),D=i.useCallback(b=>{if(b.key==="Enter"){if(p>=0&&p<l.length){const g=l[p];d(g.label),S(g.value)}else if(p===-1&&l.length>0){const g=l[0];d(g.label),S(g.value)}u.current&&u.current.blur()}else b.key==="ArrowDown"?M(g=>Math.min(g+1,l.length-1)):b.key==="ArrowUp"&&M(g=>Math.max(g-1,-1))},[p,l,S]);i.useEffect(()=>{if(o){const b={SearchText:y,DictionaryUri:o.ifcClassification.location};r(Le(b))}else r(Re([]))},[r,y,o]),i.useEffect(()=>{u.current&&u.current.focus()},[]),i.useEffect(()=>{if(a){if(a.count){const b=a.dictionary?.classes;b&&h(b.filter(g=>g.uri&&g.name).map(g=>({value:g.uri,label:g.name,synonyms:g.synonyms||[]})))}}else h([])},[a]),i.useEffect(()=>{r(x?G(x.value):G(null))},[r,x]);const E=i.useCallback(()=>{j(""),u.current&&u.current.focus(),f(void 0)},[j]),V=({options:b,search:g})=>{const w=g.toLowerCase().trim().split(" ");return b.filter(C=>{const O=C.label.toLowerCase().trim().split(" "),P=C.synonyms?.map(H=>H.toLowerCase().trim().split(" ")).flat()||[];return w.every(H=>O.some($=>$.includes(H))||P.some($=>$.includes(H)))})};return n.jsx(Be,{label:`${s("searchMainDictionaryLabel")} ${o?o.ifcClassification.name:""}`,data:l,placeholder:"bSDD search...",value:v,onChange:j,onOptionSubmit:S,filter:V,onKeyDown:D,ref:u,style:{width:"100%"},rightSection:n.jsx(te,{size:"sm",onMouseDown:b=>{b.preventDefault()},onClick:E,"aria-label":"Clear value"})})}const F=60.7969;let Z=0,Q=0;function vt(){const{t:e}=B(),t=k(),{bsddSearchSave:r,bsddSearchCancel:s}=He(),o=I(ce),a=I(ie),l=I(Ne),h=I(re),u=I(ze);I(ee);const[x,f]=i.useState(),[v,d]=i.useState(!1),[y,c]=i.useState(new $e(_e[Ye])),[m,p]=i.useState(F),[M,j]=i.useState("auto"),[S,D]=i.useState(!1),E=I(se);i.useEffect(()=>{if(!E||!S)return;const C=E.classProperties||[];t(Fe({classProperties:C,languageCode:a}))},[E,S,a,t]),i.useEffect(()=>{if(!h||!o)return;const C=o.ifcClassification.location;h.hasAssociations?.forEach(O=>{if(O.type==="IfcClassificationReference"){const P=O;P.referencedSource?.location&&P.referencedSource.location===C&&(P.location&&t(G(P.location)),f({label:P.name,value:P.location}))}})},[o,h,t]),i.useEffect(()=>{u&&t(Ue(u))},[u,t]),i.useEffect(()=>{j(`${m*l.length+48}px`)},[l.length,m]);const V=C=>{const O=Q+(C.clientY-Z)/l.length;p(O>F?O:F)},b=()=>{document.removeEventListener("mousemove",V),document.removeEventListener("mouseup",b)},g=C=>{Z=C.clientY,Q=m,document.addEventListener("mousemove",V),document.addEventListener("mouseup",b)},w=C=>{D(C.includes("Propertysets"))};return n.jsxs(ae,{children:[n.jsx(L,{type:"hidden",name:"ifcType",id:"ifcType",value:""}),n.jsx(L,{type:"hidden",name:"name",id:"name",value:""}),n.jsx(L,{type:"hidden",name:"material",id:"material",value:""}),n.jsx(z,{mx:"md",mt:"lg",mb:"sm",children:n.jsx(xt,{api:y,defaultSelection:x})}),u?n.jsxs(n.Fragment,{children:[n.jsxs(A,{defaultValue:["Classifications"],multiple:!0,onChange:w,children:[n.jsxs(A.Item,{value:"Classifications",children:[n.jsx(A.Control,{children:n.jsx(K,{order:5,children:e("classificationsLabel")})}),n.jsx(A.Panel,{style:{height:M},children:n.jsx(Qe,{height:m,handleMouseDown:g})})]},"Classifications"),n.jsxs(A.Item,{value:"Propertysets",children:[n.jsx(A.Control,{children:n.jsx(K,{order:5,children:e("propertysetsLabel")})}),n.jsx(A.Panel,{children:n.jsx(bt,{mainDictionaryClassification:E,recursiveMode:v})})]},"Propertysets")]}),n.jsxs(z,{my:"sm",justify:"center",children:[n.jsx(Ke,{bsddSearchSave:r}),n.jsx(W,{fullWidth:!0,variant:"light",color:"gray",onClick:s,children:e("cancel")})]})]}):n.jsxs(Ge,{mx:"md",title:e("noClassificationSelected"),mt:"xl",children:[e("classSearchInstruction"),n.jsx(We,{h:"md"}),e("needHelp")," ",n.jsx("a",{href:"https://github.com/buildingsmart-community/bSDD-Revit-plugin/wiki",target:"_blank",rel:"noreferrer",children:e("checkDocumentation")})]})]})}export{vt as B};
