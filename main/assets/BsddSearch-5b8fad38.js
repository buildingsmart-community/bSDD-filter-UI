import{aG as L,aH as v,b3 as ee,b9 as de,ba as he,bb as pe,bc as te,r as f,j as s,az as _,bd as me,be as ge,aY as be,aZ as P,ag as z,bf as ye,a3 as Y,aU as xe,W as ne,P as se,u as B,bg as ve,bh as Ce,b as H,bi as Ie,bj as ae,bk as Se,B as oe,at as G,ay as je,bl as we,bm as De,aE as ie,ah as Ee,bn as Ve,av as R,au as Te,bo as le,bp as Ae,bq as Me,t as K,br as Oe,bs as ce,bt as ke,bu as Pe,aO as re,b0 as O,aB as Be,aL as ue,bv as Re,aD as Le,bw as He,bx as ze,by as W,aF as Fe,aJ as Ne,bz as $e,bA as Ue,bB as Ge,h as We,i as _e,bC as Ye,bD as Ke,b1 as J,aA as Je,S as qe}from"./mergeIfcEntities-18c46416.js";const Ze={test:"https://test.bsdd.buildingsmart.org",production:"https://api.bsdd.buildingsmart.org"},Qe="production";function Xe(t){const e=t?{...JSON.parse(JSON.stringify(t))}:{hasAssociations:[],isDefinedBy:[]};return e.isDefinedBy=t?.isDefinedBy||[],e.hasAssociations=[],t?.hasAssociations?.forEach(o=>{if(o.type==="IfcClassificationReference"&&o?.referencedSource?.location?.includes("https://identifier.buildingsmart.org/uri/buildingsmart/ifc/")){const{type:n,predefinedType:i}=ge(o.identification);n&&(e.type=n),i&&(e.predefinedType=i),e.predefinedType||(e.predefinedType="NOTDEFINED")}else e.hasAssociations?.push(o)}),e}function et({bsddSearchSave:t}){const{t:e}=L();v(ee);const o=v(de),n=v(he),i=v(pe),l=v(te);function a(c,u){return console.log("Creating bsddSearchSave data",l),l?{ifcData:me(c,l),settings:n,propertyIsInstanceMap:u}:{ifcData:[],settings:n,propertyIsInstanceMap:u}}const p=f.useCallback(c=>{console.log("Sending bsddSearchSave data back to host",c),t(a(c,i)).then(u=>{console.log("Sent iFC data back to host",u)})},[t,i]),d=()=>{const c=Xe(o);console.log(c),p(c)};return s.jsx(_,{color:"gray",fullWidth:!0,onClick:d,variant:"filled",children:e("apply")})}const q=25,tt=25;function Z({height:t,options:e,label:o,value:n,setValue:i,placeholder:l="Search values",disabled:a}){const[p,d]=f.useState(""),[c,u]=f.useState(e.slice(0,q)),h=f.useRef(null),r=be({onDropdownClose:()=>{r.resetSelectedOption(),r.focusTarget&&r.focusTarget()},onDropdownOpen:()=>{r.focusSearchInput&&r.focusSearchInput()}});f.useEffect(()=>{d(n?.label||"")},[n]),f.useEffect(()=>{const y=n===null?e.filter(x=>x?.label.toLowerCase().includes(p.toLowerCase().trim())||x?.value.toString().toLowerCase().includes(p.toLowerCase().trim())):e;u(y.slice(0,q))},[e,p,n]);const I=y=>{const{scrollTop:x,scrollHeight:T,clientHeight:D}=y.currentTarget,j=5;T-x<=D+j&&u(A=>{const w=A.length,g=e.filter(m=>m?.label.toLowerCase().includes(p.toLowerCase().trim())).slice(w,w+tt);return[...A,...g]})},b=c.map(y=>s.jsx(P.Option,{value:y.value,active:n?.value===y.value,children:s.jsxs(z,{gap:"sm",children:[n?.value===y.value?s.jsx(ye,{size:12}):null,s.jsx(Y,{fz:"sm",opacity:a?.6:1,children:y.label}),s.jsxs(Y,{fz:"xs",opacity:.6,children:["(",y.value,")"]})]})},y.value));return s.jsx("div",{style:{display:"flex",flexDirection:"column",height:"100%"},children:s.jsxs(P,{store:r,onOptionSubmit:y=>{if(!a){const x=e.find(D=>D.value===y),T=x&&n?.value!==x.value?x:null;i(T),r.closeDropdown()}},disabled:a,children:[s.jsx(P.Target,{children:s.jsx(xe,{rightSection:!a&&s.jsx(ne,{size:"sm",onMouseDown:y=>{y.preventDefault()},onClick:()=>{d(""),i(null)},"aria-label":"Clear value"}),label:o,value:n?`${n.label} (${n.value})`:p,onChange:y=>{a||(i(null),r.updateSelectedOptionIndex(),d(y.currentTarget.value))},onClick:()=>{a||r.openDropdown()},onBlur:()=>r.closeDropdown(),placeholder:a?"":l,disabled:a})}),t<80?s.jsx(P.Dropdown,{style:{maxHeight:"20em",overflowY:"auto"},ref:h,onScroll:I,children:s.jsx(P.Options,{children:b.length>0?b:s.jsx(P.Empty,{children:"Nothing found..."})})}):s.jsx(se,{withBorder:!0,my:"0.2em",style:{flexGrow:1,overflow:"auto",backgroundColor:a?"var(--mantine-color-gray-0)":"transparent",color:a?"var(--mantine-color-gray-6)":"inherit",pointerEvents:a?"none":"auto"},ref:h,onScroll:I,children:s.jsx(P.Options,{children:b.length>0?b:s.jsx(P.Empty,{children:"Nothing found..."})})})]})})}const nt=(t,e,o)=>{if(!e||!e.value)return null;const n=o[t];return n?{type:"IfcClassificationReference",name:e.label,location:e.uri,identification:e.value,referencedSource:{type:"IfcClassification",name:n.name,location:n.uri,edition:n.version,editionDate:n.releaseDate}}:null},st=(t,e,o)=>{const n=Array.from(t.entries()).map(([i,l])=>nt(i,l,e)).filter(i=>i!==null);n.length>0&&o(we(n))};function at({height:t,handleMouseDown:e}){const o=B(),{t:n}=L(),[i,l]=f.useState(new Map),[a,p]=f.useState(new Map),d=v(ve),c=v(Ce),u=H(ee),h=H(Ie),r=H(ae),I=H(Se);return f.useEffect(()=>{(async()=>{const x=Array.from(d.entries()).map(async([E,A])=>{if(r&&E===I){const{code:S,name:C,uri:k}=r;return[E,[{value:S,label:C,uri:k}]]}let w=[];const g=h[E],m=r?.classRelations?.map(S=>S.relatedClassUri),V=g?.filter(S=>m?.includes(S.uri));if(V&&V.length>0)w=V.map(S=>({value:S.code,label:S.name,uri:S.uri}));else try{w=(await o(De(E)).unwrap())?.map(C=>({value:C.code,label:C.name||"",uri:C.uri}))??[]}catch(S){console.error("Failed to fetch dictionary classes for",E,S),w=[]}return[E,w]}),T=await Promise.all(x),D=new Map(T);l(D);const j=new Map;D.forEach((E,A)=>{if(E.length===1)j.set(A,E[0]);else if(A in c){const w=c[A];if(w.length===1){const g=w[0];if(E.some(V=>V.value===g.identification)){const V={label:g.name||"",value:g.identification||"",uri:g.location||""};j.set(A,V)}}}}),p(j)})()},[d,h,o,c,r,I]),f.useEffect(()=>{st(a,u,o)},[u,o,a]),s.jsxs(se,{style:{height:`${t}px`,position:"relative"},children:[Array.from(d.entries()).map(([b,y])=>{const x=b===I,T=b===r?.dictionaryUri;return x?s.jsx(Z,{height:t,label:y.name,options:i.get(b)||[],value:a.get(b)||null,setValue:D=>{const j=new Map(a);j.set(b,D),p(j)},placeholder:n("classifications.searchClassesPlaceholder"),disabled:i.get(b)?.length===1},b):T?null:s.jsx(Z,{height:t,label:y.name,options:i.get(b)||[],value:a.get(b)||null,setValue:D=>{const j=new Map(a);j.set(b,D),p(j)},placeholder:n("classifications.searchClassesPlaceholder"),disabled:i.get(b)?.length===1},b)}),s.jsx(oe,{onMouseDown:e,style:{marginTop:"4px"},children:s.jsx(G,{label:n("classifications.dragResize"),withArrow:!0,children:s.jsx(_,{fullWidth:!0,variant:"subtle",size:"sm",color:"gray","aria-label":n("classifications.dragResize"),children:s.jsx(je,{})})})})]})}function $(t,e){return t==null||e==null?null:t.toLowerCase()!==e.toLowerCase()?`(${e})`:null}function ot({label:t,description:e,value:o,setValue:n,disabled:i,inputContainer:l}){const{t:a}=L(),[p,d]=f.useState(!1),[c,u]=f.useState(!0),h=()=>a(c?"checkbox.indeterminate":p?"checkbox.true":"checkbox.false"),r=b=>{b.target.indeterminate=!1,n(b.target.checked)};f.useEffect(()=>{o===!0?(d(!0),u(!1)):o===!1?(d(!1),u(!1)):o===void 0&&(d(!1),u(!0))},[o]);const I=s.jsx(ie,{description:h(),checked:p,indeterminate:c,type:"checkbox",onChange:b=>r(b),disabled:i});return s.jsx(Ee.Wrapper,{label:t,description:e,children:l?l(I):I})}const it=(t,e,o,n)=>t.map(i=>{if(i.name===e){const l=i.hasProperties.map(a=>a.name===o?{...a,...n}:a);return{...i,hasProperties:l}}return i}),lt=({propertySet:t,property:e,propertyNaturalLanguageName:o,isInstance:n,inputContainer:i})=>{const l=B(),a=v(Ve),p=e.type==="IfcPropertySingleValue"?e.nominalValue?.value||void 0:e.type==="IfcPropertyEnumeratedValue"&&e.enumerationValues?.[0]?.value||void 0,d=u=>{if(a&&t.name)if(t.name!=="Attributes"){let h;"nominalValue"in e?h={nominalValue:{...e.nominalValue,value:u}}:"enumerationValues"in e?h={enumerationValues:[{value:u}]}:h={value:u};const r=it(a,t.name,e.name,h);l(le(Object.values(r)))}else e.name==="ObjectType"?l(Ae(u)):e.name==="Description"&&l(Me(u))},c=u=>{d(u)};switch(e.type){case"IfcPropertySingleValue":return e.nominalValue?.type==="IfcBoolean"?s.jsx(ot,{label:o,description:$(o,e.name),disabled:n,inputContainer:i,value:e.nominalValue?.value??!1,setValue:u=>c(u)}):s.jsx(R,{label:o,description:$(o,e.name),placeholder:e.nominalValue?.value??"",value:e.nominalValue?.value??"",disabled:n,inputContainer:i,onChange:u=>c(u.target.value),onBlur:u=>d(u.target.value)});case"IfcPropertyEnumeratedValue":{const u=e.enumerationValues?.[0]?.value??"",h=e.enumerationReference?.enumerationValues||[];return s.jsx(Te,{label:o,description:$(o,e.name),value:u,inputContainer:i,disabled:n||e.enumerationReference?.enumerationValues?.length===1,clearable:!0,onChange:r=>c(r),data:h.map(r=>({value:r.value,label:r.value}))})}default:return s.jsx(R,{placeholder:e.name,defaultValue:p,disabled:n,inputContainer:i,onChange:u=>c(u.target.value),onBlur:u=>d(u.target.value)})}},ct=["Name","Description","ObjectType","PredefinedType"],rt=(t,e,o)=>{if(e==="Attributes"&&!ct.includes(o))return!0;const n=`${e}/${o}`;return t[n]||t[o]||!1};function ut({propertySet:t,property:e,propertyNaturalLanguageName:o}){const n=B(),i=v(h=>h.ifcData.propertyIsInstanceMap),l=v(h=>h.ifcData.savedPropertyIsInstanceMap),a=t.name!=="Attributes",p=`${t.name}/${e.name}`,d=l.hasOwnProperty(p)||l.hasOwnProperty(e.name),c=rt(i,t.name||"",e.name),u=h=>a&&c?s.jsx(G,{label:K("bsddSearch.property.tooltipEditInstance"),withArrow:!0,children:h}):h;return s.jsxs(z,{children:[s.jsx("div",{style:{flex:1},children:s.jsx(lt,{propertySet:t,property:e,propertyNaturalLanguageName:o,isInstance:c,inputContainer:u})}),a&&s.jsx(G,{label:K("bsddSearch.property.setAsInstanceCheckboxTooltip"),withArrow:!0,children:s.jsx(ie,{style:{marginTop:"2rem"},disabled:d,checked:c,onChange:h=>{d||n(Oe({propertyName:p,value:h.currentTarget.checked}))}})})]})}const ft={Boolean:"IfcBoolean",Character:"IfcText",Integer:"IfcInteger",Real:"IfcReal",String:"IfcText",Time:"IfcDateTime"};function F(t,e){const o=t&&ft[t]||"default";let n;return t==="Boolean"&&typeof e=="string"?e.toUpperCase()==="TRUE"?n=!0:e.toUpperCase()==="FALSE"?n=!1:n=void 0:n=e,{type:o,value:n}}function fe(t,e,o){let n;if(t&&t.isDefinedBy){let i=t.isDefinedBy.find(l=>l.name===e);if(i&&(n=i.hasProperties.find(l=>l.name===o)),n)return n;if(i=t.isDefinedBy.find(l=>l.name===""),i)return i.hasProperties.find(l=>l.name===o)}return n}function dt(t,e,o,n){const l=fe(e,o,n)?.nominalValue?.value??null;return F(t,l)}function ht(t,e,o,n,i){const l=fe(e,o,n);if(l){if(l.type==="IfcPropertyEnumeratedValue")return i.filter(a=>l.enumerationValues?l.enumerationValues.some(p=>p.value===a.value):!1);if("nominalValue"in l&&l.nominalValue){const a=i.find(p=>p.value===l.nominalValue?.value);return a?[a]:[]}}return[]}function pt(t,e,o,n){const i=t.allowedValues?.map(p=>F(t.dataType,p.value))||[],l={type:"IfcPropertyEnumeratedValue",name:e,enumerationReference:{type:"IfcPropertyEnumeration",name:e,enumerationValues:i},enumerationValues:i};t.propertyUri&&(l.specification=t.propertyUri);const a=t.predefinedValue?[F(t.dataType,t.predefinedValue)]:ht(t.dataType,n,o,e,i);return a.length>0&&(l.enumerationValues=a),l}function mt(t,e,o,n){const i={type:"IfcPropertySingleValue",name:e,specification:t.propertyUri||""},l=t.predefinedValue?F(t.dataType,t.predefinedValue):dt(t.dataType,n,o,e);return l!==null&&(i.nominalValue=l),i}function gt(t,e,o){const{propertyCode:n}=t,i=n||"unknown",l=t.allowedValues?pt(t,i,e,o):mt(t,i,e,o);return l.specification=t.propertyUri||"",l}function bt({mainDictionaryClassification:t,recursiveMode:e}){const o=B(),n=v(ce),i=v(ke),l=v(Pe),a=v(re),[p,d]=f.useState({});return f.useEffect(()=>{if(!t)return;const c={};[t].forEach(h=>{h.classProperties?.forEach(r=>{if(!r||!r.propertySet)return;const I=r.propertySet||h.name;c[I]||(c[I]={type:"IfcPropertySet",name:I,hasProperties:[]}),c[I].hasProperties.push(gt(r,I,n))})}),o(le(Object.values(c)))},[o,n,t]),f.useEffect(()=>{if(!t)return;const c={};[t].forEach(h=>{h.classProperties?.forEach(r=>{r&&r.propertyUri&&(a&&l&&l[a]&&l[a][r.propertyUri]?c[r.propertyUri]=l[a][r.propertyUri]||"":c[r.propertyUri]=r.name)})}),d(c)},[t,e,n,l,a]),s.jsx("div",{children:f.Children.toArray(i?.map((c,u)=>s.jsx(O,{variant:"contained",radius:"xs",children:s.jsxs(O.Item,{value:c.name||"Unknown",style:u!==0?{borderTopWidth:0}:{},children:[s.jsx(O.Control,{children:c.name}),s.jsx(O.Panel,{children:s.jsx(Be,{children:f.Children.toArray(c.hasProperties.map(h=>{const r=h.specification?p[h.specification]:"";return s.jsx(ut,{propertySet:c,property:h,propertyNaturalLanguageName:r})}))})})]},c.name||"Unknown")})))})}function yt({api:t,defaultSelection:e}){const o=B(),{t:n}=L(),i=v(ue),l=v(Re),[a,p]=f.useState([]),d=f.useRef(null),[c,u]=f.useState(void 0),[h,r]=f.useState(""),[I]=Le(h,300),[b,y]=f.useState(!1),[x,T]=f.useState(-1);f.useEffect(()=>{e&&!b&&a.length>0&&(a.find(m=>m.value===e.value)?(u(e),r(e.label),d.current&&d.current.blur()):(r(e.label),d.current&&(d.current.focus(),d.current.setSelectionRange(0,d.current.value.length))),y(!0))},[e,b,a]);const D=f.useCallback(g=>{r(g),T(-1);const m=a.filter(V=>V.label.toLowerCase().includes(g.toLowerCase().trim())||V.synonyms?.some(S=>S.toLowerCase().includes(g.toLowerCase().trim())));p(m)},[a]),j=f.useCallback(g=>{const m=a.find(V=>V.value===g);m&&(u(m),d.current&&d.current.blur())},[a]),E=f.useCallback(g=>{if(g.key==="Enter"){if(x>=0&&x<a.length){const m=a[x];r(m.label),j(m.value)}else if(x===-1&&a.length>0){const m=a[0];r(m.label),j(m.value)}d.current&&d.current.blur()}else g.key==="ArrowDown"?T(m=>Math.min(m+1,a.length-1)):g.key==="ArrowUp"&&T(m=>Math.max(m-1,-1))},[x,a,j]);f.useEffect(()=>{if(i){const g={SearchText:I,DictionaryUri:i.ifcClassification.location};o(He(g))}else o(ze([]))},[o,I,i]),f.useEffect(()=>{d.current&&d.current.focus()},[]),f.useEffect(()=>{if(l){if(l.count){const g=l.dictionary?.classes;g&&p(g.filter(m=>m.uri&&m.name).map(m=>({value:m.uri,label:m.name,synonyms:m.synonyms||[]})))}}else p([])},[l]),f.useEffect(()=>{o(c?W(c.value):W(null))},[o,c]);const A=f.useCallback(()=>{D(""),d.current&&d.current.focus(),u(void 0)},[D]),w=({options:g,search:m})=>{const V=m.toLowerCase().trim().split(" ");return g.filter(S=>{const C=S.label.toLowerCase().trim().split(" "),k=S.synonyms?.map(M=>M.toLowerCase().trim().split(" ")).flat()||[];return V.every(M=>C.some(N=>N.includes(M))||k.some(N=>N.includes(M)))})};return s.jsx(Fe,{label:`${n("searchMainDictionaryLabel")} ${i?i.ifcClassification.name:""}`,data:a,placeholder:"bSDD search...",value:h,onChange:D,onOptionSubmit:j,filter:w,onKeyDown:E,ref:d,style:{width:"100%"},rightSection:s.jsx(ne,{size:"sm",onMouseDown:g=>{g.preventDefault()},onClick:A,"aria-label":"Clear value"})})}const U=60.7969;let Q=0,X=0;function vt(){const{t}=L(),e=B(),{bsddSearchSave:o,bsddSearchCancel:n}=Ne(),i=v(ue),l=v(re),a=v($e),p=v(ce),d=v(Ue),c=v(te),[u,h]=f.useState(),[r,I]=f.useState(!1),[b,y]=f.useState(new Ge(Ze[Qe])),[x,T]=f.useState(U),[D,j]=f.useState("auto"),[E,A]=f.useState(!1),w=v(ae);f.useEffect(()=>{if(c&&c.length>0){const C=We(c);C&&(console.log("Setting mergedIfcEntity",C),e(_e(C)))}},[e,c]),f.useEffect(()=>{if(!w||!E)return;const C=w.classProperties||[];e(Ye({classProperties:C,languageCode:l}))},[w,E,l,e]),f.useEffect(()=>{if(!p||!i)return;const C=i.ifcClassification.location;p.hasAssociations?.forEach(k=>{if(k.type==="IfcClassificationReference"){const M=k;M.referencedSource?.location&&M.referencedSource.location===C&&(M.location&&e(W(M.location)),h({label:M.name,value:M.location}))}})},[i,p,e]),f.useEffect(()=>{d&&e(Ke(d))},[d,e]),f.useEffect(()=>{j(`${x*a.length+48}px`)},[a.length,x]);const g=C=>{const k=X+(C.clientY-Q)/a.length;T(k>U?k:U)},m=()=>{document.removeEventListener("mousemove",g),document.removeEventListener("mouseup",m)},V=C=>{Q=C.clientY,X=x,document.addEventListener("mousemove",g),document.addEventListener("mouseup",m)},S=C=>{A(C.includes("Propertysets"))};return s.jsxs(oe,{children:[s.jsx(R,{type:"hidden",name:"ifcType",id:"ifcType",value:""}),s.jsx(R,{type:"hidden",name:"name",id:"name",value:""}),s.jsx(R,{type:"hidden",name:"material",id:"material",value:""}),s.jsx(z,{mx:"md",mt:"lg",mb:"sm",children:s.jsx(yt,{api:b,defaultSelection:u})}),d?s.jsxs(s.Fragment,{children:[s.jsxs(O,{defaultValue:["Classifications"],multiple:!0,onChange:S,children:[s.jsxs(O.Item,{value:"Classifications",children:[s.jsx(O.Control,{children:s.jsx(J,{order:5,children:t("classificationsLabel")})}),s.jsx(O.Panel,{style:{height:D},children:s.jsx(at,{height:x,handleMouseDown:V})})]},"Classifications"),s.jsxs(O.Item,{value:"Propertysets",children:[s.jsx(O.Control,{children:s.jsx(J,{order:5,children:t("propertysetsLabel")})}),s.jsx(O.Panel,{children:s.jsx(bt,{mainDictionaryClassification:w,recursiveMode:r})})]},"Propertysets")]}),s.jsxs(z,{my:"sm",justify:"center",children:[s.jsx(et,{bsddSearchSave:o}),s.jsx(_,{fullWidth:!0,variant:"light",color:"gray",onClick:n,children:t("cancel")})]})]}):s.jsxs(Je,{mx:"md",title:t("noClassificationSelected"),mt:"xl",children:[t("classSearchInstruction"),s.jsx(qe,{h:"md"}),t("needHelp")," ",s.jsx("a",{href:"https://github.com/buildingsmart-community/bSDD-Revit-plugin/wiki",target:"_blank",rel:"noreferrer",children:t("checkDocumentation")})]})]})}export{vt as B};
