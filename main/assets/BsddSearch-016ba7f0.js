import{aG as L,aH as v,b3 as ee,b9 as de,ba as he,bb as pe,bc as te,r as f,j as s,az as _,bd as me,be as ge,aY as be,aZ as B,ag as z,bf as ye,a3 as Y,aU as xe,W as ne,P as se,u as P,bg as ve,bh as Ce,b as H,bi as Ie,bj as ae,bk as Se,B as ie,at as G,ay as je,bl as we,bm as De,aE as oe,ah as Ee,bn as Ve,av as R,au as Te,bo as le,bp as Ae,bq as Me,t as K,br as Oe,bs as ce,bt as ke,bu as Be,aO as re,b0 as O,aB as Pe,aL as ue,bv as Re,aD as Le,bw as He,bx as ze,by as W,aF as Fe,aJ as Ne,bz as $e,bA as Ue,bB as Ge,h as We,i as _e,bC as Ye,bD as Ke,b1 as J,aA as Je,S as qe}from"./mergeIfcEntities-0e2c8225.js";const Ze={test:"https://test.bsdd.buildingsmart.org",production:"https://api.bsdd.buildingsmart.org"},Qe="production";function Xe(t){const e=t?{...JSON.parse(JSON.stringify(t))}:{hasAssociations:[],isDefinedBy:[]};return e.isDefinedBy=t?.isDefinedBy||[],e.hasAssociations=[],t?.hasAssociations?.forEach(i=>{if(i.type==="IfcClassificationReference"&&i?.referencedSource?.location?.includes("https://identifier.buildingsmart.org/uri/buildingsmart/ifc/")){const{type:n,predefinedType:o}=ge(i.identification);n&&(e.type=n),o&&(e.predefinedType=o),e.predefinedType||(e.predefinedType="NOTDEFINED")}else e.hasAssociations?.push(i)}),e}function et({bsddSearchSave:t}){const{t:e}=L();v(ee);const i=v(de),n=v(he),o=v(pe),l=v(te);function a(c,h){return console.log("Creating bsddSearchSave data",l),l?{ifcData:me(c,l),settings:n,propertyIsInstanceMap:h}:{ifcData:[],settings:n,propertyIsInstanceMap:h}}const d=f.useCallback(c=>{console.log("Sending bsddSearchSave data back to host",c),t(a(c,o)).then(h=>{console.log("Sent iFC data back to host",h)})},[t,o]),r=()=>{const c=Xe(i);console.log(c),d(c)};return s.jsx(_,{color:"gray",fullWidth:!0,onClick:r,variant:"filled",children:e("apply")})}const q=25,tt=25;function Z({height:t,options:e,label:i,value:n,setValue:o,placeholder:l="Search values",disabled:a}){const[d,r]=f.useState(""),[c,h]=f.useState(e.slice(0,q)),p=f.useRef(null),u=be({onDropdownClose:()=>{u.resetSelectedOption(),u.focusTarget&&u.focusTarget()},onDropdownOpen:()=>{u.focusSearchInput&&u.focusSearchInput()}});f.useEffect(()=>{r(n?.label||"")},[n]),f.useEffect(()=>{const y=n===null?e.filter(x=>x?.label.toLowerCase().includes(d.toLowerCase().trim())||x?.value.toString().toLowerCase().includes(d.toLowerCase().trim())):e;h(y.slice(0,q))},[e,d,n]);const I=y=>{const{scrollTop:x,scrollHeight:T,clientHeight:D}=y.currentTarget,j=5;T-x<=D+j&&h(A=>{const w=A.length,g=e.filter(m=>m?.label.toLowerCase().includes(d.toLowerCase().trim())).slice(w,w+tt);return[...A,...g]})},b=c.map(y=>s.jsx(B.Option,{value:y.value,active:n?.value===y.value,children:s.jsxs(z,{gap:"sm",children:[n?.value===y.value?s.jsx(ye,{size:12}):null,s.jsx(Y,{fz:"sm",opacity:a?.6:1,children:y.label}),s.jsxs(Y,{fz:"xs",opacity:.6,children:["(",y.value,")"]})]})},y.value));return s.jsx("div",{style:{display:"flex",flexDirection:"column",height:"100%"},children:s.jsxs(B,{store:u,onOptionSubmit:y=>{if(!a){const x=e.find(D=>D.value===y),T=x&&n?.value!==x.value?x:null;o(T),u.closeDropdown()}},disabled:a,children:[s.jsx(B.Target,{children:s.jsx(xe,{rightSection:!a&&s.jsx(ne,{size:"sm",onMouseDown:y=>{y.preventDefault()},onClick:()=>{r(""),o(null)},"aria-label":"Clear value"}),label:i,value:n?`${n.label} (${n.value})`:d,onChange:y=>{a||(o(null),u.updateSelectedOptionIndex(),r(y.currentTarget.value))},onClick:()=>{a||u.openDropdown()},onBlur:()=>u.closeDropdown(),placeholder:a?"":l,disabled:a})}),t<80?s.jsx(B.Dropdown,{style:{maxHeight:"20em",overflowY:"auto"},ref:p,onScroll:I,children:s.jsx(B.Options,{children:b.length>0?b:s.jsx(B.Empty,{children:"Nothing found..."})})}):s.jsx(se,{withBorder:!0,my:"0.2em",style:{flexGrow:1,overflow:"auto",backgroundColor:a?"var(--mantine-color-gray-0)":"transparent",color:a?"var(--mantine-color-gray-6)":"inherit",pointerEvents:a?"none":"auto"},ref:p,onScroll:I,children:s.jsx(B.Options,{children:b.length>0?b:s.jsx(B.Empty,{children:"Nothing found..."})})})]})})}const nt=(t,e,i)=>{if(!e||!e.value)return null;const n=i[t];return n?{type:"IfcClassificationReference",name:e.label,location:e.uri,identification:e.value,referencedSource:{type:"IfcClassification",name:n.name,location:n.uri,edition:n.version,editionDate:n.releaseDate}}:null},st=(t,e,i)=>{const n=Array.from(t.entries()).map(([o,l])=>nt(o,l,e)).filter(o=>o!==null);n.length>0&&i(we(n))};function at({height:t,handleMouseDown:e}){const i=P(),{t:n}=L(),[o,l]=f.useState(new Map),[a,d]=f.useState(new Map),r=v(ve),c=v(Ce),h=H(ee),p=H(Ie),u=H(ae),I=H(Se);return f.useEffect(()=>{(async()=>{const x=Array.from(r.entries()).map(async([E,A])=>{if(u&&E===I){const{code:S,name:C,uri:k}=u;return[E,[{value:S,label:C,uri:k}]]}let w=[];const g=p[E],m=u?.classRelations?.map(S=>S.relatedClassUri),V=g?.filter(S=>m?.includes(S.uri));if(V&&V.length>0)w=V.map(S=>({value:S.code,label:S.name,uri:S.uri}));else try{w=(await i(De(E)).unwrap())?.map(C=>({value:C.code,label:C.name||"",uri:C.uri}))??[]}catch(S){console.error("Failed to fetch dictionary classes for",E,S),w=[]}return[E,w]}),T=await Promise.all(x),D=new Map(T);l(D);const j=new Map;D.forEach((E,A)=>{if(E.length===1)j.set(A,E[0]);else if(A in c){const w=c[A];if(w.length===1){const g=w[0];if(E.some(V=>V.value===g.identification)){const V={label:g.name||"",value:g.identification||"",uri:g.location||""};j.set(A,V)}}}}),d(j)})()},[r,p,i,c,u,I]),f.useEffect(()=>{st(a,h,i)},[h,i,a]),s.jsxs(se,{style:{height:`${t}px`,position:"relative"},children:[Array.from(r.entries()).map(([b,y])=>{const x=b===I,T=b===u?.dictionaryUri;return x?s.jsx(Z,{height:t,label:y.name,options:o.get(b)||[],value:a.get(b)||null,setValue:D=>{const j=new Map(a);j.set(b,D),d(j)},placeholder:n("classifications.searchClassesPlaceholder"),disabled:o.get(b)?.length===1},b):T?null:s.jsx(Z,{height:t,label:y.name,options:o.get(b)||[],value:a.get(b)||null,setValue:D=>{const j=new Map(a);j.set(b,D),d(j)},placeholder:n("classifications.searchClassesPlaceholder"),disabled:o.get(b)?.length===1},b)}),s.jsx(ie,{onMouseDown:e,style:{marginTop:"4px"},children:s.jsx(G,{label:n("classifications.dragResize"),withArrow:!0,children:s.jsx(_,{fullWidth:!0,variant:"subtle",size:"sm",color:"gray","aria-label":n("classifications.dragResize"),children:s.jsx(je,{})})})})]})}function $(t,e){return t==null||e==null?null:t.toLowerCase()!==e.toLowerCase()?`(${e})`:null}function it({label:t,description:e,value:i,setValue:n,disabled:o,inputContainer:l}){const{t:a}=L(),[d,r]=f.useState(!1),[c,h]=f.useState(!0),p=()=>a(c?"checkbox.indeterminate":d?"checkbox.true":"checkbox.false"),u=b=>{b.target.indeterminate=!1,n(b.target.checked)};f.useEffect(()=>{i===!0?(r(!0),h(!1)):i===!1?(r(!1),h(!1)):i===void 0&&(r(!1),h(!0))},[i]);const I=s.jsx(oe,{description:p(),checked:d,indeterminate:c,type:"checkbox",onChange:b=>u(b),disabled:o});return s.jsx(Ee.Wrapper,{label:t,description:e,children:l?l(I):I})}const ot=(t,e,i,n)=>t.map(o=>{if(o.name===e){const l=o.hasProperties.map(a=>a.name===i?{...a,...n}:a);return{...o,hasProperties:l}}return o}),lt=({propertySet:t,property:e,propertyNaturalLanguageName:i,isInstance:n,inputContainer:o})=>{const l=P(),a=v(Ve),[d,r]=f.useState("");f.useEffect(()=>{"nominalValue"in e?r(e.nominalValue?.value||""):"enumerationValues"in e&&r(e.enumerationValues?.[0]?.value||"")},[e]);const c=()=>{if(a&&t.name)if(t.name!=="Attributes"){let h;"nominalValue"in e?h={nominalValue:{...e.nominalValue,value:d}}:"enumerationValues"in e?h={enumerationValues:[{...e.enumerationValues?.[0],value:d}]}:h={value:d};const p=ot(a,t.name,e.name,h);l(le(Object.values(p)))}else e.name==="ObjectType"?l(Ae(d)):e.name==="Description"&&l(Me(d))};switch(e.type){case"IfcPropertySingleValue":return e.nominalValue?.type==="IfcBoolean"?s.jsx(it,{label:i,description:$(i,e.name),disabled:n,inputContainer:o,value:d,setValue:h=>r(h)}):s.jsx(R,{label:i,description:$(i,e.name),placeholder:e.nominalValue?.value,value:d,disabled:n,inputContainer:o,onChange:h=>r(h.target.value),onBlur:c});case"IfcPropertyEnumeratedValue":{const h=e.enumerationValues?.[0]?.value,p=e.enumerationReference?.enumerationValues||[];return s.jsx(Te,{label:i,description:$(i,e.name),value:h,inputContainer:o,disabled:n||e.enumerationReference?.enumerationValues?.length===1,onChange:u=>r(u),onBlur:c,data:p.map(u=>({value:u.value,label:u.value}))})}default:return s.jsx(R,{placeholder:e.name,value:d,disabled:n,inputContainer:o,onChange:h=>r(h.target.value),onBlur:c})}},ct=["Name","Description","ObjectType","PredefinedType"],rt=(t,e,i)=>{if(e==="Attributes"&&!ct.includes(i))return!0;const n=`${e}/${i}`;return t[n]||t[i]||!1};function ut({propertySet:t,property:e,propertyNaturalLanguageName:i}){const n=P(),o=v(p=>p.ifcData.propertyIsInstanceMap),l=v(p=>p.ifcData.savedPropertyIsInstanceMap),a=t.name!=="Attributes",d=`${t.name}/${e.name}`,r=l.hasOwnProperty(d)||l.hasOwnProperty(e.name),c=rt(o,t.name||"",e.name),h=p=>a&&c?s.jsx(G,{label:K("bsddSearch.property.tooltipEditInstance"),withArrow:!0,children:p}):p;return s.jsxs(z,{children:[s.jsx("div",{style:{flex:1},children:s.jsx(lt,{propertySet:t,property:e,propertyNaturalLanguageName:i,isInstance:c,inputContainer:h})}),a&&s.jsx(G,{label:K("bsddSearch.property.setAsInstanceCheckboxTooltip"),withArrow:!0,children:s.jsx(oe,{style:{marginTop:"2rem"},disabled:r,checked:c,onChange:p=>{r||n(Oe({propertyName:d,value:p.currentTarget.checked}))}})})]})}const ft={Boolean:"IfcBoolean",Character:"IfcText",Integer:"IfcInteger",Real:"IfcReal",String:"IfcText",Time:"IfcDateTime"};function F(t,e){const i=t&&ft[t]||"default";let n;return t==="Boolean"&&typeof e=="string"?e.toUpperCase()==="TRUE"?n=!0:e.toUpperCase()==="FALSE"?n=!1:n=void 0:n=e,{type:i,value:n}}function fe(t,e,i){let n;if(t&&t.isDefinedBy){let o=t.isDefinedBy.find(l=>l.name===e);if(o&&(n=o.hasProperties.find(l=>l.name===i)),n)return n;if(o=t.isDefinedBy.find(l=>l.name===""),o)return o.hasProperties.find(l=>l.name===i)}return n}function dt(t,e,i,n){const l=fe(e,i,n)?.nominalValue?.value??null;return F(t,l)}function ht(t,e,i,n,o){const l=fe(e,i,n);if(l){if(l.type==="IfcPropertyEnumeratedValue")return o.filter(a=>l.enumerationValues?l.enumerationValues.some(d=>d.value===a.value):!1);if("nominalValue"in l&&l.nominalValue){const a=o.find(d=>d.value===l.nominalValue.value);return a?[a]:[]}}return[]}function pt(t,e,i,n){const o=t.allowedValues?.map(d=>F(t.dataType,d.value))||[],l={type:"IfcPropertyEnumeratedValue",name:e,enumerationReference:{type:"IfcPropertyEnumeration",name:e,enumerationValues:o},enumerationValues:o};t.propertyUri&&(l.specification=t.propertyUri);const a=t.predefinedValue?[F(t.dataType,t.predefinedValue)]:ht(t.dataType,n,i,e,o);return a.length>0&&(l.enumerationValues=a),l}function mt(t,e,i,n){const o={type:"IfcPropertySingleValue",name:e,specification:t.propertyUri||""},l=t.predefinedValue?F(t.dataType,t.predefinedValue):dt(t.dataType,n,i,e);return l!==null&&(o.nominalValue=l),o}function gt(t,e,i){const{propertyCode:n}=t,o=n||"unknown",l=t.allowedValues?pt(t,o,e,i):mt(t,o,e,i);return l.specification=t.propertyUri||"",l}function bt({mainDictionaryClassification:t,recursiveMode:e}){const i=P(),n=v(ce),o=v(ke),l=v(Be),a=v(re),[d,r]=f.useState({});return f.useEffect(()=>{if(!t)return;const c={};[t].forEach(p=>{p.classProperties?.forEach(u=>{if(!u||!u.propertySet)return;const I=u.propertySet||p.name;c[I]||(c[I]={type:"IfcPropertySet",name:I,hasProperties:[]}),c[I].hasProperties.push(gt(u,I,n))})}),i(le(Object.values(c)))},[i,n,t]),f.useEffect(()=>{if(!t)return;const c={};[t].forEach(p=>{p.classProperties?.forEach(u=>{u&&u.propertyUri&&(a&&l&&l[a]&&l[a][u.propertyUri]?c[u.propertyUri]=l[a][u.propertyUri]||"":c[u.propertyUri]=u.name)})}),r(c)},[t,e,n,l,a]),s.jsx("div",{children:f.Children.toArray(o?.map((c,h)=>s.jsx(O,{variant:"contained",radius:"xs",children:s.jsxs(O.Item,{value:c.name||"Unknown",style:h!==0?{borderTopWidth:0}:{},children:[s.jsx(O.Control,{children:c.name}),s.jsx(O.Panel,{children:s.jsx(Pe,{children:f.Children.toArray(c.hasProperties.map(p=>{const u=p.specification?d[p.specification]:"";return s.jsx(ut,{propertySet:c,property:p,propertyNaturalLanguageName:u})}))})})]},c.name||"Unknown")})))})}function yt({api:t,defaultSelection:e}){const i=P(),{t:n}=L(),o=v(ue),l=v(Re),[a,d]=f.useState([]),r=f.useRef(null),[c,h]=f.useState(void 0),[p,u]=f.useState(""),[I]=Le(p,300),[b,y]=f.useState(!1),[x,T]=f.useState(-1);f.useEffect(()=>{e&&!b&&a.length>0&&(a.find(m=>m.value===e.value)?(h(e),u(e.label),r.current&&r.current.blur()):(u(e.label),r.current&&(r.current.focus(),r.current.setSelectionRange(0,r.current.value.length))),y(!0))},[e,b,a]);const D=f.useCallback(g=>{u(g),T(-1);const m=a.filter(V=>V.label.toLowerCase().includes(g.toLowerCase().trim())||V.synonyms?.some(S=>S.toLowerCase().includes(g.toLowerCase().trim())));d(m)},[a]),j=f.useCallback(g=>{const m=a.find(V=>V.value===g);m&&(h(m),r.current&&r.current.blur())},[a]),E=f.useCallback(g=>{if(g.key==="Enter"){if(x>=0&&x<a.length){const m=a[x];u(m.label),j(m.value)}else if(x===-1&&a.length>0){const m=a[0];u(m.label),j(m.value)}r.current&&r.current.blur()}else g.key==="ArrowDown"?T(m=>Math.min(m+1,a.length-1)):g.key==="ArrowUp"&&T(m=>Math.max(m-1,-1))},[x,a,j]);f.useEffect(()=>{if(o){const g={SearchText:I,DictionaryUri:o.ifcClassification.location};i(He(g))}else i(ze([]))},[i,I,o]),f.useEffect(()=>{r.current&&r.current.focus()},[]),f.useEffect(()=>{if(l){if(l.count){const g=l.dictionary?.classes;g&&d(g.filter(m=>m.uri&&m.name).map(m=>({value:m.uri,label:m.name,synonyms:m.synonyms||[]})))}}else d([])},[l]),f.useEffect(()=>{i(c?W(c.value):W(null))},[i,c]);const A=f.useCallback(()=>{D(""),r.current&&r.current.focus(),h(void 0)},[D]),w=({options:g,search:m})=>{const V=m.toLowerCase().trim().split(" ");return g.filter(S=>{const C=S.label.toLowerCase().trim().split(" "),k=S.synonyms?.map(M=>M.toLowerCase().trim().split(" ")).flat()||[];return V.every(M=>C.some(N=>N.includes(M))||k.some(N=>N.includes(M)))})};return s.jsx(Fe,{label:`${n("searchMainDictionaryLabel")} ${o?o.ifcClassification.name:""}`,data:a,placeholder:"bSDD search...",value:p,onChange:D,onOptionSubmit:j,filter:w,onKeyDown:E,ref:r,style:{width:"100%"},rightSection:s.jsx(ne,{size:"sm",onMouseDown:g=>{g.preventDefault()},onClick:A,"aria-label":"Clear value"})})}const U=60.7969;let Q=0,X=0;function vt(){const{t}=L(),e=P(),{bsddSearchSave:i,bsddSearchCancel:n}=Ne(),o=v(ue),l=v(re),a=v($e),d=v(ce),r=v(Ue),c=v(te),[h,p]=f.useState(),[u,I]=f.useState(!1),[b,y]=f.useState(new Ge(Ze[Qe])),[x,T]=f.useState(U),[D,j]=f.useState("auto"),[E,A]=f.useState(!1),w=v(ae);f.useEffect(()=>{if(c&&c.length>0){const C=We(c);C&&(console.log("Setting mergedIfcEntity",C),e(_e(C)))}},[e,c]),f.useEffect(()=>{if(!w||!E)return;const C=w.classProperties||[];e(Ye({classProperties:C,languageCode:l}))},[w,E,l,e]),f.useEffect(()=>{if(!d||!o)return;const C=o.ifcClassification.location;d.hasAssociations?.forEach(k=>{if(k.type==="IfcClassificationReference"){const M=k;M.referencedSource?.location&&M.referencedSource.location===C&&(M.location&&e(W(M.location)),p({label:M.name,value:M.location}))}})},[o,d,e]),f.useEffect(()=>{r&&e(Ke(r))},[r,e]),f.useEffect(()=>{j(`${x*a.length+48}px`)},[a.length,x]);const g=C=>{const k=X+(C.clientY-Q)/a.length;T(k>U?k:U)},m=()=>{document.removeEventListener("mousemove",g),document.removeEventListener("mouseup",m)},V=C=>{Q=C.clientY,X=x,document.addEventListener("mousemove",g),document.addEventListener("mouseup",m)},S=C=>{A(C.includes("Propertysets"))};return s.jsxs(ie,{children:[s.jsx(R,{type:"hidden",name:"ifcType",id:"ifcType",value:""}),s.jsx(R,{type:"hidden",name:"name",id:"name",value:""}),s.jsx(R,{type:"hidden",name:"material",id:"material",value:""}),s.jsx(z,{mx:"md",mt:"lg",mb:"sm",children:s.jsx(yt,{api:b,defaultSelection:h})}),r?s.jsxs(s.Fragment,{children:[s.jsxs(O,{defaultValue:["Classifications"],multiple:!0,onChange:S,children:[s.jsxs(O.Item,{value:"Classifications",children:[s.jsx(O.Control,{children:s.jsx(J,{order:5,children:t("classificationsLabel")})}),s.jsx(O.Panel,{style:{height:D},children:s.jsx(at,{height:x,handleMouseDown:V})})]},"Classifications"),s.jsxs(O.Item,{value:"Propertysets",children:[s.jsx(O.Control,{children:s.jsx(J,{order:5,children:t("propertysetsLabel")})}),s.jsx(O.Panel,{children:s.jsx(bt,{mainDictionaryClassification:w,recursiveMode:u})})]},"Propertysets")]}),s.jsxs(z,{my:"sm",justify:"center",children:[s.jsx(et,{bsddSearchSave:i}),s.jsx(_,{fullWidth:!0,variant:"light",color:"gray",onClick:n,children:t("cancel")})]})]}):s.jsxs(Je,{mx:"md",title:t("noClassificationSelected"),mt:"xl",children:[t("classSearchInstruction"),s.jsx(qe,{h:"md"}),t("needHelp")," ",s.jsx("a",{href:"https://github.com/buildingsmart-community/bSDD-Revit-plugin/wiki",target:"_blank",rel:"noreferrer",children:t("checkDocumentation")})]})]})}export{vt as B};
