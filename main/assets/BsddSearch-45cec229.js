import{aG as T,aH as I,b3 as ee,b9 as de,ba as he,bb as me,bc as te,r as c,j as s,az as _,bd as pe,aY as ge,aZ as k,ag as z,be,a3 as Y,aU as xe,W as ne,P as se,u as L,bf as ve,bg as ye,b as H,bh as Ce,bi as ae,bj as Ie,B as oe,at as N,ay as Se,bk as je,bl as we,aE as le,ah as De,bm as Ve,av as R,au as Ee,bn as ie,bo as Me,bp as Oe,t as K,bq as Pe,br as re,bs as Ae,bt as ke,aO as ce,b0 as P,aB as Le,aL as ue,bu as Re,aD as Te,bv as Be,bw as He,bx as G,aF as ze,aJ as Fe,by as Ue,bz as $e,bA as Ne,bB as Ge,bC as We,b1 as q,aA as _e,S as Ye}from"./defaultSettings-92ecbefa.js";const Ke={test:"https://test.bsdd.buildingsmart.org",production:"https://api.bsdd.buildingsmart.org"},qe="production";function Je({bsddSearchSave:t}){const{t:e}=T();I(ee);const i=I(de),n=I(he),a=I(me),o=I(te);function l(x,d){return console.log("Creating bsddSearchSave data",o),o?{ifcData:pe(x,o),settings:n,propertyIsInstanceMap:d}:{ifcData:[],settings:n,propertyIsInstanceMap:d}}const f=c.useCallback(x=>{console.log("Sending bsddSearchSave data back to host",x),t(l(x,a)).then(d=>{console.log("Sent iFC data back to host",d)})},[t,a]),r=()=>{console.log(i),f(i)};return s.jsx(_,{color:"gray",fullWidth:!0,onClick:r,variant:"filled",children:e("apply")})}const J=25,Ze=25;function Z({height:t,options:e,label:i,value:n,setValue:a,placeholder:o="Search values",disabled:l}){const[f,r]=c.useState(""),[x,d]=c.useState(e.slice(0,J)),y=c.useRef(null),h=ge({onDropdownClose:()=>{h.resetSelectedOption(),h.focusTarget&&h.focusTarget()},onDropdownOpen:()=>{h.focusSearchInput&&h.searchRef.current&&h.focusSearchInput()}});c.useEffect(()=>{r(n?.label||"")},[n]),c.useEffect(()=>{const p=n===null?e.filter(m=>m?.label.toLowerCase().includes(f.toLowerCase().trim())||m?.value.toString().toLowerCase().includes(f.toLowerCase().trim())):e;d(p.slice(0,J))},[e,f,n]);const v=p=>{const{scrollTop:m,scrollHeight:M,clientHeight:j}=p.currentTarget,S=5;M-m<=j+S&&d(V=>{const E=V.length,b=e.filter(g=>g?.label.toLowerCase().includes(f.toLowerCase().trim())).slice(E,E+Ze);return[...V,...b]})},u=x.map(p=>s.jsx(k.Option,{value:p.value,active:n?.value===p.value,children:s.jsxs(z,{gap:"sm",children:[n?.value===p.value?s.jsx(be,{size:12}):null,s.jsx(Y,{fz:"sm",opacity:l?.6:1,children:p.label}),s.jsxs(Y,{fz:"xs",opacity:.6,children:["(",p.value,")"]})]})},p.value));return s.jsx("div",{style:{display:"flex",flexDirection:"column",height:"100%"},children:s.jsxs(k,{store:h,onOptionSubmit:p=>{if(!l){const m=e.find(j=>j.value===p),M=m&&n?.value!==m.value?m:null;a(M),h.closeDropdown()}},disabled:l,children:[s.jsx(k.Target,{children:s.jsx(xe,{rightSection:!l&&s.jsx(ne,{size:"sm",onMouseDown:p=>{p.preventDefault()},onClick:()=>{r(""),a(null)},"aria-label":"Clear value"}),label:i,value:n?`${n.label} (${n.value})`:f,onChange:p=>{l||(a(null),h.updateSelectedOptionIndex(),r(p.currentTarget.value))},onClick:()=>{l||h.openDropdown()},onBlur:()=>h.closeDropdown(),placeholder:l?"":o,disabled:l})}),t<80?s.jsx(k.Dropdown,{style:{maxHeight:"20em",overflowY:"auto"},ref:y,onScroll:v,children:s.jsx(k.Options,{children:u.length>0?u:s.jsx(k.Empty,{children:"Nothing found..."})})}):s.jsx(se,{withBorder:!0,my:"0.2em",style:{flexGrow:1,overflow:"auto",backgroundColor:l?"var(--mantine-color-gray-0)":"transparent",color:l?"var(--mantine-color-gray-6)":"inherit",pointerEvents:l?"none":"auto"},ref:y,onScroll:v,children:s.jsx(k.Options,{children:u.length>0?u:s.jsx(k.Empty,{children:"Nothing found..."})})})]})})}const Qe=(t,e,i)=>{if(!e||!e.value)return null;const n=i[t];return n?{type:"IfcClassificationReference",name:e.label,location:e.uri,identification:e.value,referencedSource:{type:"IfcClassification",name:n.name,location:n.uri,edition:n.version,editionDate:n.releaseDate}}:null},Xe=(t,e,i)=>{const n=Array.from(t.entries()).map(([a,o])=>Qe(a,o,e)).filter(a=>a!==null);n.length>0&&i(je(n))};function et({height:t,handleMouseDown:e}){const i=L(),{t:n}=T(),[a,o]=c.useState(new Map),[l,f]=c.useState(new Map),r=I(ve),x=I(ye),d=H(ee),y=H(Ce),h=H(ae),v=H(Ie);return c.useEffect(()=>{(async()=>{const m=Array.from(r.entries()).map(async([D,V])=>{if(h&&D===v){const{code:C,name:O,uri:A}=h;return[D,[{value:C,label:O,uri:A}]]}let E=[];const b=y[D],g=h?.classRelations?.map(C=>C.relatedClassUri),w=b?.filter(C=>g?.includes(C.uri));if(w&&w.length>0)E=w.map(C=>({value:C.code,label:C.name,uri:C.uri}));else try{E=(await i(we(D)).unwrap())?.map(O=>({value:O.code,label:O.name||"",uri:O.uri}))??[]}catch(C){console.error("Failed to fetch dictionary classes for",D,C),E=[]}return[D,E]}),M=await Promise.all(m),j=new Map(M);o(j);const S=new Map;j.forEach((D,V)=>{if(D.length===1)S.set(V,D[0]);else if(V in x){const E=x[V];if(E.length===1){const b=E[0];if(D.some(w=>w.value===b.identification)){const w={label:b.name||"",value:b.identification||"",uri:b.location||""};S.set(V,w)}}}}),f(S)})()},[r,y,i,x,h,v]),c.useEffect(()=>{Xe(l,d,i)},[d,i,l]),s.jsxs(se,{style:{height:`${t}px`,position:"relative"},children:[Array.from(r.entries()).map(([u,p])=>{const m=u===v,M=u===h?.dictionaryUri;return m?s.jsx(Z,{height:t,label:p.name,options:a.get(u)||[],value:l.get(u)||null,setValue:j=>{const S=new Map(l);S.set(u,j),f(S)},placeholder:n("classifications.searchClassesPlaceholder"),disabled:a.get(u)?.length===1},u):M?null:s.jsx(Z,{height:t,label:p.name,options:a.get(u)||[],value:l.get(u)||null,setValue:j=>{const S=new Map(l);S.set(u,j),f(S)},placeholder:n("classifications.searchClassesPlaceholder"),disabled:a.get(u)?.length===1},u)}),s.jsx(oe,{onMouseDown:e,style:{marginTop:"4px"},children:s.jsx(N,{label:n("classifications.dragResize"),withArrow:!0,children:s.jsx(_,{fullWidth:!0,variant:"subtle",size:"sm",color:"gray","aria-label":n("classifications.dragResize"),children:s.jsx(Se,{})})})})]})}function tt(t,e){return t==null||e==null?null:t.toLowerCase()!==e.toLowerCase()?`(${e})`:null}function nt({label:t,description:e,value:i,setValue:n,disabled:a,inputContainer:o}){const{t:l}=T(),[f,r]=c.useState(!1),[x,d]=c.useState(!0),y=()=>l(x?"checkbox.indeterminate":f?"checkbox.true":"checkbox.false"),h=u=>{u.target.indeterminate=!1,n(u.target.checked)};c.useEffect(()=>{i===!0?(r(!0),d(!1)):i===!1?(r(!1),d(!1)):i===void 0&&(r(!1),d(!0))},[i]);const v=s.jsx(le,{description:y(),checked:f,indeterminate:x,type:"checkbox",onChange:u=>h(u),disabled:a});return s.jsx(De.Wrapper,{label:t,description:e,children:o?o(v):v})}const st=(t,e,i,n)=>{const a=t.map(o=>{if(o.name===e){const l=o.hasProperties.map(f=>f.name===i?{...f,...n}:f);return l.some(f=>f.name===i)||l.push({name:i,...n}),{...o,hasProperties:l}}return o});return a.some(o=>o.name===e)||a.push({type:"IfcPropertySet",name:e,hasProperties:[{name:i,...n}]}),a},at=t=>t.type==="IfcPropertySingleValue",ot=t=>t.type==="IfcPropertyEnumeratedValue",lt=t=>t.enumerationValues?.[0]?.value||void 0,it=t=>t.nominalValue?.value||void 0,rt=t=>at(t)?it(t).value:ot(t)?lt(t).value:void 0,ct=({propertySet:t,property:e,propertyNaturalLanguageName:i,isInstance:n,inputContainer:a})=>{const o=L(),l=I(Ve),[f,r]=c.useState(),x=i?.trim()?i:e.name,d=tt(x,e.name);c.useEffect(()=>{e.type==="IfcPropertySingleValue"?r(e.nominalValue?.type==="IfcBoolean"?e.nominalValue?.value??!1:e.nominalValue?.value??""):e.type==="IfcPropertyEnumeratedValue"&&r(e.enumerationValues?.[0]?.value??"")},[e]);const y=u=>{if(r(u),l&&t.name){let p;"nominalValue"in e?p={nominalValue:{...e.nominalValue,value:u}}:"enumerationReference"in e?p={enumerationValues:(e.enumerationReference?.enumerationValues||[]).filter(S=>S.value===u)}:p={value:u};const m=st(l,t.name,e.name,p);o(ie(m)),t.name==="Attributes"&&(e.name==="ObjectType"?o(Me(u)):e.name==="Description"&&o(Oe(u)))}},h=u=>{y(u)};return(()=>{switch(e.type){case"IfcPropertySingleValue":return e.nominalValue?.type==="IfcBoolean"?s.jsx(nt,{label:x,description:d,disabled:n,inputContainer:a,value:f,setValue:m=>h(m)}):s.jsx(R,{label:x,description:d,placeholder:e.nominalValue?.value??"",value:f,disabled:n,inputContainer:a,onChange:m=>h(m.target.value),onBlur:m=>y(m.target.value)});case"IfcPropertyEnumeratedValue":const u=e.enumerationReference?.enumerationValues||[],p=u.length===1;return s.jsx(Ee,{label:x,description:d,value:f,inputContainer:a,disabled:n||p,clearable:!p,onChange:m=>h(m),data:u.map(m=>({value:m.value,label:m.value}))});default:return s.jsx(R,{placeholder:e.name,defaultValue:rt(e),disabled:n,inputContainer:a,onChange:m=>h(m.target.value),onBlur:m=>y(m.target.value)})}})()},ut=["Name","Description","ObjectType"],ft=(t,e,i)=>{if(e==="Attributes"&&!ut.includes(i))return!0;const n=`${e}/${i}`;return t[n]||t[i]||!1};function dt({propertySet:t,property:e,propertyNaturalLanguageName:i}){const n=L(),a=I(y=>y.ifcData.propertyIsInstanceMap),o=I(y=>y.ifcData.savedPropertyIsInstanceMap),l=t.name!=="Attributes",f=`${t.name}/${e.name}`,r=o.hasOwnProperty(f)||o.hasOwnProperty(e.name),x=ft(a,t.name||"",e.name),d=y=>l&&x?s.jsx(N,{label:K("bsddSearch.property.tooltipEditInstance"),withArrow:!0,children:y}):y;return s.jsxs(z,{children:[s.jsx("div",{style:{flex:1},children:s.jsx(ct,{propertySet:t,property:e,propertyNaturalLanguageName:i,isInstance:x,inputContainer:d})}),l&&s.jsx(N,{label:K("bsddSearch.property.setAsInstanceCheckboxTooltip"),withArrow:!0,children:s.jsx(le,{style:{marginTop:"2rem"},disabled:r,checked:x,onChange:y=>{r||n(Pe({propertyName:f,value:y.currentTarget.checked}))}})})]})}const ht={Boolean:"IfcBoolean",Character:"IfcText",Integer:"IfcInteger",Real:"IfcReal",String:"IfcText",Time:"IfcDateTime"};function F(t,e){const i=t&&ht[t]||"default";let n;return t==="Boolean"&&typeof e=="string"?e.toUpperCase()==="TRUE"?n=!0:e.toUpperCase()==="FALSE"?n=!1:n=void 0:n=e,{type:i,value:n}}function W(t,e){return t&&t===e?.type?e:F(t,e?.value)}function fe(t,e,i){let n;if(t&&t.isDefinedBy){let a=t.isDefinedBy.find(o=>o.name===e);if(a&&(n=a.hasProperties.find(o=>o.name===i)),n)return n;if(a=t.isDefinedBy.find(o=>o.name===""),a)return a.hasProperties.find(o=>o.name===i)}return n}function mt(t,e){const i=e?.nominalValue?.value??null;return F(t,i)}function pt(t,e,i){if(e){if(e.type==="IfcPropertyEnumeratedValue"){const n=i.find(a=>e.enumerationValues?e.enumerationValues.some(o=>o.value===a.value):!1);return n?W(t,n):null}if("nominalValue"in e&&e.nominalValue){const n=i.find(a=>a.value===e.nominalValue?.value);return n?W(t,n):null}}return null}function gt(t,e,i,n){const a=t.allowedValues?.map(r=>F(t.dataType,r.value))||[],o={type:"IfcPropertyEnumeratedValue",name:e,enumerationReference:{type:"IfcPropertyEnumeration",name:e,enumerationValues:a}};t.propertyUri&&(o.specification=t.propertyUri);let l=null,f=[];if(t.allowedValues?f=t.allowedValues:t.predefinedValue&&(f=[t.predefinedValue]),f.length===1)l=W(t.dataType,f[0]);else if(n){const r=fe(n,i,e);l=pt(t.dataType,r,a)}return l!==null&&(o.enumerationValues=[l]),o}function bt(t,e,i,n){const a={type:"IfcPropertySingleValue",name:e};t.propertyUri&&(a.specification=t.propertyUri);let o=null;if(t.predefinedValue)o=F(t.dataType,t.predefinedValue);else if(n){const l=fe(n,i,e);o=mt(t.dataType,l)}return o!==null&&(a.nominalValue=o),a}function xt(t,e,i){const{propertyCode:n}=t,a=n||"unknown",o=t.allowedValues?gt(t,a,e,i):bt(t,a,e,i);return o.specification=t.propertyUri||"",o}function vt({mainDictionaryClassification:t,recursiveMode:e}){const i=L(),n=I(re);I(Ae);const a=I(ke),o=I(ce),[l,f]=c.useState({}),[r,x]=c.useState(null);return c.useEffect(()=>{if(!t)return;const d={};[t].forEach(h=>{h.classProperties?.forEach(v=>{if(!v||!v.propertySet)return;const u=v.propertySet||h.name;d[u]||(d[u]={type:"IfcPropertySet",name:u,hasProperties:[]}),d[u].hasProperties.push(xt(v,u,n))})}),i(ie(Object.values(d))),x(Object.values(d))},[i,n,t]),c.useEffect(()=>{if(!t)return;const d={};[t].forEach(h=>{h.classProperties?.forEach(v=>{v&&v.propertyUri&&(o&&a&&a[o]&&a[o][v.propertyUri]?d[v.propertyUri]=a[o][v.propertyUri]||"":d[v.propertyUri]=v.name)})}),f(d)},[t,e,n,a,o]),s.jsx("div",{children:c.Children.toArray(r?.map((d,y)=>s.jsx(P,{variant:"contained",radius:"xs",children:s.jsxs(P.Item,{value:d.name||"Unknown",style:y!==0?{borderTopWidth:0}:{},children:[s.jsx(P.Control,{children:d.name}),s.jsx(P.Panel,{children:s.jsx(Le,{children:c.Children.toArray(d.hasProperties.map(h=>{const v=h.specification?l[h.specification]:"";return s.jsx(dt,{propertySet:d,property:h,propertyNaturalLanguageName:v})}))})})]},d.name||"Unknown")})))})}function yt({api:t,defaultSelection:e}){const i=L(),{t:n}=T(),a=I(ue),o=I(Re),[l,f]=c.useState([]),r=c.useRef(null),[x,d]=c.useState(void 0),[y,h]=c.useState(""),[v]=Te(y,300),[u,p]=c.useState(!1),[m,M]=c.useState(-1);c.useEffect(()=>{e&&!u&&l.length>0&&(l.find(g=>g.value===e.value)?(d(e),h(e.label),r.current&&r.current.blur()):(h(e.label),r.current&&(r.current.focus(),r.current.setSelectionRange(0,r.current.value.length))),p(!0))},[e,u,l]);const j=c.useCallback(b=>{h(b),M(-1);const g=l.filter(w=>w.label.toLowerCase().includes(b.toLowerCase().trim())||w.synonyms?.some(C=>C.toLowerCase().includes(b.toLowerCase().trim())));f(g)},[l]),S=c.useCallback(b=>{const g=l.find(w=>w.value===b);g&&(d(g),r.current&&r.current.blur())},[l]),D=c.useCallback(b=>{if(b.key==="Enter"){if(m>=0&&m<l.length){const g=l[m];h(g.label),S(g.value)}else if(m===-1&&l.length>0){const g=l[0];h(g.label),S(g.value)}r.current&&r.current.blur()}else b.key==="ArrowDown"?M(g=>Math.min(g+1,l.length-1)):b.key==="ArrowUp"&&M(g=>Math.max(g-1,-1))},[m,l,S]);c.useEffect(()=>{if(a){const b={SearchText:v,DictionaryUri:a.ifcClassification.location};i(Be(b))}else i(He([]))},[i,v,a]),c.useEffect(()=>{r.current&&r.current.focus()},[]),c.useEffect(()=>{if(o){if(o.count){const b=o.dictionary?.classes;b&&f(b.filter(g=>g.uri&&g.name).map(g=>({value:g.uri,label:g.name,synonyms:g.synonyms||[]})))}}else f([])},[o]),c.useEffect(()=>{i(x?G(x.value):G(null))},[i,x]);const V=c.useCallback(()=>{j(""),r.current&&r.current.focus(),d(void 0)},[j]),E=({options:b,search:g})=>{const w=g.toLowerCase().trim().split(" ");return b.filter(C=>{const O=C.label.toLowerCase().trim().split(" "),A=C.synonyms?.map(B=>B.toLowerCase().trim().split(" ")).flat()||[];return w.every(B=>O.some(U=>U.includes(B))||A.some(U=>U.includes(B)))})};return s.jsx(ze,{label:`${n("searchMainDictionaryLabel")} ${a?a.ifcClassification.name:""}`,data:l,placeholder:"bSDD search...",value:y,onChange:j,onOptionSubmit:S,filter:E,onKeyDown:D,ref:r,style:{width:"100%"},rightSection:s.jsx(ne,{size:"sm",onMouseDown:b=>{b.preventDefault()},onClick:V,"aria-label":"Clear value"})})}const $=60.7969;let Q=0,X=0;function It(){const{t}=T(),e=L(),{bsddSearchSave:i,bsddSearchCancel:n}=Fe(),a=I(ue),o=I(ce),l=I(Ue),f=I(re),r=I($e);I(te);const[x,d]=c.useState(),[y,h]=c.useState(!1),[v,u]=c.useState(new Ne(Ke[qe])),[p,m]=c.useState($),[M,j]=c.useState("auto"),[S,D]=c.useState(!1),V=I(ae);c.useEffect(()=>{if(!V||!S)return;const C=V.classProperties||[];e(Ge({classProperties:C,languageCode:o}))},[V,S,o,e]),c.useEffect(()=>{if(!f||!a)return;const C=a.ifcClassification.location;f.hasAssociations?.forEach(O=>{if(O.type==="IfcClassificationReference"){const A=O;A.referencedSource?.location&&A.referencedSource.location===C&&(A.location&&e(G(A.location)),d({label:A.name,value:A.location}))}})},[a,f,e]),c.useEffect(()=>{r&&e(We(r))},[r,e]),c.useEffect(()=>{j(`${p*l.length+48}px`)},[l.length,p]);const E=C=>{const O=X+(C.clientY-Q)/l.length;m(O>$?O:$)},b=()=>{document.removeEventListener("mousemove",E),document.removeEventListener("mouseup",b)},g=C=>{Q=C.clientY,X=p,document.addEventListener("mousemove",E),document.addEventListener("mouseup",b)},w=C=>{D(C.includes("Propertysets"))};return s.jsxs(oe,{children:[s.jsx(R,{type:"hidden",name:"ifcType",id:"ifcType",value:""}),s.jsx(R,{type:"hidden",name:"name",id:"name",value:""}),s.jsx(R,{type:"hidden",name:"material",id:"material",value:""}),s.jsx(z,{mx:"md",mt:"lg",mb:"sm",children:s.jsx(yt,{api:v,defaultSelection:x})}),r?s.jsxs(s.Fragment,{children:[s.jsxs(P,{defaultValue:["Classifications"],multiple:!0,onChange:w,children:[s.jsxs(P.Item,{value:"Classifications",children:[s.jsx(P.Control,{children:s.jsx(q,{order:5,children:t("classificationsLabel")})}),s.jsx(P.Panel,{style:{height:M},children:s.jsx(et,{height:p,handleMouseDown:g})})]},"Classifications"),s.jsxs(P.Item,{value:"Propertysets",children:[s.jsx(P.Control,{children:s.jsx(q,{order:5,children:t("propertysetsLabel")})}),s.jsx(P.Panel,{children:s.jsx(vt,{mainDictionaryClassification:V,recursiveMode:y})})]},"Propertysets")]}),s.jsxs(z,{my:"sm",justify:"center",children:[s.jsx(Je,{bsddSearchSave:i}),s.jsx(_,{fullWidth:!0,variant:"light",color:"gray",onClick:n,children:t("cancel")})]})]}):s.jsxs(_e,{mx:"md",title:t("noClassificationSelected"),mt:"xl",children:[t("classSearchInstruction"),s.jsx(Ye,{h:"md"}),t("needHelp")," ",s.jsx("a",{href:"https://github.com/buildingsmart-community/bSDD-Revit-plugin/wiki",target:"_blank",rel:"noreferrer",children:t("checkDocumentation")})]})]})}export{It as B};
