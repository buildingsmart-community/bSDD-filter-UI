import{aG as R,aH as C,b3 as X,b9 as ue,ba as fe,bb as de,bc as ee,r as u,j as n,az as W,bd as he,aY as pe,aZ as T,ag as H,be as me,a3 as _,aU as ge,W as te,P as ne,u as L,bf as be,bg as xe,b as N,bh as ye,bi as se,bj as ve,B as ae,at as F,ay as Ce,bk as Ie,bl as Se,aE as oe,ah as je,bm as we,av as P,au as De,bn as ie,bo as Ee,bp as Me,t as Y,bq as Ve,br as re,bs as Oe,bt as Ae,aO as le,b0 as A,aB as ke,aL as ce,bu as Te,aD as Le,bv as Pe,bw as Re,bx as G,aF as Be,aJ as Ne,by as He,bz as ze,bA as $e,bB as Ue,bC as Fe,b1 as K,aA as Ge,S as We}from"./defaultSettings-4627686c.js";const _e={test:"https://test.bsdd.buildingsmart.org",production:"https://api.bsdd.buildingsmart.org"},Ye="production";function Ke({bsddSearchSave:t}){const{t:e}=R();C(X);const l=C(ue),s=C(fe),i=C(de),r=C(ee);function a(f,b){return console.log("Creating bsddSearchSave data",r),r?{ifcData:he(f,r),settings:s,propertyIsInstanceMap:b}:{ifcData:[],settings:s,propertyIsInstanceMap:b}}const p=u.useCallback(f=>{console.log("Sending bsddSearchSave data back to host",f),t(a(f,i)).then(b=>{console.log("Sent iFC data back to host",b)})},[t,i]),c=()=>{console.log(l),p(l)};return n.jsx(W,{color:"gray",fullWidth:!0,onClick:c,variant:"filled",children:e("apply")})}const q=25,qe=25;function J({height:t,options:e,label:l,value:s,setValue:i,placeholder:r="Search values",disabled:a}){const[p,c]=u.useState(""),[f,b]=u.useState(e.slice(0,q)),d=u.useRef(null),o=pe({onDropdownClose:()=>{o.resetSelectedOption(),o.focusTarget&&o.focusTarget()},onDropdownOpen:()=>{o.focusSearchInput&&o.focusSearchInput()}});u.useEffect(()=>{c(s?.label||"")},[s]),u.useEffect(()=>{const y=s===null?e.filter(I=>I?.label.toLowerCase().includes(p.toLowerCase().trim())||I?.value.toString().toLowerCase().includes(p.toLowerCase().trim())):e;b(y.slice(0,q))},[e,p,s]);const x=y=>{const{scrollTop:I,scrollHeight:V,clientHeight:j}=y.currentTarget,S=5;V-I<=j+S&&b(E=>{const M=E.length,g=e.filter(m=>m?.label.toLowerCase().includes(p.toLowerCase().trim())).slice(M,M+qe);return[...E,...g]})},h=f.map(y=>n.jsx(T.Option,{value:y.value,active:s?.value===y.value,children:n.jsxs(H,{gap:"sm",children:[s?.value===y.value?n.jsx(me,{size:12}):null,n.jsx(_,{fz:"sm",opacity:a?.6:1,children:y.label}),n.jsxs(_,{fz:"xs",opacity:.6,children:["(",y.value,")"]})]})},y.value));return n.jsx("div",{style:{display:"flex",flexDirection:"column",height:"100%"},children:n.jsxs(T,{store:o,onOptionSubmit:y=>{if(!a){const I=e.find(j=>j.value===y),V=I&&s?.value!==I.value?I:null;i(V),o.closeDropdown()}},disabled:a,children:[n.jsx(T.Target,{children:n.jsx(ge,{rightSection:!a&&n.jsx(te,{size:"sm",onMouseDown:y=>{y.preventDefault()},onClick:()=>{c(""),i(null)},"aria-label":"Clear value"}),label:l,value:s?`${s.label} (${s.value})`:p,onChange:y=>{a||(i(null),o.updateSelectedOptionIndex(),c(y.currentTarget.value))},onClick:()=>{a||o.openDropdown()},onBlur:()=>o.closeDropdown(),placeholder:a?"":r,disabled:a})}),t<80?n.jsx(T.Dropdown,{style:{maxHeight:"20em",overflowY:"auto"},ref:d,onScroll:x,children:n.jsx(T.Options,{children:h.length>0?h:n.jsx(T.Empty,{children:"Nothing found..."})})}):n.jsx(ne,{withBorder:!0,my:"0.2em",style:{flexGrow:1,overflow:"auto",backgroundColor:a?"var(--mantine-color-gray-0)":"transparent",color:a?"var(--mantine-color-gray-6)":"inherit",pointerEvents:a?"none":"auto"},ref:d,onScroll:x,children:n.jsx(T.Options,{children:h.length>0?h:n.jsx(T.Empty,{children:"Nothing found..."})})})]})})}const Je=(t,e,l)=>{if(!e||!e.value)return null;const s=l[t];return s?{type:"IfcClassificationReference",name:e.label,location:e.uri,identification:e.value,referencedSource:{type:"IfcClassification",name:s.name,location:s.uri,edition:s.version,editionDate:s.releaseDate}}:null},Ze=(t,e,l)=>{const s=Array.from(t.entries()).map(([i,r])=>Je(i,r,e)).filter(i=>i!==null);s.length>0&&l(Ie(s))};function Qe({height:t,handleMouseDown:e}){const l=L(),{t:s}=R(),[i,r]=u.useState(new Map),[a,p]=u.useState(new Map),c=C(be),f=C(xe),b=N(X),d=N(ye),o=N(se),x=N(ve);return u.useEffect(()=>{(async()=>{const I=Array.from(c.entries()).map(async([D,E])=>{if(o&&D===x){const{code:v,name:O,uri:k}=o;return[D,[{value:v,label:O,uri:k}]]}let M=[];const g=d[D],m=o?.classRelations?.map(v=>v.relatedClassUri),w=g?.filter(v=>m?.includes(v.uri));if(w&&w.length>0)M=w.map(v=>({value:v.code,label:v.name,uri:v.uri}));else try{M=(await l(Se(D)).unwrap())?.map(O=>({value:O.code,label:O.name||"",uri:O.uri}))??[]}catch(v){console.error("Failed to fetch dictionary classes for",D,v),M=[]}return[D,M]}),V=await Promise.all(I),j=new Map(V);r(j);const S=new Map;j.forEach((D,E)=>{if(D.length===1)S.set(E,D[0]);else if(E in f){const M=f[E];if(M.length===1){const g=M[0];if(D.some(w=>w.value===g.identification)){const w={label:g.name||"",value:g.identification||"",uri:g.location||""};S.set(E,w)}}}}),p(S)})()},[c,d,l,f,o,x]),u.useEffect(()=>{Ze(a,b,l)},[b,l,a]),n.jsxs(ne,{style:{height:`${t}px`,position:"relative"},children:[Array.from(c.entries()).map(([h,y])=>{const I=h===x,V=h===o?.dictionaryUri;return I?n.jsx(J,{height:t,label:y.name,options:i.get(h)||[],value:a.get(h)||null,setValue:j=>{const S=new Map(a);S.set(h,j),p(S)},placeholder:s("classifications.searchClassesPlaceholder"),disabled:i.get(h)?.length===1},h):V?null:n.jsx(J,{height:t,label:y.name,options:i.get(h)||[],value:a.get(h)||null,setValue:j=>{const S=new Map(a);S.set(h,j),p(S)},placeholder:s("classifications.searchClassesPlaceholder"),disabled:i.get(h)?.length===1},h)}),n.jsx(ae,{onMouseDown:e,style:{marginTop:"4px"},children:n.jsx(F,{label:s("classifications.dragResize"),withArrow:!0,children:n.jsx(W,{fullWidth:!0,variant:"subtle",size:"sm",color:"gray","aria-label":s("classifications.dragResize"),children:n.jsx(Ce,{})})})})]})}function Xe(t,e){return t==null||e==null?null:t.toLowerCase()!==e.toLowerCase()?`(${e})`:null}function et({label:t,description:e,value:l,setValue:s,disabled:i,inputContainer:r}){const{t:a}=R(),[p,c]=u.useState(!1),[f,b]=u.useState(!0),d=()=>a(f?"checkbox.indeterminate":p?"checkbox.true":"checkbox.false"),o=h=>{h.target.indeterminate=!1,s(h.target.checked)};u.useEffect(()=>{l===!0?(c(!0),b(!1)):l===!1?(c(!1),b(!1)):l===void 0&&(c(!1),b(!0))},[l]);const x=n.jsx(oe,{description:d(),checked:p,indeterminate:f,type:"checkbox",onChange:h=>o(h),disabled:i});return n.jsx(je.Wrapper,{label:t,description:e,children:r?r(x):x})}const tt=(t,e,l,s)=>t.map(i=>{if(i.name===e){const r=i.hasProperties.map(a=>a.name===l?{...a,...s}:a);return{...i,hasProperties:r}}return i}),nt=({propertySet:t,property:e,propertyNaturalLanguageName:l,isInstance:s,inputContainer:i})=>{const r=L(),a=C(we),p=l?.trim()?l:e.name,c=Xe(p,e.name),f=e.type==="IfcPropertySingleValue"?e.nominalValue?.value||void 0:e.type==="IfcPropertyEnumeratedValue"&&e.enumerationValues?.[0]?.value||void 0,b=o=>{if(a&&t.name)if(t.name!=="Attributes"){let x;"nominalValue"in e?x={nominalValue:{...e.nominalValue,value:o}}:"enumerationValues"in e?x={enumerationValues:[{value:o}]}:x={value:o};const h=tt(a,t.name,e.name,x);r(ie(Object.values(h)))}else e.name==="ObjectType"?r(Ee(o)):e.name==="Description"&&r(Me(o))},d=o=>{b(o)};switch(e.type){case"IfcPropertySingleValue":return e.nominalValue?.type==="IfcBoolean"?n.jsx(et,{label:p,description:c,disabled:s,inputContainer:i,value:e.nominalValue?.value??!1,setValue:o=>d(o)}):n.jsx(P,{label:p,description:c,placeholder:e.nominalValue?.value??"",value:e.nominalValue?.value??"",disabled:s,inputContainer:i,onChange:o=>d(o.target.value),onBlur:o=>b(o.target.value)});case"IfcPropertyEnumeratedValue":{const o=e.enumerationValues?.[0]?.value??"",x=e.enumerationReference?.enumerationValues||[];return n.jsx(De,{label:p,description:c,value:o,inputContainer:i,disabled:s||e.enumerationReference?.enumerationValues?.length===1,clearable:!0,onChange:h=>d(h),data:x.map(h=>({value:h.value,label:h.value}))})}default:return n.jsx(P,{placeholder:e.name,defaultValue:f,disabled:s,inputContainer:i,onChange:o=>d(o.target.value),onBlur:o=>b(o.target.value)})}},st=["Name","Description","ObjectType"],at=(t,e,l)=>{if(e==="Attributes"&&!st.includes(l))return!0;const s=`${e}/${l}`;return t[s]||t[l]||!1};function ot({propertySet:t,property:e,propertyNaturalLanguageName:l}){const s=L(),i=C(d=>d.ifcData.propertyIsInstanceMap),r=C(d=>d.ifcData.savedPropertyIsInstanceMap),a=t.name!=="Attributes",p=`${t.name}/${e.name}`,c=r.hasOwnProperty(p)||r.hasOwnProperty(e.name),f=at(i,t.name||"",e.name),b=d=>a&&f?n.jsx(F,{label:Y("bsddSearch.property.tooltipEditInstance"),withArrow:!0,children:d}):d;return n.jsxs(H,{children:[n.jsx("div",{style:{flex:1},children:n.jsx(nt,{propertySet:t,property:e,propertyNaturalLanguageName:l,isInstance:f,inputContainer:b})}),a&&n.jsx(F,{label:Y("bsddSearch.property.setAsInstanceCheckboxTooltip"),withArrow:!0,children:n.jsx(oe,{style:{marginTop:"2rem"},disabled:c,checked:f,onChange:d=>{c||s(Ve({propertyName:p,value:d.currentTarget.checked}))}})})]})}const it={Boolean:"IfcBoolean",Character:"IfcText",Integer:"IfcInteger",Real:"IfcReal",String:"IfcText",Time:"IfcDateTime"};function z(t,e){const l=t&&it[t]||"default";let s;return t==="Boolean"&&typeof e=="string"?e.toUpperCase()==="TRUE"?s=!0:e.toUpperCase()==="FALSE"?s=!1:s=void 0:s=e,{type:l,value:s}}function rt(t,e,l){let s;if(t&&t.isDefinedBy){let i=t.isDefinedBy.find(r=>r.name===e);if(i&&(s=i.hasProperties.find(r=>r.name===l)),s)return s;if(i=t.isDefinedBy.find(r=>r.name===""),i)return i.hasProperties.find(r=>r.name===l)}return s}function lt(t,e,l,s){const r=rt(e,l,s)?.nominalValue?.value??null;return z(t,r)}function ct(t,e,l,s){const i=t.allowedValues?.map(a=>z(t.dataType,a.value))||[],r={type:"IfcPropertyEnumeratedValue",name:e,enumerationReference:{type:"IfcPropertyEnumeration",name:e,enumerationValues:i}};return t.propertyUri&&(r.specification=t.propertyUri),r.enumerationValues=t.predefinedValue?[z(t.dataType,t.predefinedValue)]:null,r}function ut(t,e,l,s){const i={type:"IfcPropertySingleValue",name:e,specification:t.propertyUri||""},r=t.predefinedValue?z(t.dataType,t.predefinedValue):lt(t.dataType,s,l,e);return r!==null&&(i.nominalValue=r),i}function ft(t,e,l){const{propertyCode:s}=t,i=s||"unknown",r=t.allowedValues?ct(t,i):ut(t,i,e,l);return r.specification=t.propertyUri||"",r}function dt({mainDictionaryClassification:t,recursiveMode:e}){const l=L(),s=C(re),i=C(Oe),r=C(Ae),a=C(le),[p,c]=u.useState({});return u.useEffect(()=>{if(!t)return;const f={};[t].forEach(d=>{d.classProperties?.forEach(o=>{if(!o||!o.propertySet)return;const x=o.propertySet||d.name;f[x]||(f[x]={type:"IfcPropertySet",name:x,hasProperties:[]}),s&&f[x].hasProperties.push(ft(o,x,s))})}),l(ie(Object.values(f)))},[l,s,t]),u.useEffect(()=>{if(!t)return;const f={};[t].forEach(d=>{d.classProperties?.forEach(o=>{o&&o.propertyUri&&(a&&r&&r[a]&&r[a][o.propertyUri]?f[o.propertyUri]=r[a][o.propertyUri]||"":f[o.propertyUri]=o.name)})}),c(f)},[t,e,s,r,a]),n.jsx("div",{children:u.Children.toArray(i?.map((f,b)=>n.jsx(A,{variant:"contained",radius:"xs",children:n.jsxs(A.Item,{value:f.name||"Unknown",style:b!==0?{borderTopWidth:0}:{},children:[n.jsx(A.Control,{children:f.name}),n.jsx(A.Panel,{children:n.jsx(ke,{children:u.Children.toArray(f.hasProperties.map(d=>{const o=d.specification?p[d.specification]:"";return n.jsx(ot,{propertySet:f,property:d,propertyNaturalLanguageName:o})}))})})]},f.name||"Unknown")})))})}function ht({api:t,defaultSelection:e}){const l=L(),{t:s}=R(),i=C(ce),r=C(Te),[a,p]=u.useState([]),c=u.useRef(null),[f,b]=u.useState(void 0),[d,o]=u.useState(""),[x]=Le(d,300),[h,y]=u.useState(!1),[I,V]=u.useState(-1);u.useEffect(()=>{e&&!h&&a.length>0&&(a.find(m=>m.value===e.value)?(b(e),o(e.label),c.current&&c.current.blur()):(o(e.label),c.current&&(c.current.focus(),c.current.setSelectionRange(0,c.current.value.length))),y(!0))},[e,h,a]);const j=u.useCallback(g=>{o(g),V(-1);const m=a.filter(w=>w.label.toLowerCase().includes(g.toLowerCase().trim())||w.synonyms?.some(v=>v.toLowerCase().includes(g.toLowerCase().trim())));p(m)},[a]),S=u.useCallback(g=>{const m=a.find(w=>w.value===g);m&&(b(m),c.current&&c.current.blur())},[a]),D=u.useCallback(g=>{if(g.key==="Enter"){if(I>=0&&I<a.length){const m=a[I];o(m.label),S(m.value)}else if(I===-1&&a.length>0){const m=a[0];o(m.label),S(m.value)}c.current&&c.current.blur()}else g.key==="ArrowDown"?V(m=>Math.min(m+1,a.length-1)):g.key==="ArrowUp"&&V(m=>Math.max(m-1,-1))},[I,a,S]);u.useEffect(()=>{if(i){const g={SearchText:x,DictionaryUri:i.ifcClassification.location};l(Pe(g))}else l(Re([]))},[l,x,i]),u.useEffect(()=>{c.current&&c.current.focus()},[]),u.useEffect(()=>{if(r){if(r.count){const g=r.dictionary?.classes;g&&p(g.filter(m=>m.uri&&m.name).map(m=>({value:m.uri,label:m.name,synonyms:m.synonyms||[]})))}}else p([])},[r]),u.useEffect(()=>{l(f?G(f.value):G(null))},[l,f]);const E=u.useCallback(()=>{j(""),c.current&&c.current.focus(),b(void 0)},[j]),M=({options:g,search:m})=>{const w=m.toLowerCase().trim().split(" ");return g.filter(v=>{const O=v.label.toLowerCase().trim().split(" "),k=v.synonyms?.map(B=>B.toLowerCase().trim().split(" ")).flat()||[];return w.every(B=>O.some($=>$.includes(B))||k.some($=>$.includes(B)))})};return n.jsx(Be,{label:`${s("searchMainDictionaryLabel")} ${i?i.ifcClassification.name:""}`,data:a,placeholder:"bSDD search...",value:d,onChange:j,onOptionSubmit:S,filter:M,onKeyDown:D,ref:c,style:{width:"100%"},rightSection:n.jsx(te,{size:"sm",onMouseDown:g=>{g.preventDefault()},onClick:E,"aria-label":"Clear value"})})}const U=60.7969;let Z=0,Q=0;function mt(){const{t}=R(),e=L(),{bsddSearchSave:l,bsddSearchCancel:s}=Ne(),i=C(ce),r=C(le),a=C(He),p=C(re),c=C(ze);C(ee);const[f,b]=u.useState(),[d,o]=u.useState(!1),[x,h]=u.useState(new $e(_e[Ye])),[y,I]=u.useState(U),[V,j]=u.useState("auto"),[S,D]=u.useState(!1),E=C(se);u.useEffect(()=>{if(!E||!S)return;const v=E.classProperties||[];e(Ue({classProperties:v,languageCode:r}))},[E,S,r,e]),u.useEffect(()=>{if(!p||!i)return;const v=i.ifcClassification.location;p.hasAssociations?.forEach(O=>{if(O.type==="IfcClassificationReference"){const k=O;k.referencedSource?.location&&k.referencedSource.location===v&&(k.location&&e(G(k.location)),b({label:k.name,value:k.location}))}})},[i,p,e]),u.useEffect(()=>{c&&e(Fe(c))},[c,e]),u.useEffect(()=>{j(`${y*a.length+48}px`)},[a.length,y]);const M=v=>{const O=Q+(v.clientY-Z)/a.length;I(O>U?O:U)},g=()=>{document.removeEventListener("mousemove",M),document.removeEventListener("mouseup",g)},m=v=>{Z=v.clientY,Q=y,document.addEventListener("mousemove",M),document.addEventListener("mouseup",g)},w=v=>{D(v.includes("Propertysets"))};return n.jsxs(ae,{children:[n.jsx(P,{type:"hidden",name:"ifcType",id:"ifcType",value:""}),n.jsx(P,{type:"hidden",name:"name",id:"name",value:""}),n.jsx(P,{type:"hidden",name:"material",id:"material",value:""}),n.jsx(H,{mx:"md",mt:"lg",mb:"sm",children:n.jsx(ht,{api:x,defaultSelection:f})}),c?n.jsxs(n.Fragment,{children:[n.jsxs(A,{defaultValue:["Classifications"],multiple:!0,onChange:w,children:[n.jsxs(A.Item,{value:"Classifications",children:[n.jsx(A.Control,{children:n.jsx(K,{order:5,children:t("classificationsLabel")})}),n.jsx(A.Panel,{style:{height:V},children:n.jsx(Qe,{height:y,handleMouseDown:m})})]},"Classifications"),n.jsxs(A.Item,{value:"Propertysets",children:[n.jsx(A.Control,{children:n.jsx(K,{order:5,children:t("propertysetsLabel")})}),n.jsx(A.Panel,{children:n.jsx(dt,{mainDictionaryClassification:E,recursiveMode:d})})]},"Propertysets")]}),n.jsxs(H,{my:"sm",justify:"center",children:[n.jsx(Ke,{bsddSearchSave:l}),n.jsx(W,{fullWidth:!0,variant:"light",color:"gray",onClick:s,children:t("cancel")})]})]}):n.jsxs(Ge,{mx:"md",title:t("noClassificationSelected"),mt:"xl",children:[t("classSearchInstruction"),n.jsx(We,{h:"md"}),t("needHelp")," ",n.jsx("a",{href:"https://github.com/buildingsmart-community/bSDD-Revit-plugin/wiki",target:"_blank",rel:"noreferrer",children:t("checkDocumentation")})]})]})}export{mt as B};
