import{aN as H,aO as C,b4 as ee,ba as me,bb as ge,bc as be,bd as xe,r as d,j as s,aH as _,be as Ce,a5 as ne,a7 as D,an as $,bf as ve,ac as Y,a8 as te,X as se,P as ae,u as U,bg as je,bh as Se,b as B,bi as Ie,bj as ie,bk as oe,bl as ye,bm as k,bn as De,B as le,aB as G,aG as we,bo as Ve,bp as Ee,aM as ce,ao as re,bq as Oe,t as q,br as Me,bs as ue,bt as Te,bu as Pe,aD as L,aC as Ae,bv as fe,bw as Re,bx as ke,aV as de,b1 as T,aJ as Be,aQ as he,by as Le,aL as He,bz as Ue,bA as Ne,aR as $e,bB as ze,bC as Fe,bD as Ge,bE as We,b2 as J,aI as _e,S as Ye}from"./defaultSettings-f79f9fd2.js";function qe(n,e,a,t){return console.log("Creating bsddSearchSave data",t),t?{ifcData:Ce(n,t),settings:a,propertyIsInstanceMap:e}:{ifcData:[],settings:a,propertyIsInstanceMap:e}}function Je({bsddSearchSave:n}){const{t:e}=H();C(ee);const a=C(me),t=C(ge),o=C(be),i=C(xe),r=d.useCallback(g=>{console.log("Sending bsddSearchSave data back to host",g),n(qe(g,o,t,i)).then(S=>{console.log("Sent iFC data back to host",S)})},[n,o,i,t]),f=()=>{console.log(a),r(a)};return s.jsx(_,{color:"gray",fullWidth:!0,onClick:f,variant:"filled",children:e("apply")})}const Q=25,Qe=25;function X({height:n,options:e,label:a,value:t,setValue:o,placeholder:i="Search values"}){const[r,f]=d.useState(""),[g,S]=d.useState(e.slice(0,Q)),[c,v]=d.useState(e.length===1),p=d.useRef(null),l=ne({onDropdownClose:()=>{l.resetSelectedOption(),l.focusTarget&&l.focusTarget()},onDropdownOpen:()=>{l.focusSearchInput&&l.searchRef.current&&l.focusSearchInput()}});d.useEffect(()=>{f(t?.label||"")},[t]),d.useEffect(()=>{v(e.length===1)},[e]),d.useEffect(()=>{const b=t===null?e.filter(I=>I?.label.toLowerCase().includes(r.toLowerCase().trim())||I?.value.toString().toLowerCase().includes(r.toLowerCase().trim())):e;S(b.slice(0,Q))},[e,r,t]);const h=b=>{const{scrollTop:I,scrollHeight:P,clientHeight:u}=b.currentTarget,j=5;P-I<=u+j&&S(y=>{const w=y.length,A=(t===null?e.filter(E=>E?.label.toLowerCase().includes(r.toLowerCase().trim())||E?.value.toString().toLowerCase().includes(r.toLowerCase().trim())):e).slice(w,w+Qe);return[...y,...A]})},x=g.map(b=>s.jsx(D.Option,{value:b.value,active:t?.value===b.value,children:s.jsxs($,{gap:"sm",children:[t?.value===b.value?s.jsx(ve,{size:12}):null,s.jsx(Y,{fz:"sm",opacity:c?.6:1,children:b.label}),s.jsxs(Y,{fz:"xs",opacity:.6,children:["(",b.value,")"]})]})},b.value));return s.jsx("div",{style:{display:"flex",flexDirection:"column",height:"100%"},children:s.jsxs(D,{store:l,onOptionSubmit:b=>{if(!c){const I=e.find(u=>u.value===b),P=I&&t?.value!==I.value?I:null;o(P),l.closeDropdown()}},disabled:c,children:[s.jsx(D.Target,{children:s.jsx(te,{rightSection:!c&&s.jsx(se,{size:"sm",onMouseDown:b=>{b.preventDefault()},onClick:()=>{f(""),o(null)},"aria-label":"Clear value"}),label:a,value:t?`${t.label} (${t.value})`:r,onChange:b=>{c||(o(null),l.updateSelectedOptionIndex(),f(b.currentTarget.value))},onClick:()=>{c||l.openDropdown()},onBlur:()=>l.closeDropdown(),placeholder:c?"":i,disabled:c})}),n<80?s.jsx(D.Dropdown,{style:{maxHeight:"20em",overflowY:"auto"},ref:p,onScroll:h,children:s.jsx(D.Options,{children:x.length>0?x:s.jsx(D.Empty,{children:"Nothing found..."})})}):s.jsx(ae,{withBorder:!0,my:"0.2em",style:{flexGrow:1,overflow:"auto",backgroundColor:c?"var(--mantine-color-gray-0)":"transparent",color:c?"var(--mantine-color-gray-6)":"inherit",pointerEvents:c?"none":"auto"},ref:p,onScroll:h,children:s.jsx(D.Options,{children:x.length>0?x:s.jsx(D.Empty,{children:"Nothing found..."})})})]})})}const Xe=(n,e,a)=>{if(!e||!e.value)return null;const t=a[n];return t?{type:"IfcClassificationReference",name:e.label,location:e.uri,identification:e.value,referencedSource:{type:"IfcClassification",name:t.name,location:t.uri,edition:t.version,editionDate:t.releaseDate}}:null},Ze=(n,e,a)=>{const t=Array.from(n.entries()).map(([o,i])=>Xe(o,i,e)).filter(o=>o!==null);t.length>0&&a(Ve(t))};function Ke({height:n,handleMouseDown:e}){const a=U(),{t}=H(),[o,i]=d.useState(new Map),[r,f]=d.useState(new Map),g=C(je),S=C(Se),c=B(ee),v=B(Ie),p=B(ie),l=B(oe),h=B(ye);return d.useEffect(()=>{(async()=>{const I=Array.from(g.entries()).map(async([m,y])=>{if(p&&m===h){const{code:V,name:R,uri:O}=p;return[m,[{value:V,label:R,uri:O}]]}let w=[];const M=v[m],A=await p?.classRelations?.map(V=>V.relatedClassUri),E=M?.filter(V=>A?.includes(V.uri));if(E&&E.length>0)w=E.map(V=>({value:V.code,label:V.name,uri:V.uri}));else try{w=(await a(Ee(m)).unwrap())?.map(R=>({value:R.code,label:R.name||"",uri:R.uri}))??[]}catch(V){console.error("Failed to fetch dictionary classes for",m,V),w=[]}return[m,w]}),P=await Promise.all(I),u=new Map(P);i(u);const j=new Map;u.forEach((m,y)=>{if(m.length===1)j.set(y,m[0]);else if(y in S){const w=S[y];if(w.length===1){const M=w[0];if(m.some(E=>E.value===M.identification)){const E={label:M.name||"",value:M.identification||"",uri:M.location||""};j.set(y,E)}}}}),f(j)})()},[g,v,a,S,p,h]),d.useEffect(()=>{Ze(r,c,a)},[c,a,r]),s.jsxs(ae,{style:{height:`${n}px`,position:"relative"},children:[Array.from(g.entries()).map(([x,b])=>{const I=x===h,P=x===p?.dictionaryUri;return I?s.jsx(X,{height:n,label:b.name,options:o.get(x)||[],value:r.get(x)||null,setValue:u=>{if(u?.uri&&u?.uri!==l){const j=new Map(r);j.set(x,u),f(j),a(k(u.uri))}},placeholder:t("classifications.searchClassesPlaceholder")},x):P?null:s.jsx(X,{height:n,label:b.name,options:o.get(x)||[],value:r.get(x)||null,setValue:u=>{const j=new Map(r);j.set(x,u),f(j);const m=Array.from(j.values()).filter(y=>y!==null&&y.uri!==l).map(y=>y.uri);a(De(m))},placeholder:t("classifications.searchClassesPlaceholder")},x)}),s.jsx(le,{onMouseDown:e,style:{marginTop:"4px"},children:s.jsx(G,{label:t("classifications.dragResize"),withArrow:!0,children:s.jsx(_,{fullWidth:!0,variant:"subtle",size:"sm",color:"gray","aria-label":t("classifications.dragResize"),children:s.jsx(we,{})})})})]})}function en(n,e){return n==null||e==null?null:n.toLowerCase()!==e.toLowerCase()?`(${e})`:null}function nn({label:n,description:e,value:a,setValue:t,disabled:o,inputContainer:i}){const{t:r}=H(),[f,g]=d.useState(!1),[S,c]=d.useState(!0),v=()=>r(S?"checkbox.indeterminate":f?"checkbox.true":"checkbox.false"),p=h=>{h.target.indeterminate=!1,t(h.target.checked)};d.useEffect(()=>{a===!0?(g(!0),c(!1)):a===!1?(g(!1),c(!1)):a===void 0&&(g(!1),c(!0))},[a]);const l=s.jsx(ce,{description:v(),checked:f,indeterminate:S,type:"checkbox",onChange:h=>p(h),disabled:o});return s.jsx(re.Wrapper,{label:n,description:e,children:i?i(l):l})}const tn=["Name","Description","ObjectType"],sn=(n,e,a)=>{if(e==="Attributes"&&!tn.includes(a))return!0;const t=`${e}/${a}`;return n[t]||n[a]||!1},an=(n,e,a,t)=>{const o=n.map(i=>{if(i.name===e){const r=i.hasProperties.map(f=>f.name===a?{...f,...t}:f);return r.some(f=>f.name===a)||r.push({name:a,...t}),{...i,hasProperties:r}}return i});return o.some(i=>i.name===e)||o.push({type:"IfcPropertySet",name:e,hasProperties:[{name:a,...t}]}),o};function on({propertySet:n,property:e,propertyNaturalLanguageName:a}){const t=U(),o=C(u=>u.ifcData.propertyIsInstanceMap),i=C(u=>u.ifcData.savedPropertyIsInstanceMap),r=C(Oe),f=n.name!=="Attributes",g=`${n.name}/${e.name}`,S=i.hasOwnProperty(g)||i.hasOwnProperty(e.name),c=sn(o,n.name||"",e.name),[v,p]=d.useState(""),l=a?.trim()?a:e.name,h=en(l,e.name);d.useEffect(()=>{if(e.type==="IfcPropertySingleValue"){const u=e.nominalValue?.type||"";p(u==="IfcBoolean"?e.nominalValue?.value??!1:e.nominalValue?.value??"")}else if(e.type==="IfcPropertyEnumeratedValue"){const u=e.enumerationValues?.[0];u&&u.type,p(u?.value??"")}},[e]);const x=u=>{if(p(u),r&&n.name){let j;"nominalValue"in e?j={nominalValue:{...e.nominalValue,value:u}}:"enumerationReference"in e?j={enumerationValues:(e.enumerationReference?.enumerationValues||[]).filter(M=>M.value===u)}:j={value:u};const m=an(r,n.name,e.name,j);t(ue(m)),n.name==="Attributes"&&(e.name==="ObjectType"?t(Te(u)):e.name==="Description"&&t(Pe(u)))}},b=u=>{x(u)},I=()=>{switch(e.type){case"IfcPropertySingleValue":return e.nominalValue?.type==="IfcBoolean"?s.jsx(nn,{label:l,description:h,disabled:c,value:v,setValue:m=>b(m)}):s.jsx(L,{label:l,description:h,placeholder:e.nominalValue?.value??"",value:v||"",disabled:c,onChange:m=>b(m.target.value),onBlur:m=>x(m.target.value)});case"IfcPropertyEnumeratedValue":const u=e.enumerationReference?.enumerationValues||[],j=u.length===1;return s.jsx(Ae,{label:l,description:h,value:v||"",disabled:c||j,clearable:!j,onChange:m=>b(m),data:u.map(m=>({value:m.value,label:m.value}))});default:return s.jsx(L,{placeholder:e.name,value:v||"",disabled:c,onChange:m=>b(m.target.value),onBlur:m=>x(m.target.value)})}},P=u=>f&&c?s.jsx(G,{label:q("bsddSearch.property.tooltipEditInstance"),withArrow:!0,children:u}):u;return s.jsxs($,{children:[s.jsx("div",{style:{flex:1},children:P(I())}),f&&s.jsx(G,{label:q("bsddSearch.property.setAsInstanceCheckboxTooltip"),withArrow:!0,children:s.jsx(ce,{style:{marginTop:"2rem"},disabled:S,checked:c,onChange:u=>{S||(x(void 0),t(Me({propertyName:g,value:u.currentTarget.checked})))}})})]})}const ln={Boolean:"IfcBoolean",Character:"IfcText",Integer:"IfcInteger",Real:"IfcReal",String:"IfcText",Time:"IfcDateTime"};function z(n,e){const a=n&&ln[n]||"default";let t;return n==="Boolean"&&typeof e=="string"?e.toUpperCase()==="TRUE"?t=!0:e.toUpperCase()==="FALSE"?t=!1:t=void 0:t=e,{type:a,value:t}}function W(n,e){return n&&n===e?.type?e:z(n,e?.value)}function pe(n,e,a){let t;if(n&&n.isDefinedBy){let o=n.isDefinedBy.find(i=>i.name===e);if(o&&(t=o.hasProperties.find(i=>i.name===a)),t)return t;if(o=n.isDefinedBy.find(i=>i.name===""),o)return o.hasProperties.find(i=>i.name===a)}return t}function cn(n,e){const a=e?.nominalValue?.value??null;return z(n,a)}function rn(n,e,a){if(e){if(e.type==="IfcPropertyEnumeratedValue"){const t=a.find(o=>e.enumerationValues?e.enumerationValues.some(i=>i.value===o.value):!1);return t?W(n,t):null}if("nominalValue"in e&&e.nominalValue){const t=a.find(o=>o.value===e.nominalValue?.value);return t?W(n,t):null}}return null}function un(n,e,a,t){const o=n.allowedValues?.map(g=>z(n.dataType,g.value))||[],i={type:"IfcPropertyEnumeratedValue",name:e,enumerationReference:{type:"IfcPropertyEnumeration",name:e,enumerationValues:o}};n.propertyUri&&(i.specification=n.propertyUri);let r=null,f=[];if(n.allowedValues?f=n.allowedValues:n.predefinedValue&&(f=[n.predefinedValue]),f.length===1)r=W(n.dataType,f[0]);else if(t){const g=pe(t,a,e);r=rn(n.dataType,g,o)}return r!==null&&(i.enumerationValues=[r]),i}function fn(n,e,a,t){const o={type:"IfcPropertySingleValue",name:e};n.propertyUri&&(o.specification=n.propertyUri);let i=null;if(n.predefinedValue)i=z(n.dataType,n.predefinedValue);else if(t){const r=pe(t,a,e);i=cn(n.dataType,r)}return i!==null&&(o.nominalValue=i),o}function dn(n,e,a){const{propertyCode:t}=n,o=t||"unknown",i=n.allowedValues?un(n,o,e,a):fn(n,o,e,a);return i.specification=n.propertyUri||"",i}function hn({activeClassifications:n,recursiveMode:e}){const a=U(),t=C(fe);C(Re);const o=C(ke),i=C(de),[r,f]=d.useState({}),[g,S]=d.useState([]);return d.useEffect(()=>{if(n.length===0)return;const c={};n.forEach(p=>{p.classProperties?.forEach(l=>{if(!l||!l.propertySet)return;const h=l.propertySet||p.name;c[h]||(c[h]={type:"IfcPropertySet",name:h,hasProperties:[]}),c[h].hasProperties.push(dn(l,h,t))})}),a(ue(Object.values(c))),S(Object.values(c))},[a,t,n]),d.useEffect(()=>{if(n.length===0)return;const c={};n.forEach(p=>{p.classProperties?.forEach(l=>{l&&l.propertyUri&&(i&&o&&o[i]&&o[i][l.propertyUri]?c[l.propertyUri]=o[i][l.propertyUri]||"":c[l.propertyUri]=l.name)})}),f(c)},[n,e,t,o,i]),s.jsx("div",{children:d.Children.toArray(g.map((c,v)=>s.jsx(T,{variant:"contained",radius:"xs",children:s.jsxs(T.Item,{value:c.name||"Unknown",style:v!==0?{borderTopWidth:0}:{},children:[s.jsx(T.Control,{children:c.name}),s.jsx(T.Panel,{children:s.jsx(Be,{children:d.Children.toArray(c.hasProperties.map(p=>{const l=p.specification?r[p.specification]:"";return s.jsx(on,{propertySet:c,property:p,propertyNaturalLanguageName:l})}))})})]},c.name||"Unknown")})))})}function pn({defaultSelection:n}){const e=U(),{t:a}=H(),t=C(he),o=C(Le),[i,r]=d.useState(n?.label||""),[f]=He(i,300),[g,S]=d.useState([]),[c,v]=d.useState(n||null),p=ne({onDropdownClose:()=>p.resetSelectedOption(),onDropdownOpen:()=>p.focusSearchInput()});return d.useEffect(()=>{n&&r(n.label)},[n,e]),d.useEffect(()=>{if(t){const l={SearchText:f,DictionaryUri:t.ifcClassification.location};e(Ue(l))}else e(Ne([]))},[e,f,t]),d.useEffect(()=>{if(o?.count&&o.dictionary?.classes){const l=o.dictionary.classes.filter(h=>h.uri&&h.name).map(h=>({value:h.uri,label:h.name}));if(S(l),l.length===1){const h=l[0];v(h),r(h.label),e(k(h.value))}}else S([])},[o,e]),d.useEffect(()=>{e(c?k(c.value):k(null))},[e,c]),s.jsxs(D,{store:p,withinPortal:!1,onOptionSubmit:l=>{const h=g.find(x=>x.value===l);h&&(v(h),r(h.label),p.closeDropdown())},children:[s.jsx(D.Target,{children:s.jsx(te,{label:`${a("searchMainDictionaryLabel")} ${t?t.ifcClassification.name:""}`,component:"button",type:"button",pointer:!0,style:{width:"100%"},rightSection:c!==null?s.jsx(se,{size:"sm",onMouseDown:l=>l.preventDefault(),onClick:l=>{l.stopPropagation(),v(null),r(""),e(k(null)),p.openDropdown()},"aria-label":"Clear selection"}):s.jsx(D.Chevron,{}),onClick:()=>p.toggleDropdown(),children:c?.label||s.jsx(re.Placeholder,{children:a("searchMainDictionaryLabel")})})}),s.jsxs(D.Dropdown,{children:[s.jsx(D.Search,{value:i,onChange:l=>r(l.currentTarget.value),placeholder:a("searchMainDictionaryLabel")}),s.jsx(D.Options,{children:g.length>0?g.map(l=>s.jsx(D.Option,{value:l.value,children:l.label},l.value)):s.jsx(D.Empty,{children:a("noResults")})})]})]})}const F=60.7969;let Z=0,K=0;const mn=(n,e,a,t)=>{if(!n||!e)return;const o=e.ifcClassification.location;let i;return n.hasAssociations?.forEach(r=>{if(r.type==="IfcClassificationReference"){const f=r;f.referencedSource?.location===o&&(f.location&&t(k(f.location)),i={label:f.name,value:f.location})}}),!i&&a&&n[a]&&n[a]!==""&&n[a]!=="..."&&(i={label:n[a],value:n[a]}),i};function bn({searchKey:n="objectType"}){const{t:e}=H(),a=U(),{bsddSearchSave:t,bsddSearchCancel:o}=$e(),i=C(he),r=C(de),f=C(ze),g=C(fe),S=C(oe),c=C(ie),v=C(Fe),p=C(Ge),[l,h]=d.useState(),[x,b]=d.useState([]),[I,P]=d.useState(!1),[u,j]=d.useState(F),[m,y]=d.useState("auto"),[w,M]=d.useState(!1);d.useEffect(()=>{if(!c||!w)return;const O=c.classProperties||[];a(We({classProperties:O,languageCode:r}))},[c,w,r,a]),d.useEffect(()=>{const O=mn(g,i,n,a);h(O)},[i,g,a,n]),d.useEffect(()=>{const O=[c,v,...p].filter(N=>N!==null);b(O)},[c,p,v]),d.useEffect(()=>{y(`${u*f.length+48}px`)},[f.length,u]);const A=O=>{const N=K+(O.clientY-Z)/f.length;j(N>F?N:F)},E=()=>{document.removeEventListener("mousemove",A),document.removeEventListener("mouseup",E)},V=O=>{Z=O.clientY,K=u,document.addEventListener("mousemove",A),document.addEventListener("mouseup",E)},R=O=>{M(O.includes("Propertysets"))};return s.jsxs(le,{children:[s.jsx(L,{type:"hidden",name:"ifcType",id:"ifcType",value:""}),s.jsx(L,{type:"hidden",name:"name",id:"name",value:""}),s.jsx(L,{type:"hidden",name:"material",id:"material",value:""}),s.jsx($,{mx:"md",mt:"lg",mb:"sm",children:s.jsx(pn,{defaultSelection:l})}),S?s.jsxs(s.Fragment,{children:[s.jsxs(T,{defaultValue:["Classifications"],multiple:!0,onChange:R,children:[s.jsxs(T.Item,{value:"Classifications",children:[s.jsx(T.Control,{children:s.jsx(J,{order:5,children:e("classificationsLabel")})}),s.jsx(T.Panel,{style:{height:m},children:s.jsx(Ke,{height:u,handleMouseDown:V})})]},"Classifications"),s.jsxs(T.Item,{value:"Propertysets",children:[s.jsx(T.Control,{children:s.jsx(J,{order:5,children:e("propertysetsLabel")})}),s.jsx(T.Panel,{children:s.jsx(hn,{activeClassifications:x,recursiveMode:I})})]},"Propertysets")]}),s.jsxs($,{my:"sm",justify:"center",children:[s.jsx(Je,{bsddSearchSave:t}),s.jsx(_,{fullWidth:!0,variant:"light",color:"gray",onClick:o,children:e("cancel")})]})]}):s.jsxs(_e,{mx:"md",title:e("noClassificationSelected"),mt:"xl",children:[e("classSearchInstruction"),s.jsx(Ye,{h:"md"}),e("needHelp")," ",s.jsx("a",{href:"https://github.com/buildingsmart-community/bSDD-Revit-plugin/wiki",target:"_blank",rel:"noreferrer",children:e("checkDocumentation")})]})]})}export{bn as B};
