import{aO as H,aP as m,be as ne,bi as me,bj as ge,bk as be,bl as xe,r as f,j as s,aF as W,bm as Ce,a5 as te,a7 as E,an as N,bn as ve,ac as q,a8 as se,X as ae,P as ie,u as F,bo as je,bp as Se,bq as ye,br as _,bs as Y,bt as Ie,aR as oe,bu as B,bv as De,B as le,aC as z,aK as we,bw as Ve,bx as Ee,by as Oe,aM as re,ao as ce,bz as Te,t as X,bA as Me,bB as ue,bC as Pe,bD as Ae,aE as L,aD as Re,bE as fe,bF as ke,aX as de,bG as Be,b3 as P,aH as Le,aS as he,bH as Ue,aI as He,bI as Fe,bJ as Ne,aT as $e,bK as ze,bL as Ge,bM as We,bN as _e,b4 as J,aG as Ye,S as qe}from"./defaultSettings-35c0906c.js";function Xe(n,e,a,t){return console.log("Creating bsddSearchSave data",t),t?{ifcData:Ce(n,t),settings:a,propertyIsInstanceMap:e}:{ifcData:[],settings:a,propertyIsInstanceMap:e}}function Je({bsddSearchSave:n}){const{t:e}=H();m(ne);const a=m(me),t=m(ge),l=m(be),i=m(xe),c=f.useCallback(b=>{console.log("Sending bsddSearchSave data back to host",b),n(Xe(b,l,t,i)).then(v=>{console.log("Sent iFC data back to host",v)})},[n,l,i,t]),u=()=>{console.log(a),c(a)};return s.jsx(W,{color:"gray",fullWidth:!0,onClick:u,variant:"filled",children:e("apply")})}const Q=25,Qe=25;function Z({height:n,options:e,label:a,value:t,setValue:l,placeholder:i="Search values"}){const[c,u]=f.useState(""),[b,v]=f.useState(e.slice(0,Q)),[d,y]=f.useState(e.length===1),x=f.useRef(null),o=te({onDropdownClose:()=>{o.resetSelectedOption(),o.focusTarget&&o.focusTarget()},onDropdownOpen:()=>{o.focusSearchInput&&o.searchRef.current&&o.focusSearchInput()}});f.useEffect(()=>{u(t?.label||"")},[t]),f.useEffect(()=>{y(e.length===1)},[e]),f.useEffect(()=>{const r=t===null?e.filter(j=>j?.label.toLowerCase().includes(c.toLowerCase().trim())||j?.value.toString().toLowerCase().includes(c.toLowerCase().trim())):e;v(r.slice(0,Q))},[e,c,t]);const p=r=>{const{scrollTop:j,scrollHeight:V,clientHeight:h}=r.currentTarget,S=5;V-j<=h+S&&v(I=>{const D=I.length,M=(t===null?e.filter(R=>R?.label.toLowerCase().includes(c.toLowerCase().trim())||R?.value.toString().toLowerCase().includes(c.toLowerCase().trim())):e).slice(D,D+Qe);return[...I,...M]})},C=b.map(r=>s.jsx(E.Option,{value:r.value,active:t?.value===r.value,children:s.jsxs(N,{gap:"sm",children:[t?.value===r.value?s.jsx(ve,{size:12}):null,s.jsx(q,{fz:"sm",opacity:d?.6:1,children:r.label}),s.jsxs(q,{fz:"xs",opacity:.6,children:["(",r.value,")"]})]})},r.value));return s.jsx("div",{style:{display:"flex",flexDirection:"column",height:"100%"},children:s.jsxs(E,{store:o,onOptionSubmit:r=>{if(!d){const j=e.find(h=>h.value===r),V=j&&t?.value!==j.value?j:null;l(V),o.closeDropdown()}},disabled:d,children:[s.jsx(E.Target,{children:s.jsx(se,{rightSection:!d&&s.jsx(ae,{size:"sm",onMouseDown:r=>{r.preventDefault()},onClick:()=>{u(""),l(null)},"aria-label":"Clear value"}),label:a,value:t?`${t.label} (${t.value})`:c,onChange:r=>{d||(l(null),o.updateSelectedOptionIndex(),u(r.currentTarget.value))},onClick:()=>{d||o.openDropdown()},onBlur:()=>o.closeDropdown(),placeholder:d?"":i,disabled:d})}),n<80?s.jsx(E.Dropdown,{style:{maxHeight:"20em",overflowY:"auto"},ref:x,onScroll:p,children:s.jsx(E.Options,{children:C.length>0?C:s.jsx(E.Empty,{children:"Nothing found..."})})}):s.jsx(ie,{withBorder:!0,my:"0.2em",style:{flexGrow:1,overflow:"auto",backgroundColor:d?"var(--mantine-color-gray-0)":"transparent",color:d?"var(--mantine-color-gray-6)":"inherit",pointerEvents:d?"none":"auto"},ref:x,onScroll:p,children:s.jsx(E.Options,{children:C.length>0?C:s.jsx(E.Empty,{children:"Nothing found..."})})})]})})}const Ze=(n,e,a)=>{if(!e||!e.value)return null;const t=a[n];return t?{type:"IfcClassificationReference",name:e.label,location:e.uri,identification:e.value,referencedSource:{type:"IfcClassification",name:t.name,location:t.uri,edition:t.version,editionDate:t.releaseDate}}:null},Ke=(n,e,a)=>{const t=Array.from(n.entries()).map(([l,i])=>Ze(l,i,e)).filter(l=>l!==null);t.length>0&&a(Ve(t))};function en({height:n,handleMouseDown:e}){const a=F(),{t}=H(),[l,i]=f.useState(new Map),[c,u]=f.useState(new Map),b=m(je),v=m(Se),d=m(ne),y=m(ye),x=m(_),o=m(Y),p=m(Ie),C=m(oe);return f.useEffect(()=>{(async()=>{const V=Array.from(b.entries()).map(async([I,D])=>{if(x&&I===p){const{code:T,name:w,uri:k}=x;return[I,[{value:T,label:w,uri:k}]]}let O=[];const M=y[I],R=Ee(x,C),A=M?.filter(T=>R.includes(T.uri));if(A&&A.length>0)O=A.map(T=>({value:T.code,label:T.name,uri:T.uri}));else try{O=(await a(Oe(I)).unwrap())?.map(w=>({value:w.code,label:w.name||"",uri:w.uri}))??[]}catch(T){console.error("Failed to fetch dictionary classes for",I,T),O=[]}return[I,O]}),h=await Promise.all(V),S=new Map(h);i(S);const g=new Map;S.forEach((I,D)=>{if(I.length===1)g.set(D,I[0]);else if(D in v){const O=v[D];if(O.length===1){const M=O[0];if(I.some(A=>A.value===M.identification)){const A={label:M.name||"",value:M.identification||"",uri:M.location||""};g.set(D,A)}}}}),u(g)})()},[b,y,a,v,x,p,C]),f.useEffect(()=>{Ke(c,d,a)},[d,a,c]),s.jsxs(ie,{style:{height:`${n}px`,position:"relative"},children:[Array.from(b.entries()).map(([r,j])=>{const V=r===p,h=r===x?.dictionaryUri;return V?s.jsx(Z,{height:n,label:j.name,options:l.get(r)||[],value:c.get(r)||null,setValue:S=>{if(S?.uri&&S?.uri!==o){const g=new Map(c);g.set(r,S),u(g),a(B(S.uri))}},placeholder:t("classifications.searchClassesPlaceholder")},r):h?null:s.jsx(Z,{height:n,label:j.name,options:l.get(r)||[],value:c.get(r)||null,setValue:S=>{const g=new Map(c);g.set(r,S),u(g);const I=Array.from(g.values()).filter(D=>D!==null&&D.uri!==o).map(D=>D.uri);a(De(I))},placeholder:t("classifications.searchClassesPlaceholder")},r)}),s.jsx(le,{onMouseDown:e,style:{marginTop:"4px"},children:s.jsx(z,{label:t("classifications.dragResize"),withArrow:!0,children:s.jsx(W,{fullWidth:!0,variant:"subtle",size:"sm",color:"gray","aria-label":t("classifications.dragResize"),children:s.jsx(we,{})})})})]})}function nn(n,e){return n==null||e==null?null:n.toLowerCase()!==e.toLowerCase()?`(${e})`:null}function tn({label:n,description:e,value:a,setValue:t,disabled:l,inputContainer:i}){const{t:c}=H(),[u,b]=f.useState(!1),[v,d]=f.useState(!0),y=()=>c(v?"checkbox.indeterminate":u?"checkbox.true":"checkbox.false"),x=p=>{p.target.indeterminate=!1,t(p.target.checked)};f.useEffect(()=>{a===!0?(b(!0),d(!1)):a===!1?(b(!1),d(!1)):a===void 0&&(b(!1),d(!0))},[a]);const o=s.jsx(re,{description:y(),checked:u,indeterminate:v,type:"checkbox",onChange:p=>x(p),disabled:l});return s.jsx(ce.Wrapper,{label:n,description:e,children:i?i(o):o})}const sn=["Name","Description","ObjectType"],an=(n,e,a)=>{if(e==="Attributes"&&!sn.includes(a))return!0;const t=`${e}/${a}`;return n[t]||n[a]||!1},on=(n,e,a,t)=>{const l=n.map(i=>{if(i.name===e){const c=i.hasProperties.map(u=>u.name===a?{...u,...t}:u);return c.some(u=>u.name===a)||c.push({name:a,...t}),{...i,hasProperties:c}}return i});return l.some(i=>i.name===e)||l.push({type:"IfcPropertySet",name:e,hasProperties:[{name:a,...t}]}),l};function ln({propertySet:n,property:e,propertyNaturalLanguageName:a}){const t=F(),l=m(h=>h.ifcData.propertyIsInstanceMap),i=m(h=>h.ifcData.savedPropertyIsInstanceMap),c=m(Te),u=n.name!=="Attributes",b=`${n.name}/${e.name}`,v=i.hasOwnProperty(b)||i.hasOwnProperty(e.name),d=an(l,n.name||"",e.name),[y,x]=f.useState(""),o=a?.trim()?a:e.name,p=nn(o,e.name);f.useEffect(()=>{if(e.type==="IfcPropertySingleValue"){const h=e.nominalValue?.type||"";x(h==="IfcBoolean"?e.nominalValue?.value??!1:e.nominalValue?.value??"")}else if(e.type==="IfcPropertyEnumeratedValue"){const h=e.enumerationValues?.[0];h&&h.type,x(h?.value??"")}},[e]);const C=h=>{if(x(h),c&&n.name){let S;"nominalValue"in e?S={nominalValue:{...e.nominalValue,value:h}}:"enumerationReference"in e?S={enumerationValues:(e.enumerationReference?.enumerationValues||[]).filter(O=>O.value===h)}:S={value:h};const g=on(c,n.name,e.name,S);t(ue(g)),n.name==="Attributes"&&(e.name==="ObjectType"?t(Pe(h)):e.name==="Description"&&t(Ae(h)))}},r=h=>{C(h)},j=()=>{switch(e.type){case"IfcPropertySingleValue":return e.nominalValue?.type==="IfcBoolean"?s.jsx(tn,{label:o,description:p,disabled:d,value:y,setValue:g=>r(g)}):s.jsx(L,{label:o,description:p,placeholder:e.nominalValue?.value??"",value:y||"",disabled:d,onChange:g=>r(g.target.value),onBlur:g=>C(g.target.value)});case"IfcPropertyEnumeratedValue":const h=e.enumerationReference?.enumerationValues||[],S=h.length===1;return s.jsx(Re,{label:o,description:p,value:y||"",disabled:d||S,clearable:!S,onChange:g=>r(g),data:h.map(g=>({value:g.value,label:g.value}))});default:return s.jsx(L,{placeholder:e.name,value:y||"",disabled:d,onChange:g=>r(g.target.value),onBlur:g=>C(g.target.value)})}},V=h=>u&&d?s.jsx(z,{label:X("bsddSearch.property.tooltipEditInstance"),withArrow:!0,children:h}):h;return s.jsxs(N,{children:[s.jsx("div",{style:{flex:1},children:V(j())}),u&&s.jsx(z,{label:X("bsddSearch.property.setAsInstanceCheckboxTooltip"),withArrow:!0,children:s.jsx(re,{style:{marginTop:"2rem"},disabled:v,checked:d,onChange:h=>{v||(C(void 0),t(Me({propertyName:b,value:h.currentTarget.checked})))}})})]})}const rn={Boolean:"IfcBoolean",Character:"IfcText",Integer:"IfcInteger",Real:"IfcReal",String:"IfcText",Time:"IfcDateTime"};function U(n,e){const a=n&&rn[n]||"default";let t;return n==="Boolean"&&typeof e=="string"?e.toUpperCase()==="TRUE"?t=!0:e.toUpperCase()==="FALSE"?t=!1:t=void 0:t=e,{type:a,value:t}}function G(n,e){return n&&n===e?.type?e:U(n,e?.value)}function pe(n,e,a){let t;if(n&&n.isDefinedBy){let l=n.isDefinedBy.find(i=>i.name===e);if(l&&(t=l.hasProperties.find(i=>i.name===a)),t)return t;if(l=n.isDefinedBy.find(i=>i.name===""),l)return l.hasProperties.find(i=>i.name===a)}return t}function cn(n,e){const a=e?.nominalValue?.value??null;return U(n,a)}function un(n,e,a){if(e){if(e.type==="IfcPropertyEnumeratedValue"){const t=a.find(l=>e.enumerationValues?e.enumerationValues.some(i=>i.value===l.value):!1);return t?G(n,t):null}if("nominalValue"in e&&e.nominalValue){const t=a.find(l=>l.value===e.nominalValue?.value);return t?G(n,t):null}}return null}function fn(n,e,a,t){const l=n.allowedValues?.map(b=>U(n.dataType,b.value))||[],i={type:"IfcPropertyEnumeratedValue",name:e,enumerationReference:{type:"IfcPropertyEnumeration",name:e,enumerationValues:l}};n.propertyUri&&(i.specification=n.propertyUri);let c=null,u=[];if(n.allowedValues?u=n.allowedValues:n.predefinedValue&&(u=[n.predefinedValue]),u.length===1)c=G(n.dataType,u[0]);else if(t){const b=pe(t,a,e);c=un(n.dataType,b,l)}return c!==null&&(i.enumerationValues=[c]),i}function dn(n,e,a,t){const l={type:"IfcPropertySingleValue",name:e};n.propertyUri&&(l.specification=n.propertyUri);let i=null;if(n.predefinedValue)i=U(n.dataType,n.predefinedValue);else if(t){const c=pe(t,a,e);i=cn(n.dataType,c)}else i=U(n.dataType,null);return i!==null&&(l.nominalValue=i),l}function hn(n,e,a){const{propertyCode:t}=n,l=t||"unknown",i=n.allowedValues?fn(n,l,e,a):dn(n,l,e,a);return i.specification=n.propertyUri||"",i}function pn({activeClassifications:n,recursiveMode:e}){const a=F(),t=m(fe),l=m(ke),i=m(de),c=m(_),u=m(Y),b=m(oe),[v,d]=f.useState({}),[y,x]=f.useState([]);return f.useEffect(()=>{if(n.length===0)return;const o={},p=n,C=Be(c);p.forEach(r=>{r.dictionaryUri===b&&r.uri!==u||(r.uri===u||C.includes(r.uri))&&r.classProperties?.forEach(j=>{if(!j||!j.propertySet)return;const V=j.propertySet||r.name;o[V]||(o[V]={type:"IfcPropertySet",name:V,hasProperties:[]}),o[V].hasProperties.push(hn(j,V,t))})}),a(ue(Object.values(o))),x(Object.values(o))},[a,t,n,b,c,u]),f.useEffect(()=>{if(n.length===0)return;const o={};n.forEach(C=>{C.classProperties?.forEach(r=>{r&&r.propertyUri&&(i&&l&&l[i]&&l[i][r.propertyUri]?o[r.propertyUri]=l[i][r.propertyUri]||"":o[r.propertyUri]=r.name)})}),d(o)},[n,e,t,l,i]),s.jsx("div",{children:f.Children.toArray(y.map((o,p)=>s.jsx(P,{variant:"contained",radius:"xs",children:s.jsxs(P.Item,{value:o.name||"Unknown",style:p!==0?{borderTopWidth:0}:{},children:[s.jsx(P.Control,{children:o.name}),s.jsx(P.Panel,{children:s.jsx(Le,{children:f.Children.toArray(o.hasProperties.map(C=>{const r=C.specification?v[C.specification]:"";return s.jsx(ln,{propertySet:o,property:C,propertyNaturalLanguageName:r})}))})})]},o.name||"Unknown")})))})}function mn({defaultSelection:n}){const e=F(),{t:a}=H(),t=m(he),l=m(Ue),[i,c]=f.useState(n?.label||""),[u]=He(i,300),[b,v]=f.useState([]),[d,y]=f.useState(n||null),x=te({onDropdownClose:()=>x.resetSelectedOption(),onDropdownOpen:()=>x.focusSearchInput()});return f.useEffect(()=>{n&&c(n.label)},[n,e]),f.useEffect(()=>{if(t){const o={SearchText:u,DictionaryUri:t.ifcClassification.location};e(Fe(o))}else e(Ne([]))},[e,u,t]),f.useEffect(()=>{if(l?.count&&l.dictionary?.classes){const o=l.dictionary.classes.filter(p=>p.uri&&p.name).map(p=>({value:p.uri,label:p.name}));if(v(o),o.length===1){const p=o[0];y(p),c(p.label),e(B(p.value))}}else v([])},[l,e]),f.useEffect(()=>{e(d?B(d.value):B(null))},[e,d]),s.jsxs(E,{store:x,withinPortal:!1,onOptionSubmit:o=>{const p=b.find(C=>C.value===o);p&&(y(p),c(p.label),x.closeDropdown())},children:[s.jsx(E.Target,{children:s.jsx(se,{label:`${a("searchMainDictionaryLabel")} ${t?t.ifcClassification.name:""}`,component:"button",type:"button",pointer:!0,style:{width:"100%"},rightSection:d!==null?s.jsx(ae,{size:"sm",onMouseDown:o=>o.preventDefault(),onClick:o=>{o.stopPropagation(),y(null),c(""),e(B(null)),x.openDropdown()},"aria-label":"Clear selection"}):s.jsx(E.Chevron,{}),onClick:()=>x.toggleDropdown(),children:d?.label||s.jsx(ce.Placeholder,{children:a("searchMainDictionaryLabel")})})}),s.jsxs(E.Dropdown,{children:[s.jsx(E.Search,{value:i,onChange:o=>c(o.currentTarget.value),placeholder:a("searchMainDictionaryLabel")}),s.jsx(E.Options,{children:b.length>0?b.map(o=>s.jsx(E.Option,{value:o.value,children:o.label},o.value)):s.jsx(E.Empty,{children:a("noResults")})})]})]})}const $=60.7969;let K=0,ee=0;const gn=(n,e,a,t)=>{if(!n||!e)return;const l=e.ifcClassification.location;let i;return n.hasAssociations?.forEach(c=>{if(c.type==="IfcClassificationReference"){const u=c;u.referencedSource?.location===l&&(u.location&&t(B(u.location)),i={label:u.name,value:u.location})}}),!i&&a&&n[a]&&n[a]!==""&&n[a]!=="..."&&(i={label:n[a],value:n[a]}),i};function xn({searchKey:n="objectType"}){const{t:e}=H(),a=F(),{bsddSearchSave:t,bsddSearchCancel:l}=$e(),i=m(he),c=m(de),u=m(ze),b=m(fe),v=m(Y),d=m(_),y=m(Ge),x=m(We),[o,p]=f.useState(),[C,r]=f.useState([]),[j,V]=f.useState(!1),[h,S]=f.useState($),[g,I]=f.useState("auto"),[D,O]=f.useState(!1);f.useEffect(()=>{if(!d||!D)return;const w=d.classProperties||[];a(_e({classProperties:w,languageCode:c}))},[d,D,c,a]),f.useEffect(()=>{const w=gn(b,i,n,a);p(w)},[i,b,a,n]),f.useEffect(()=>{const w=[d,y,...x].filter(k=>k!==null);r(w)},[d,x,y]),f.useEffect(()=>{I(`${h*u.length+48}px`)},[u.length,h]);const M=w=>{const k=ee+(w.clientY-K)/u.length;S(k>$?k:$)},R=()=>{document.removeEventListener("mousemove",M),document.removeEventListener("mouseup",R)},A=w=>{K=w.clientY,ee=h,document.addEventListener("mousemove",M),document.addEventListener("mouseup",R)},T=w=>{O(w.includes("Propertysets"))};return s.jsxs(le,{children:[s.jsx(L,{type:"hidden",name:"ifcType",id:"ifcType",value:""}),s.jsx(L,{type:"hidden",name:"name",id:"name",value:""}),s.jsx(L,{type:"hidden",name:"material",id:"material",value:""}),s.jsx(N,{mx:"md",mt:"lg",mb:"sm",children:s.jsx(mn,{defaultSelection:o})}),v?s.jsxs(s.Fragment,{children:[s.jsxs(P,{defaultValue:["Classifications"],multiple:!0,onChange:T,children:[s.jsxs(P.Item,{value:"Classifications",children:[s.jsx(P.Control,{children:s.jsx(J,{order:5,children:e("classificationsLabel")})}),s.jsx(P.Panel,{style:{height:g},children:s.jsx(en,{height:h,handleMouseDown:A})})]},"Classifications"),s.jsxs(P.Item,{value:"Propertysets",children:[s.jsx(P.Control,{children:s.jsx(J,{order:5,children:e("propertysetsLabel")})}),s.jsx(P.Panel,{children:s.jsx(pn,{activeClassifications:C,recursiveMode:j})})]},"Propertysets")]}),s.jsxs(N,{my:"sm",justify:"center",children:[s.jsx(Je,{bsddSearchSave:t}),s.jsx(W,{fullWidth:!0,variant:"light",color:"gray",onClick:l,children:e("cancel")})]})]}):s.jsxs(Ye,{mx:"md",title:e("noClassificationSelected"),mt:"xl",children:[e("classSearchInstruction"),s.jsx(qe,{h:"md"}),e("needHelp")," ",s.jsx("a",{href:"https://github.com/buildingsmart-community/bSDD-Revit-plugin/wiki",target:"_blank",rel:"noreferrer",children:e("checkDocumentation")})]})]})}export{xn as B};
