import{aG as B,aH as v,b3 as ee,b9 as fe,ba as de,bb as he,bc as te,r as d,j as n,az as _,bd as pe,aY as me,aZ as T,ag as z,be as ge,a3 as Y,aU as be,W as ne,P as se,u as P,bf as xe,bg as ye,b as H,bh as ve,bi as ae,bj as Ce,B as oe,at as N,ay as Ie,bk as Se,bl as je,aE as ie,ah as we,bm as De,av as R,au as Ee,bn as le,bo as Me,bp as Ve,t as K,bq as Oe,br as ce,bs as Ae,bt as ke,aO as re,b0 as A,aB as Te,aL as ue,bu as Pe,aD as Re,bv as Be,bw as Le,bx as W,aF as He,aJ as ze,by as $e,bz as Ue,bA as Fe,bB as Ge,bC as Ne,b1 as q,aA as We,S as _e}from"./defaultSettings-c2cfe3bc.js";const Ye={test:"https://test.bsdd.buildingsmart.org",production:"https://api.bsdd.buildingsmart.org"},Ke="production";function qe({bsddSearchSave:t}){const{t:e}=B();v(ee);const o=v(fe),s=v(de),i=v(he),l=v(te);function a(f,r){return console.log("Creating bsddSearchSave data",l),l?{ifcData:pe(f,l),settings:s,propertyIsInstanceMap:r}:{ifcData:[],settings:s,propertyIsInstanceMap:r}}const g=d.useCallback(f=>{console.log("Sending bsddSearchSave data back to host",f),t(a(f,i)).then(r=>{console.log("Sent iFC data back to host",r)})},[t,i]),u=()=>{console.log(o),g(o)};return n.jsx(_,{color:"gray",fullWidth:!0,onClick:u,variant:"filled",children:e("apply")})}const J=25,Je=25;function Z({height:t,options:e,label:o,value:s,setValue:i,placeholder:l="Search values",disabled:a}){const[g,u]=d.useState(""),[f,r]=d.useState(e.slice(0,J)),h=d.useRef(null),c=me({onDropdownClose:()=>{c.resetSelectedOption(),c.focusTarget&&c.focusTarget()},onDropdownOpen:()=>{c.focusSearchInput&&c.focusSearchInput()}});d.useEffect(()=>{u(s?.label||"")},[s]),d.useEffect(()=>{const x=s===null?e.filter(I=>I?.label.toLowerCase().includes(g.toLowerCase().trim())||I?.value.toString().toLowerCase().includes(g.toLowerCase().trim())):e;r(x.slice(0,J))},[e,g,s]);const C=x=>{const{scrollTop:I,scrollHeight:V,clientHeight:j}=x.currentTarget,S=5;V-I<=j+S&&r(E=>{const M=E.length,m=e.filter(p=>p?.label.toLowerCase().includes(g.toLowerCase().trim())).slice(M,M+Je);return[...E,...m]})},b=f.map(x=>n.jsx(T.Option,{value:x.value,active:s?.value===x.value,children:n.jsxs(z,{gap:"sm",children:[s?.value===x.value?n.jsx(ge,{size:12}):null,n.jsx(Y,{fz:"sm",opacity:a?.6:1,children:x.label}),n.jsxs(Y,{fz:"xs",opacity:.6,children:["(",x.value,")"]})]})},x.value));return n.jsx("div",{style:{display:"flex",flexDirection:"column",height:"100%"},children:n.jsxs(T,{store:c,onOptionSubmit:x=>{if(!a){const I=e.find(j=>j.value===x),V=I&&s?.value!==I.value?I:null;i(V),c.closeDropdown()}},disabled:a,children:[n.jsx(T.Target,{children:n.jsx(be,{rightSection:!a&&n.jsx(ne,{size:"sm",onMouseDown:x=>{x.preventDefault()},onClick:()=>{u(""),i(null)},"aria-label":"Clear value"}),label:o,value:s?`${s.label} (${s.value})`:g,onChange:x=>{a||(i(null),c.updateSelectedOptionIndex(),u(x.currentTarget.value))},onClick:()=>{a||c.openDropdown()},onBlur:()=>c.closeDropdown(),placeholder:a?"":l,disabled:a})}),t<80?n.jsx(T.Dropdown,{style:{maxHeight:"20em",overflowY:"auto"},ref:h,onScroll:C,children:n.jsx(T.Options,{children:b.length>0?b:n.jsx(T.Empty,{children:"Nothing found..."})})}):n.jsx(se,{withBorder:!0,my:"0.2em",style:{flexGrow:1,overflow:"auto",backgroundColor:a?"var(--mantine-color-gray-0)":"transparent",color:a?"var(--mantine-color-gray-6)":"inherit",pointerEvents:a?"none":"auto"},ref:h,onScroll:C,children:n.jsx(T.Options,{children:b.length>0?b:n.jsx(T.Empty,{children:"Nothing found..."})})})]})})}const Ze=(t,e,o)=>{if(!e||!e.value)return null;const s=o[t];return s?{type:"IfcClassificationReference",name:e.label,location:e.uri,identification:e.value,referencedSource:{type:"IfcClassification",name:s.name,location:s.uri,edition:s.version,editionDate:s.releaseDate}}:null},Qe=(t,e,o)=>{const s=Array.from(t.entries()).map(([i,l])=>Ze(i,l,e)).filter(i=>i!==null);s.length>0&&o(Se(s))};function Xe({height:t,handleMouseDown:e}){const o=P(),{t:s}=B(),[i,l]=d.useState(new Map),[a,g]=d.useState(new Map),u=v(xe),f=v(ye),r=H(ee),h=H(ve),c=H(ae),C=H(Ce);return d.useEffect(()=>{(async()=>{const I=Array.from(u.entries()).map(async([D,E])=>{if(c&&D===C){const{code:y,name:O,uri:k}=c;return[D,[{value:y,label:O,uri:k}]]}let M=[];const m=h[D],p=c?.classRelations?.map(y=>y.relatedClassUri),w=m?.filter(y=>p?.includes(y.uri));if(w&&w.length>0)M=w.map(y=>({value:y.code,label:y.name,uri:y.uri}));else try{M=(await o(je(D)).unwrap())?.map(O=>({value:O.code,label:O.name||"",uri:O.uri}))??[]}catch(y){console.error("Failed to fetch dictionary classes for",D,y),M=[]}return[D,M]}),V=await Promise.all(I),j=new Map(V);l(j);const S=new Map;j.forEach((D,E)=>{if(D.length===1)S.set(E,D[0]);else if(E in f){const M=f[E];if(M.length===1){const m=M[0];if(D.some(w=>w.value===m.identification)){const w={label:m.name||"",value:m.identification||"",uri:m.location||""};S.set(E,w)}}}}),g(S)})()},[u,h,o,f,c,C]),d.useEffect(()=>{Qe(a,r,o)},[r,o,a]),n.jsxs(se,{style:{height:`${t}px`,position:"relative"},children:[Array.from(u.entries()).map(([b,x])=>{const I=b===C,V=b===c?.dictionaryUri;return I?n.jsx(Z,{height:t,label:x.name,options:i.get(b)||[],value:a.get(b)||null,setValue:j=>{const S=new Map(a);S.set(b,j),g(S)},placeholder:s("classifications.searchClassesPlaceholder"),disabled:i.get(b)?.length===1},b):V?null:n.jsx(Z,{height:t,label:x.name,options:i.get(b)||[],value:a.get(b)||null,setValue:j=>{const S=new Map(a);S.set(b,j),g(S)},placeholder:s("classifications.searchClassesPlaceholder"),disabled:i.get(b)?.length===1},b)}),n.jsx(oe,{onMouseDown:e,style:{marginTop:"4px"},children:n.jsx(N,{label:s("classifications.dragResize"),withArrow:!0,children:n.jsx(_,{fullWidth:!0,variant:"subtle",size:"sm",color:"gray","aria-label":s("classifications.dragResize"),children:n.jsx(Ie,{})})})})]})}function F(t,e){return t==null||e==null?null:t.toLowerCase()!==e.toLowerCase()?`(${e})`:null}function et({label:t,description:e,value:o,setValue:s,disabled:i,inputContainer:l}){const{t:a}=B(),[g,u]=d.useState(!1),[f,r]=d.useState(!0),h=()=>a(f?"checkbox.indeterminate":g?"checkbox.true":"checkbox.false"),c=b=>{b.target.indeterminate=!1,s(b.target.checked)};d.useEffect(()=>{o===!0?(u(!0),r(!1)):o===!1?(u(!1),r(!1)):o===void 0&&(u(!1),r(!0))},[o]);const C=n.jsx(ie,{description:h(),checked:g,indeterminate:f,type:"checkbox",onChange:b=>c(b),disabled:i});return n.jsx(we.Wrapper,{label:t,description:e,children:l?l(C):C})}const tt=(t,e,o,s)=>t.map(i=>{if(i.name===e){const l=i.hasProperties.map(a=>a.name===o?{...a,...s}:a);return{...i,hasProperties:l}}return i}),nt=({propertySet:t,property:e,propertyNaturalLanguageName:o,isInstance:s,inputContainer:i})=>{const l=P(),a=v(De),g=e.type==="IfcPropertySingleValue"?e.nominalValue?.value||void 0:e.type==="IfcPropertyEnumeratedValue"&&e.enumerationValues?.[0]?.value||void 0,u=r=>{if(a&&t.name)if(t.name!=="Attributes"){let h;"nominalValue"in e?h={nominalValue:{...e.nominalValue,value:r}}:"enumerationValues"in e?h={enumerationValues:[{value:r}]}:h={value:r};const c=tt(a,t.name,e.name,h);l(le(Object.values(c)))}else e.name==="ObjectType"?l(Me(r)):e.name==="Description"&&l(Ve(r))},f=r=>{u(r)};switch(e.type){case"IfcPropertySingleValue":return e.nominalValue?.type==="IfcBoolean"?n.jsx(et,{label:o,description:F(o,e.name),disabled:s,inputContainer:i,value:e.nominalValue?.value??!1,setValue:r=>f(r)}):n.jsx(R,{label:o,description:F(o,e.name),placeholder:e.nominalValue?.value??"",value:e.nominalValue?.value??"",disabled:s,inputContainer:i,onChange:r=>f(r.target.value),onBlur:r=>u(r.target.value)});case"IfcPropertyEnumeratedValue":{const r=e.enumerationValues?.[0]?.value??"",h=e.enumerationReference?.enumerationValues||[];return n.jsx(Ee,{label:o,description:F(o,e.name),value:r,inputContainer:i,disabled:s||e.enumerationReference?.enumerationValues?.length===1,clearable:!0,onChange:c=>f(c),data:h.map(c=>({value:c.value,label:c.value}))})}default:return n.jsx(R,{placeholder:e.name,defaultValue:g,disabled:s,inputContainer:i,onChange:r=>f(r.target.value),onBlur:r=>u(r.target.value)})}},st=["Name","Description","ObjectType"],at=(t,e,o)=>{if(e==="Attributes"&&!st.includes(o))return!0;const s=`${e}/${o}`;return t[s]||t[o]||!1};function ot({propertySet:t,property:e,propertyNaturalLanguageName:o}){const s=P(),i=v(h=>h.ifcData.propertyIsInstanceMap),l=v(h=>h.ifcData.savedPropertyIsInstanceMap),a=t.name!=="Attributes",g=`${t.name}/${e.name}`,u=l.hasOwnProperty(g)||l.hasOwnProperty(e.name),f=at(i,t.name||"",e.name),r=h=>a&&f?n.jsx(N,{label:K("bsddSearch.property.tooltipEditInstance"),withArrow:!0,children:h}):h;return n.jsxs(z,{children:[n.jsx("div",{style:{flex:1},children:n.jsx(nt,{propertySet:t,property:e,propertyNaturalLanguageName:o,isInstance:f,inputContainer:r})}),a&&n.jsx(N,{label:K("bsddSearch.property.setAsInstanceCheckboxTooltip"),withArrow:!0,children:n.jsx(ie,{style:{marginTop:"2rem"},disabled:u,checked:f,onChange:h=>{u||s(Oe({propertyName:g,value:h.currentTarget.checked}))}})})]})}const it={Boolean:"IfcBoolean",Character:"IfcText",Integer:"IfcInteger",Real:"IfcReal",String:"IfcText",Time:"IfcDateTime"};function $(t,e){const o=t&&it[t]||"default";let s;return t==="Boolean"&&typeof e=="string"?e.toUpperCase()==="TRUE"?s=!0:e.toUpperCase()==="FALSE"?s=!1:s=void 0:s=e,{type:o,value:s}}function lt(t,e,o){let s;if(t&&t.isDefinedBy){let i=t.isDefinedBy.find(l=>l.name===e);if(i&&(s=i.hasProperties.find(l=>l.name===o)),s)return s;if(i=t.isDefinedBy.find(l=>l.name===""),i)return i.hasProperties.find(l=>l.name===o)}return s}function ct(t,e,o,s){const l=lt(e,o,s)?.nominalValue?.value??null;return $(t,l)}function rt(t,e,o,s){const i=t.allowedValues?.map(a=>$(t.dataType,a.value))||[],l={type:"IfcPropertyEnumeratedValue",name:e,enumerationReference:{type:"IfcPropertyEnumeration",name:e,enumerationValues:i}};return t.propertyUri&&(l.specification=t.propertyUri),l.enumerationValues=t.predefinedValue?[$(t.dataType,t.predefinedValue)]:null,l}function ut(t,e,o,s){const i={type:"IfcPropertySingleValue",name:e,specification:t.propertyUri||""},l=t.predefinedValue?$(t.dataType,t.predefinedValue):ct(t.dataType,s,o,e);return l!==null&&(i.nominalValue=l),i}function ft(t,e,o){const{propertyCode:s}=t,i=s||"unknown",l=t.allowedValues?rt(t,i):ut(t,i,e,o);return l.specification=t.propertyUri||"",l}function dt({mainDictionaryClassification:t,recursiveMode:e}){const o=P(),s=v(ce),i=v(Ae),l=v(ke),a=v(re),[g,u]=d.useState({});return d.useEffect(()=>{if(!t)return;const f={};[t].forEach(h=>{h.classProperties?.forEach(c=>{if(!c||!c.propertySet)return;const C=c.propertySet||h.name;f[C]||(f[C]={type:"IfcPropertySet",name:C,hasProperties:[]}),s&&f[C].hasProperties.push(ft(c,C,s))})}),o(le(Object.values(f)))},[o,s,t]),d.useEffect(()=>{if(!t)return;const f={};[t].forEach(h=>{h.classProperties?.forEach(c=>{c&&c.propertyUri&&(a&&l&&l[a]&&l[a][c.propertyUri]?f[c.propertyUri]=l[a][c.propertyUri]||"":f[c.propertyUri]=c.name)})}),u(f)},[t,e,s,l,a]),n.jsx("div",{children:d.Children.toArray(i?.map((f,r)=>n.jsx(A,{variant:"contained",radius:"xs",children:n.jsxs(A.Item,{value:f.name||"Unknown",style:r!==0?{borderTopWidth:0}:{},children:[n.jsx(A.Control,{children:f.name}),n.jsx(A.Panel,{children:n.jsx(Te,{children:d.Children.toArray(f.hasProperties.map(h=>{const c=h.specification?g[h.specification]:"";return n.jsx(ot,{propertySet:f,property:h,propertyNaturalLanguageName:c})}))})})]},f.name||"Unknown")})))})}function ht({api:t,defaultSelection:e}){const o=P(),{t:s}=B(),i=v(ue),l=v(Pe),[a,g]=d.useState([]),u=d.useRef(null),[f,r]=d.useState(void 0),[h,c]=d.useState(""),[C]=Re(h,300),[b,x]=d.useState(!1),[I,V]=d.useState(-1);d.useEffect(()=>{e&&!b&&a.length>0&&(a.find(p=>p.value===e.value)?(r(e),c(e.label),u.current&&u.current.blur()):(c(e.label),u.current&&(u.current.focus(),u.current.setSelectionRange(0,u.current.value.length))),x(!0))},[e,b,a]);const j=d.useCallback(m=>{c(m),V(-1);const p=a.filter(w=>w.label.toLowerCase().includes(m.toLowerCase().trim())||w.synonyms?.some(y=>y.toLowerCase().includes(m.toLowerCase().trim())));g(p)},[a]),S=d.useCallback(m=>{const p=a.find(w=>w.value===m);p&&(r(p),u.current&&u.current.blur())},[a]),D=d.useCallback(m=>{if(m.key==="Enter"){if(I>=0&&I<a.length){const p=a[I];c(p.label),S(p.value)}else if(I===-1&&a.length>0){const p=a[0];c(p.label),S(p.value)}u.current&&u.current.blur()}else m.key==="ArrowDown"?V(p=>Math.min(p+1,a.length-1)):m.key==="ArrowUp"&&V(p=>Math.max(p-1,-1))},[I,a,S]);d.useEffect(()=>{if(i){const m={SearchText:C,DictionaryUri:i.ifcClassification.location};o(Be(m))}else o(Le([]))},[o,C,i]),d.useEffect(()=>{u.current&&u.current.focus()},[]),d.useEffect(()=>{if(l){if(l.count){const m=l.dictionary?.classes;m&&g(m.filter(p=>p.uri&&p.name).map(p=>({value:p.uri,label:p.name,synonyms:p.synonyms||[]})))}}else g([])},[l]),d.useEffect(()=>{o(f?W(f.value):W(null))},[o,f]);const E=d.useCallback(()=>{j(""),u.current&&u.current.focus(),r(void 0)},[j]),M=({options:m,search:p})=>{const w=p.toLowerCase().trim().split(" ");return m.filter(y=>{const O=y.label.toLowerCase().trim().split(" "),k=y.synonyms?.map(L=>L.toLowerCase().trim().split(" ")).flat()||[];return w.every(L=>O.some(U=>U.includes(L))||k.some(U=>U.includes(L)))})};return n.jsx(He,{label:`${s("searchMainDictionaryLabel")} ${i?i.ifcClassification.name:""}`,data:a,placeholder:"bSDD search...",value:h,onChange:j,onOptionSubmit:S,filter:M,onKeyDown:D,ref:u,style:{width:"100%"},rightSection:n.jsx(ne,{size:"sm",onMouseDown:m=>{m.preventDefault()},onClick:E,"aria-label":"Clear value"})})}const G=60.7969;let Q=0,X=0;function mt(){const{t}=B(),e=P(),{bsddSearchSave:o,bsddSearchCancel:s}=ze(),i=v(ue),l=v(re),a=v($e),g=v(ce),u=v(Ue);v(te);const[f,r]=d.useState(),[h,c]=d.useState(!1),[C,b]=d.useState(new Fe(Ye[Ke])),[x,I]=d.useState(G),[V,j]=d.useState("auto"),[S,D]=d.useState(!1),E=v(ae);d.useEffect(()=>{if(!E||!S)return;const y=E.classProperties||[];e(Ge({classProperties:y,languageCode:l}))},[E,S,l,e]),d.useEffect(()=>{if(!g||!i)return;const y=i.ifcClassification.location;g.hasAssociations?.forEach(O=>{if(O.type==="IfcClassificationReference"){const k=O;k.referencedSource?.location&&k.referencedSource.location===y&&(k.location&&e(W(k.location)),r({label:k.name,value:k.location}))}})},[i,g,e]),d.useEffect(()=>{u&&e(Ne(u))},[u,e]),d.useEffect(()=>{j(`${x*a.length+48}px`)},[a.length,x]);const M=y=>{const O=X+(y.clientY-Q)/a.length;I(O>G?O:G)},m=()=>{document.removeEventListener("mousemove",M),document.removeEventListener("mouseup",m)},p=y=>{Q=y.clientY,X=x,document.addEventListener("mousemove",M),document.addEventListener("mouseup",m)},w=y=>{D(y.includes("Propertysets"))};return n.jsxs(oe,{children:[n.jsx(R,{type:"hidden",name:"ifcType",id:"ifcType",value:""}),n.jsx(R,{type:"hidden",name:"name",id:"name",value:""}),n.jsx(R,{type:"hidden",name:"material",id:"material",value:""}),n.jsx(z,{mx:"md",mt:"lg",mb:"sm",children:n.jsx(ht,{api:C,defaultSelection:f})}),u?n.jsxs(n.Fragment,{children:[n.jsxs(A,{defaultValue:["Classifications"],multiple:!0,onChange:w,children:[n.jsxs(A.Item,{value:"Classifications",children:[n.jsx(A.Control,{children:n.jsx(q,{order:5,children:t("classificationsLabel")})}),n.jsx(A.Panel,{style:{height:V},children:n.jsx(Xe,{height:x,handleMouseDown:p})})]},"Classifications"),n.jsxs(A.Item,{value:"Propertysets",children:[n.jsx(A.Control,{children:n.jsx(q,{order:5,children:t("propertysetsLabel")})}),n.jsx(A.Panel,{children:n.jsx(dt,{mainDictionaryClassification:E,recursiveMode:h})})]},"Propertysets")]}),n.jsxs(z,{my:"sm",justify:"center",children:[n.jsx(qe,{bsddSearchSave:o}),n.jsx(_,{fullWidth:!0,variant:"light",color:"gray",onClick:s,children:t("cancel")})]})]}):n.jsxs(We,{mx:"md",title:t("noClassificationSelected"),mt:"xl",children:[t("classSearchInstruction"),n.jsx(_e,{h:"md"}),t("needHelp")," ",n.jsx("a",{href:"https://github.com/buildingsmart-community/bSDD-Revit-plugin/wiki",target:"_blank",rel:"noreferrer",children:t("checkDocumentation")})]})]})}export{mt as B};
