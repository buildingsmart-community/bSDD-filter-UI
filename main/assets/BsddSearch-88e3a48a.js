import{aO as H,aP as v,b6 as ee,bc as me,bd as ge,be,bf as xe,r as d,j as s,aH as _,bg as Ce,a5 as ne,a7 as D,an as z,bh as ve,ac as Y,a8 as te,X as se,P as ae,u as F,bi as je,bj as Se,b as B,bk as Ie,bl as oe,bm as ie,bn as ye,bo as k,bp as De,B as le,aB as G,aG as we,bq as Ve,br as Ee,aM as re,ao as ce,bs as Oe,t as q,bt as Te,bu as ue,bv as Me,bw as Pe,aD as L,aC as Ae,bx as fe,by as Re,aX as de,aR as ke,b3 as M,aJ as Be,aS as he,bz as Le,aL as Ue,bA as He,bB as Fe,aT as $e,bC as ze,bD as Ne,bE as Ge,bF as We,b4 as X,aI as _e,S as Ye}from"./defaultSettings-a744149f.js";function qe(n,e,a,t){return console.log("Creating bsddSearchSave data",t),t?{ifcData:Ce(n,t),settings:a,propertyIsInstanceMap:e}:{ifcData:[],settings:a,propertyIsInstanceMap:e}}function Xe({bsddSearchSave:n}){const{t:e}=H();v(ee);const a=v(me),t=v(ge),i=v(be),o=v(xe),r=d.useCallback(b=>{console.log("Sending bsddSearchSave data back to host",b),n(qe(b,i,t,o)).then(S=>{console.log("Sent iFC data back to host",S)})},[n,i,o,t]),f=()=>{console.log(a),r(a)};return s.jsx(_,{color:"gray",fullWidth:!0,onClick:f,variant:"filled",children:e("apply")})}const J=25,Je=25;function Q({height:n,options:e,label:a,value:t,setValue:i,placeholder:o="Search values"}){const[r,f]=d.useState(""),[b,S]=d.useState(e.slice(0,J)),[h,p]=d.useState(e.length===1),x=d.useRef(null),l=ne({onDropdownClose:()=>{l.resetSelectedOption(),l.focusTarget&&l.focusTarget()},onDropdownOpen:()=>{l.focusSearchInput&&l.searchRef.current&&l.focusSearchInput()}});d.useEffect(()=>{f(t?.label||"")},[t]),d.useEffect(()=>{p(e.length===1)},[e]),d.useEffect(()=>{const C=t===null?e.filter(I=>I?.label.toLowerCase().includes(r.toLowerCase().trim())||I?.value.toString().toLowerCase().includes(r.toLowerCase().trim())):e;S(C.slice(0,J))},[e,r,t]);const c=C=>{const{scrollTop:I,scrollHeight:P,clientHeight:u}=C.currentTarget,j=5;P-I<=u+j&&S(y=>{const w=y.length,A=(t===null?e.filter(E=>E?.label.toLowerCase().includes(r.toLowerCase().trim())||E?.value.toString().toLowerCase().includes(r.toLowerCase().trim())):e).slice(w,w+Je);return[...y,...A]})},g=b.map(C=>s.jsx(D.Option,{value:C.value,active:t?.value===C.value,children:s.jsxs(z,{gap:"sm",children:[t?.value===C.value?s.jsx(ve,{size:12}):null,s.jsx(Y,{fz:"sm",opacity:h?.6:1,children:C.label}),s.jsxs(Y,{fz:"xs",opacity:.6,children:["(",C.value,")"]})]})},C.value));return s.jsx("div",{style:{display:"flex",flexDirection:"column",height:"100%"},children:s.jsxs(D,{store:l,onOptionSubmit:C=>{if(!h){const I=e.find(u=>u.value===C),P=I&&t?.value!==I.value?I:null;i(P),l.closeDropdown()}},disabled:h,children:[s.jsx(D.Target,{children:s.jsx(te,{rightSection:!h&&s.jsx(se,{size:"sm",onMouseDown:C=>{C.preventDefault()},onClick:()=>{f(""),i(null)},"aria-label":"Clear value"}),label:a,value:t?`${t.label} (${t.value})`:r,onChange:C=>{h||(i(null),l.updateSelectedOptionIndex(),f(C.currentTarget.value))},onClick:()=>{h||l.openDropdown()},onBlur:()=>l.closeDropdown(),placeholder:h?"":o,disabled:h})}),n<80?s.jsx(D.Dropdown,{style:{maxHeight:"20em",overflowY:"auto"},ref:x,onScroll:c,children:s.jsx(D.Options,{children:g.length>0?g:s.jsx(D.Empty,{children:"Nothing found..."})})}):s.jsx(ae,{withBorder:!0,my:"0.2em",style:{flexGrow:1,overflow:"auto",backgroundColor:h?"var(--mantine-color-gray-0)":"transparent",color:h?"var(--mantine-color-gray-6)":"inherit",pointerEvents:h?"none":"auto"},ref:x,onScroll:c,children:s.jsx(D.Options,{children:g.length>0?g:s.jsx(D.Empty,{children:"Nothing found..."})})})]})})}const Qe=(n,e,a)=>{if(!e||!e.value)return null;const t=a[n];return t?{type:"IfcClassificationReference",name:e.label,location:e.uri,identification:e.value,referencedSource:{type:"IfcClassification",name:t.name,location:t.uri,edition:t.version,editionDate:t.releaseDate}}:null},Ze=(n,e,a)=>{const t=Array.from(n.entries()).map(([i,o])=>Qe(i,o,e)).filter(i=>i!==null);t.length>0&&a(Ve(t))};function Ke({height:n,handleMouseDown:e}){const a=F(),{t}=H(),[i,o]=d.useState(new Map),[r,f]=d.useState(new Map),b=v(je),S=v(Se),h=B(ee),p=B(Ie),x=B(oe),l=B(ie),c=B(ye);return d.useEffect(()=>{(async()=>{const I=Array.from(b.entries()).map(async([m,y])=>{if(x&&m===c){const{code:V,name:R,uri:O}=x;return[m,[{value:V,label:R,uri:O}]]}let w=[];const T=p[m],A=await x?.classRelations?.map(V=>V.relatedClassUri),E=T?.filter(V=>A?.includes(V.uri));if(E&&E.length>0)w=E.map(V=>({value:V.code,label:V.name,uri:V.uri}));else try{w=(await a(Ee(m)).unwrap())?.map(R=>({value:R.code,label:R.name||"",uri:R.uri}))??[]}catch(V){console.error("Failed to fetch dictionary classes for",m,V),w=[]}return[m,w]}),P=await Promise.all(I),u=new Map(P);o(u);const j=new Map;u.forEach((m,y)=>{if(m.length===1)j.set(y,m[0]);else if(y in S){const w=S[y];if(w.length===1){const T=w[0];if(m.some(E=>E.value===T.identification)){const E={label:T.name||"",value:T.identification||"",uri:T.location||""};j.set(y,E)}}}}),f(j)})()},[b,p,a,S,x,c]),d.useEffect(()=>{Ze(r,h,a)},[h,a,r]),s.jsxs(ae,{style:{height:`${n}px`,position:"relative"},children:[Array.from(b.entries()).map(([g,C])=>{const I=g===c,P=g===x?.dictionaryUri;return I?s.jsx(Q,{height:n,label:C.name,options:i.get(g)||[],value:r.get(g)||null,setValue:u=>{if(u?.uri&&u?.uri!==l){const j=new Map(r);j.set(g,u),f(j),a(k(u.uri))}},placeholder:t("classifications.searchClassesPlaceholder")},g):P?null:s.jsx(Q,{height:n,label:C.name,options:i.get(g)||[],value:r.get(g)||null,setValue:u=>{const j=new Map(r);j.set(g,u),f(j);const m=Array.from(j.values()).filter(y=>y!==null&&y.uri!==l).map(y=>y.uri);a(De(m))},placeholder:t("classifications.searchClassesPlaceholder")},g)}),s.jsx(le,{onMouseDown:e,style:{marginTop:"4px"},children:s.jsx(G,{label:t("classifications.dragResize"),withArrow:!0,children:s.jsx(_,{fullWidth:!0,variant:"subtle",size:"sm",color:"gray","aria-label":t("classifications.dragResize"),children:s.jsx(we,{})})})})]})}function en(n,e){return n==null||e==null?null:n.toLowerCase()!==e.toLowerCase()?`(${e})`:null}function nn({label:n,description:e,value:a,setValue:t,disabled:i,inputContainer:o}){const{t:r}=H(),[f,b]=d.useState(!1),[S,h]=d.useState(!0),p=()=>r(S?"checkbox.indeterminate":f?"checkbox.true":"checkbox.false"),x=c=>{c.target.indeterminate=!1,t(c.target.checked)};d.useEffect(()=>{a===!0?(b(!0),h(!1)):a===!1?(b(!1),h(!1)):a===void 0&&(b(!1),h(!0))},[a]);const l=s.jsx(re,{description:p(),checked:f,indeterminate:S,type:"checkbox",onChange:c=>x(c),disabled:i});return s.jsx(ce.Wrapper,{label:n,description:e,children:o?o(l):l})}const tn=["Name","Description","ObjectType"],sn=(n,e,a)=>{if(e==="Attributes"&&!tn.includes(a))return!0;const t=`${e}/${a}`;return n[t]||n[a]||!1},an=(n,e,a,t)=>{const i=n.map(o=>{if(o.name===e){const r=o.hasProperties.map(f=>f.name===a?{...f,...t}:f);return r.some(f=>f.name===a)||r.push({name:a,...t}),{...o,hasProperties:r}}return o});return i.some(o=>o.name===e)||i.push({type:"IfcPropertySet",name:e,hasProperties:[{name:a,...t}]}),i};function on({propertySet:n,property:e,propertyNaturalLanguageName:a}){const t=F(),i=v(u=>u.ifcData.propertyIsInstanceMap),o=v(u=>u.ifcData.savedPropertyIsInstanceMap),r=v(Oe),f=n.name!=="Attributes",b=`${n.name}/${e.name}`,S=o.hasOwnProperty(b)||o.hasOwnProperty(e.name),h=sn(i,n.name||"",e.name),[p,x]=d.useState(""),l=a?.trim()?a:e.name,c=en(l,e.name);d.useEffect(()=>{if(e.type==="IfcPropertySingleValue"){const u=e.nominalValue?.type||"";x(u==="IfcBoolean"?e.nominalValue?.value??!1:e.nominalValue?.value??"")}else if(e.type==="IfcPropertyEnumeratedValue"){const u=e.enumerationValues?.[0];u&&u.type,x(u?.value??"")}},[e]);const g=u=>{if(x(u),r&&n.name){let j;"nominalValue"in e?j={nominalValue:{...e.nominalValue,value:u}}:"enumerationReference"in e?j={enumerationValues:(e.enumerationReference?.enumerationValues||[]).filter(T=>T.value===u)}:j={value:u};const m=an(r,n.name,e.name,j);t(ue(m)),n.name==="Attributes"&&(e.name==="ObjectType"?t(Me(u)):e.name==="Description"&&t(Pe(u)))}},C=u=>{g(u)},I=()=>{switch(e.type){case"IfcPropertySingleValue":return e.nominalValue?.type==="IfcBoolean"?s.jsx(nn,{label:l,description:c,disabled:h,value:p,setValue:m=>C(m)}):s.jsx(L,{label:l,description:c,placeholder:e.nominalValue?.value??"",value:p||"",disabled:h,onChange:m=>C(m.target.value),onBlur:m=>g(m.target.value)});case"IfcPropertyEnumeratedValue":const u=e.enumerationReference?.enumerationValues||[],j=u.length===1;return s.jsx(Ae,{label:l,description:c,value:p||"",disabled:h||j,clearable:!j,onChange:m=>C(m),data:u.map(m=>({value:m.value,label:m.value}))});default:return s.jsx(L,{placeholder:e.name,value:p||"",disabled:h,onChange:m=>C(m.target.value),onBlur:m=>g(m.target.value)})}},P=u=>f&&h?s.jsx(G,{label:q("bsddSearch.property.tooltipEditInstance"),withArrow:!0,children:u}):u;return s.jsxs(z,{children:[s.jsx("div",{style:{flex:1},children:P(I())}),f&&s.jsx(G,{label:q("bsddSearch.property.setAsInstanceCheckboxTooltip"),withArrow:!0,children:s.jsx(re,{style:{marginTop:"2rem"},disabled:S,checked:h,onChange:u=>{S||(g(void 0),t(Te({propertyName:b,value:u.currentTarget.checked})))}})})]})}const ln={Boolean:"IfcBoolean",Character:"IfcText",Integer:"IfcInteger",Real:"IfcReal",String:"IfcText",Time:"IfcDateTime"};function U(n,e){const a=n&&ln[n]||"default";let t;return n==="Boolean"&&typeof e=="string"?e.toUpperCase()==="TRUE"?t=!0:e.toUpperCase()==="FALSE"?t=!1:t=void 0:t=e,{type:a,value:t}}function W(n,e){return n&&n===e?.type?e:U(n,e?.value)}function pe(n,e,a){let t;if(n&&n.isDefinedBy){let i=n.isDefinedBy.find(o=>o.name===e);if(i&&(t=i.hasProperties.find(o=>o.name===a)),t)return t;if(i=n.isDefinedBy.find(o=>o.name===""),i)return i.hasProperties.find(o=>o.name===a)}return t}function rn(n,e){const a=e?.nominalValue?.value??null;return U(n,a)}function cn(n,e,a){if(e){if(e.type==="IfcPropertyEnumeratedValue"){const t=a.find(i=>e.enumerationValues?e.enumerationValues.some(o=>o.value===i.value):!1);return t?W(n,t):null}if("nominalValue"in e&&e.nominalValue){const t=a.find(i=>i.value===e.nominalValue?.value);return t?W(n,t):null}}return null}function un(n,e,a,t){const i=n.allowedValues?.map(b=>U(n.dataType,b.value))||[],o={type:"IfcPropertyEnumeratedValue",name:e,enumerationReference:{type:"IfcPropertyEnumeration",name:e,enumerationValues:i}};n.propertyUri&&(o.specification=n.propertyUri);let r=null,f=[];if(n.allowedValues?f=n.allowedValues:n.predefinedValue&&(f=[n.predefinedValue]),f.length===1)r=W(n.dataType,f[0]);else if(t){const b=pe(t,a,e);r=cn(n.dataType,b,i)}return r!==null&&(o.enumerationValues=[r]),o}function fn(n,e,a,t){const i={type:"IfcPropertySingleValue",name:e};n.propertyUri&&(i.specification=n.propertyUri);let o=null;if(n.predefinedValue)o=U(n.dataType,n.predefinedValue);else if(t){const r=pe(t,a,e);o=rn(n.dataType,r)}else o=U(n.dataType,null);return o!==null&&(i.nominalValue=o),i}function dn(n,e,a){const{propertyCode:t}=n,i=t||"unknown",o=n.allowedValues?un(n,i,e,a):fn(n,i,e,a);return o.specification=n.propertyUri||"",o}function hn({activeClassifications:n,recursiveMode:e}){const a=F(),t=v(fe),i=v(Re),o=v(de),r=v(ke),[f,b]=d.useState({}),[S,h]=d.useState([]);return d.useEffect(()=>{if(n.length===0)return;const p={};n.forEach(l=>{l.dictionaryUri!==r&&l.classProperties?.forEach(c=>{if(!c||!c.propertySet)return;const g=c.propertySet||l.name;p[g]||(p[g]={type:"IfcPropertySet",name:g,hasProperties:[]}),p[g].hasProperties.push(dn(c,g,t))})}),a(ue(Object.values(p))),h(Object.values(p))},[a,t,n,r]),d.useEffect(()=>{if(n.length===0)return;const p={};n.forEach(l=>{l.classProperties?.forEach(c=>{c&&c.propertyUri&&(o&&i&&i[o]&&i[o][c.propertyUri]?p[c.propertyUri]=i[o][c.propertyUri]||"":p[c.propertyUri]=c.name)})}),b(p)},[n,e,t,i,o]),s.jsx("div",{children:d.Children.toArray(S.map((p,x)=>s.jsx(M,{variant:"contained",radius:"xs",children:s.jsxs(M.Item,{value:p.name||"Unknown",style:x!==0?{borderTopWidth:0}:{},children:[s.jsx(M.Control,{children:p.name}),s.jsx(M.Panel,{children:s.jsx(Be,{children:d.Children.toArray(p.hasProperties.map(l=>{const c=l.specification?f[l.specification]:"";return s.jsx(on,{propertySet:p,property:l,propertyNaturalLanguageName:c})}))})})]},p.name||"Unknown")})))})}function pn({defaultSelection:n}){const e=F(),{t:a}=H(),t=v(he),i=v(Le),[o,r]=d.useState(n?.label||""),[f]=Ue(o,300),[b,S]=d.useState([]),[h,p]=d.useState(n||null),x=ne({onDropdownClose:()=>x.resetSelectedOption(),onDropdownOpen:()=>x.focusSearchInput()});return d.useEffect(()=>{n&&r(n.label)},[n,e]),d.useEffect(()=>{if(t){const l={SearchText:f,DictionaryUri:t.ifcClassification.location};e(He(l))}else e(Fe([]))},[e,f,t]),d.useEffect(()=>{if(i?.count&&i.dictionary?.classes){const l=i.dictionary.classes.filter(c=>c.uri&&c.name).map(c=>({value:c.uri,label:c.name}));if(S(l),l.length===1){const c=l[0];p(c),r(c.label),e(k(c.value))}}else S([])},[i,e]),d.useEffect(()=>{e(h?k(h.value):k(null))},[e,h]),s.jsxs(D,{store:x,withinPortal:!1,onOptionSubmit:l=>{const c=b.find(g=>g.value===l);c&&(p(c),r(c.label),x.closeDropdown())},children:[s.jsx(D.Target,{children:s.jsx(te,{label:`${a("searchMainDictionaryLabel")} ${t?t.ifcClassification.name:""}`,component:"button",type:"button",pointer:!0,style:{width:"100%"},rightSection:h!==null?s.jsx(se,{size:"sm",onMouseDown:l=>l.preventDefault(),onClick:l=>{l.stopPropagation(),p(null),r(""),e(k(null)),x.openDropdown()},"aria-label":"Clear selection"}):s.jsx(D.Chevron,{}),onClick:()=>x.toggleDropdown(),children:h?.label||s.jsx(ce.Placeholder,{children:a("searchMainDictionaryLabel")})})}),s.jsxs(D.Dropdown,{children:[s.jsx(D.Search,{value:o,onChange:l=>r(l.currentTarget.value),placeholder:a("searchMainDictionaryLabel")}),s.jsx(D.Options,{children:b.length>0?b.map(l=>s.jsx(D.Option,{value:l.value,children:l.label},l.value)):s.jsx(D.Empty,{children:a("noResults")})})]})]})}const N=60.7969;let Z=0,K=0;const mn=(n,e,a,t)=>{if(!n||!e)return;const i=e.ifcClassification.location;let o;return n.hasAssociations?.forEach(r=>{if(r.type==="IfcClassificationReference"){const f=r;f.referencedSource?.location===i&&(f.location&&t(k(f.location)),o={label:f.name,value:f.location})}}),!o&&a&&n[a]&&n[a]!==""&&n[a]!=="..."&&(o={label:n[a],value:n[a]}),o};function bn({searchKey:n="objectType"}){const{t:e}=H(),a=F(),{bsddSearchSave:t,bsddSearchCancel:i}=$e(),o=v(he),r=v(de),f=v(ze),b=v(fe),S=v(ie),h=v(oe),p=v(Ne),x=v(Ge),[l,c]=d.useState(),[g,C]=d.useState([]),[I,P]=d.useState(!1),[u,j]=d.useState(N),[m,y]=d.useState("auto"),[w,T]=d.useState(!1);d.useEffect(()=>{if(!h||!w)return;const O=h.classProperties||[];a(We({classProperties:O,languageCode:r}))},[h,w,r,a]),d.useEffect(()=>{const O=mn(b,o,n,a);c(O)},[o,b,a,n]),d.useEffect(()=>{const O=[h,p,...x].filter($=>$!==null);C(O)},[h,x,p]),d.useEffect(()=>{y(`${u*f.length+48}px`)},[f.length,u]);const A=O=>{const $=K+(O.clientY-Z)/f.length;j($>N?$:N)},E=()=>{document.removeEventListener("mousemove",A),document.removeEventListener("mouseup",E)},V=O=>{Z=O.clientY,K=u,document.addEventListener("mousemove",A),document.addEventListener("mouseup",E)},R=O=>{T(O.includes("Propertysets"))};return s.jsxs(le,{children:[s.jsx(L,{type:"hidden",name:"ifcType",id:"ifcType",value:""}),s.jsx(L,{type:"hidden",name:"name",id:"name",value:""}),s.jsx(L,{type:"hidden",name:"material",id:"material",value:""}),s.jsx(z,{mx:"md",mt:"lg",mb:"sm",children:s.jsx(pn,{defaultSelection:l})}),S?s.jsxs(s.Fragment,{children:[s.jsxs(M,{defaultValue:["Classifications"],multiple:!0,onChange:R,children:[s.jsxs(M.Item,{value:"Classifications",children:[s.jsx(M.Control,{children:s.jsx(X,{order:5,children:e("classificationsLabel")})}),s.jsx(M.Panel,{style:{height:m},children:s.jsx(Ke,{height:u,handleMouseDown:V})})]},"Classifications"),s.jsxs(M.Item,{value:"Propertysets",children:[s.jsx(M.Control,{children:s.jsx(X,{order:5,children:e("propertysetsLabel")})}),s.jsx(M.Panel,{children:s.jsx(hn,{activeClassifications:g,recursiveMode:I})})]},"Propertysets")]}),s.jsxs(z,{my:"sm",justify:"center",children:[s.jsx(Xe,{bsddSearchSave:t}),s.jsx(_,{fullWidth:!0,variant:"light",color:"gray",onClick:i,children:e("cancel")})]})]}):s.jsxs(_e,{mx:"md",title:e("noClassificationSelected"),mt:"xl",children:[e("classSearchInstruction"),s.jsx(Ye,{h:"md"}),e("needHelp")," ",s.jsx("a",{href:"https://github.com/buildingsmart-community/bSDD-Revit-plugin/wiki",target:"_blank",rel:"noreferrer",children:e("checkDocumentation")})]})]})}export{bn as B};
